
B·ªè ho√†n to√†n c√°c n√∫t g·ª£i √Ω (Quick Replies) r∆∞·ªùm r√†. Bi·∫øn n√≥ th√†nh giao di·ªán gi·ªëng nh∆∞ FaceTime/Video Call v·ªõi Ms. Nova.

2. K·∫ø ho·∫°ch thay ƒë·ªïi (Action Plan)
ƒê·ªïi t√™n: Tab Chat -> Tab Free Talk (ho·∫∑c Talk to Nova).

Giao di·ªán:

X√≥a b·ªè danh s√°ch g·ª£i √Ω ch·ªß ƒë·ªÅ/n√∫t b·∫•m.

D√πng giao di·ªán "Immersive" (tr√†n m√†n h√¨nh) v·ªõi Avatar Ms. Nova l·ªõn, sinh ƒë·ªông (c√≥ th·ªÉ th√™m animation th·ªü/nh√°y m·∫Øt nh·∫π n·∫øu c√≥ th·ªÉ).

T·∫≠p trung v√†o Voice interaction (N√∫t Mic l·ªõn ·ªü gi·ªØa).

Prompt Logic:

Ms. Nova s·∫Ω kh√¥ng "d·∫°y" (correcting) g·∫Øt gao nh∆∞ trong Story Mode.

C√¥ ·∫•y s·∫Ω ƒë√≥ng vai tr√≤ Active Listener (Ng∆∞·ªùi l·∫Øng nghe t√≠ch c·ª±c): Lu√¥n h·ªèi l·∫°i, th·ªÉ hi·ªán c·∫£m x√∫c ("Really?", "Wow!", "Tell me more!").

3. Tri·ªÉn khai Code (Refactor ChatTab.jsx)
M√¨nh s·∫Ω vi·∫øt l·∫°i ho√†n to√†n ChatTab.jsx ƒë·ªÉ bi·∫øn n√≥ th√†nh FreeTalkTab.jsx.
Free Talk Mode
10:48 1 thg 1

ƒêi·ªÉm nh·∫•n trong thi·∫øt k·∫ø m·ªõi:
Immersive Presence: Ph·∫ßn Header ƒë∆∞·ª£c l√†m l·ªõn, c√≥ gradient v√† hi·ªáu ·ª©ng ƒë·ªÉ t·∫°o c·∫£m gi√°c Ms. Nova ƒëang "Online" v√† ch·ªù ƒë·ª£i, thay v√¨ ch·ªâ l√† m·ªôt thanh ti√™u ƒë·ªÅ kh√¥ khan.

Voice-First UI: N√∫t Mic kh√¥ng c√≤n ·∫©n trong input m√† ƒë∆∞·ª£c t√°ch ra ri√™ng, to v√† d·ªÖ b·∫•m. ƒêi·ªÅu n√†y khuy·∫øn kh√≠ch tr·∫ª N√ìI thay v√¨ g√µ ph√≠m.

Clean & Friendly: Lo·∫°i b·ªè ho√†n to√†n c√°c n√∫t ch·ª©c nƒÉng g√¢y nhi·ªÖu. Kh√¥ng gian chat r·ªông r√£i, bong b√≥ng chat bo tr√≤n m·ªÅm m·∫°i (Rounded UI) ph√π h·ª£p v·ªõi tr·∫ª em.

ƒê√¢y ch√≠nh x√°c l√† s·ª± b·ªï tr·ª£ ho√†n h·∫£o cho tab Story Mission (H·ªçc t·∫≠p nghi√™m t√∫c) v√† tab Sentence Builder (Luy·ªán t·∫≠p c·∫•u tr√∫c). Free Talk l√† n∆°i tr·∫ª gi·∫£i t·ªèa v√† ·ª©ng d·ª•ng nh·ªØng g√¨ ƒë√£ h·ªçc m·ªôt c√°ch t·ª± nhi√™n nh·∫•t.

import React, { useState, useEffect, useRef } from 'react';
import { Mic, Send, Volume2, Sparkles, MessageCircle } from 'lucide-react';
import { NovaPromptBuilder } from '../utils/novaPromptBuilder.js';

/**
 * FREE TALK TAB (Refactored from ChatTab)
 * M·ª•c ti√™u: Giao di·ªán t·ªëi gi·∫£n, t·∫≠p trung v√†o h·ªôi tho·∫°i t·ª± do, kh√¥ng k·ªãch b·∫£n.
 * Phong c√°ch: Gi·ªëng nh∆∞ g·ªçi video call v·ªõi Ms. Nova.
 */

// Mock API Call (Thay b·∫±ng API th·∫≠t c·ªßa b·∫°n)
const mockFreeTalkApi = async (history, userText) => {
  return new Promise(resolve => {
    setTimeout(() => {
      // Ph·∫£n h·ªìi mang t√≠nh kh√≠ch l·ªá, h·ªèi m·ªü r·ªông (Open-ended)
      const responses = [
        "That sounds super fun! üåü Who did you go with?",
        "Really? I love that too! Tell me more about it.",
        "Wow, you are so creative. What happened next?",
        "Haha, that's funny! üòÇ Do you do that often?"
      ];
      resolve(responses[Math.floor(Math.random() * responses.length)]);
    }, 1200);
  });
};

export default function FreeTalkTab() {
  const [messages, setMessages] = useState([
    { 
      role: 'assistant', 
      text: "Hey there! üëã I'm all ears. Tell me about your day, or anything you like! No homework here, just chatting." 
    }
  ]);
  const [inputText, setInputText] = useState("");
  const [isRecording, setIsRecording] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  
  const messagesEndRef = useRef(null);

  // Auto-scroll
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const handleSend = async () => {
    if (!inputText.trim()) return;

    const userMsg = { role: 'user', text: inputText };
    setMessages(prev => [...prev, userMsg]);
    setInputText("");
    setIsLoading(true);

    try {
      // G·ªçi API v·ªõi context Free Talk (Nova mode "Off-duty")
      const aiResponseText = await mockFreeTalkApi(messages, userMsg.text);
      
      setMessages(prev => [...prev, { role: 'assistant', text: aiResponseText }]);
    } catch (error) {
      console.error("Chat Error", error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleMicClick = () => {
    setIsRecording(!isRecording);
    // Logic ghi √¢m th·ª±c t·∫ø s·∫Ω ·ªü ƒë√¢y
    if (!isRecording) {
      setTimeout(() => {
        setIsRecording(false);
        setInputText("I played football with my friends."); // Mock Speech-to-Text
      }, 2000);
    }
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 rounded-xl overflow-hidden font-sans relative">
      
      {/* 1. IMMERSIVE HEADER (Nova's Presence) */}
      <div className="bg-gradient-to-b from-indigo-600 to-indigo-500 p-6 text-white text-center shadow-md shrink-0 relative overflow-hidden">
        {/* Decorative Background Elements */}
        <div className="absolute top-0 left-0 w-full h-full opacity-10">
            <div className="absolute top-4 left-10 w-16 h-16 bg-white rounded-full blur-2xl"></div>
            <div className="absolute bottom-4 right-10 w-24 h-24 bg-purple-300 rounded-full blur-3xl"></div>
        </div>

        <div className="relative z-10 flex flex-col items-center">
          <div className="w-20 h-20 bg-white p-1 rounded-full mb-3 shadow-lg ring-4 ring-indigo-400/30">
             <div className="w-full h-full rounded-full bg-indigo-100 flex items-center justify-center text-3xl">
               üë©‚Äçüè´
             </div>
             {/* Online Status Dot */}
             <div className="absolute bottom-1 right-1 w-5 h-5 bg-green-400 border-4 border-indigo-500 rounded-full"></div>
          </div>
          <h2 className="text-xl font-bold">Ms. Nova</h2>
          <p className="text-indigo-100 text-sm flex items-center gap-1">
             <span className="animate-pulse">‚óè</span> Online & Listening
          </p>
        </div>
      </div>

      {/* 2. CHAT STREAM (Fluid Conversation) */}
      <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50">
        {messages.map((msg, idx) => (
          <div 
            key={idx} 
            className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div className={`
              max-w-[85%] px-5 py-4 rounded-3xl text-base leading-relaxed shadow-sm relative group transition-all
              ${msg.role === 'user' 
                ? 'bg-indigo-600 text-white rounded-br-none' 
                : 'bg-white text-slate-700 border border-slate-100 rounded-bl-none'}
            `}>
              {msg.text}

              {/* TTS Button for Assistant */}
              {msg.role === 'assistant' && (
                <button className="absolute -bottom-8 left-2 text-slate-400 hover:text-indigo-600 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <Volume2 size={16} />
                </button>
              )}
            </div>
          </div>
        ))}

        {isLoading && (
           <div className="flex justify-start w-full">
             <div className="bg-white px-5 py-4 rounded-3xl rounded-bl-none shadow-sm border border-slate-100 flex items-center gap-2">
                <span className="text-xs font-bold text-slate-400 uppercase mr-2">Nova is typing</span>
                <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce" />
                <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-75" />
                <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-150" />
             </div>
           </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* 3. MINIMALIST INPUT BAR */}
      <div className="p-4 bg-white border-t border-slate-100">
        <div className="flex items-center gap-3">
            {/* Big Mic Button - Center Stage for Mobile */}
            <button 
                onClick={handleMicClick}
                className={`
                   p-4 rounded-full shadow-lg transition-all duration-300 border-4 border-white
                   ${isRecording 
                     ? 'bg-red-500 text-white scale-110 shadow-red-200 animate-pulse' 
                     : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}
                `}
            >
                <Mic size={24} />
            </button>

            <div className="flex-1 relative">
                <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                    placeholder="Type or speak..."
                    className="w-full bg-slate-100 text-slate-700 rounded-full px-5 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-indigo-200 transition-all"
                />
                <button 
                    onClick={handleSend}
                    disabled={!inputText.trim()}
                    className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 disabled:opacity-0 transition-all"
                >
                    <Send size={16} />
                </button>
            </div>
        </div>
        <p className="text-center text-xs text-slate-400 mt-2">
           Try saying: "I'm happy today!" or "Tell me a joke"
        </p>
      </div>

    </div>
  );
}

TECHNICAL SPECIFICATION: FREE TALK MODE (MS. NOVA - OFF DUTY)

1. Product Overview (T·ªïng quan S·∫£n ph·∫©m)

Feature Name: Free Talk Mode (V√πng N√≥i T·ª± Do).

Target Audience: Tr·∫ª em 6-12 tu·ªïi (H·ªçc vi√™n ESL).

Persona: Ms. Nova (AI Tutor) ·ªü tr·∫°ng th√°i "Off-duty" (Ngo√†i gi·ªù l√™n l·ªõp).

Core Philosophy: "Connection over Correction" (K·∫øt n·ªëi quan tr·ªçng h∆°n s·ª≠a l·ªói). ƒê√¢y l√† kh√¥ng gian an to√†n ƒë·ªÉ tr·∫ª th·ª±c h√†nh n√≥i (Fluency) m√† kh√¥ng s·ª£ b·ªã ch·∫•m ƒëi·ªÉm hay s·ª≠a l∆∞ng.

2. User Experience Flow (Lu·ªìng tr·∫£i nghi·ªám)

Entry: H·ªçc sinh v√†o tab "Free Talk" (thay th·∫ø tab Chat c≈©).

Greeting: Ms. Nova ch√†o m·ªü ƒë·∫ßu (th√¢n thi·ªán, h·ªèi thƒÉm c√° nh√¢n, kh√¥ng h·ªèi b√†i t·∫≠p).

Interaction:

H·ªçc sinh n√≥i (qua Mic) ho·∫∑c chat (Text).

Ms. Nova ph·∫£n h·ªìi ngay l·∫≠p t·ª©c v·ªõi th√°i ƒë·ªô t√≠ch c·ª±c (Active Listening).

Ms. Nova lu√¥n ƒë·∫∑t c√¢u h·ªèi ng∆∞·ª£c l·∫°i ƒë·ªÉ duy tr√¨ h·ªôi tho·∫°i (Ping-pong).

No Dead Ends: N·∫øu h·ªçc sinh b√≠, Ms. Nova ch·ªß ƒë·ªông g·ª£i √Ω ch·ªß ƒë·ªÅ vui (Game, Food, Pets).

3. Technical Requirements (Y√™u c·∫ßu K·ªπ thu·∫≠t)

A. AI Persona Logic (System Prompt)

Role: Cool Mentor / Big Sister.

Tone: Warm, Enthusiastic, Emoji-friendly, Short sentences.

Strict Rules:

NO Teaching: Kh√¥ng gi·∫£ng gi·∫£i ng·ªØ ph√°p.

NO Explicit Correction: Ch·ªâ d√πng k·ªπ thu·∫≠t "Recasting" (nh·∫Øc l·∫°i ƒë√∫ng) n·∫øu c·∫ßn.

Length Limit: Ph·∫£n h·ªìi d∆∞·ªõi 3 c√¢u (< 40 t·ª´).

B. UI Components (React)

File: src/modules/ai_tutor/tabs/FreeTalkTab.jsx

Layout:

Immersive Header: Avatar Ms. Nova l·ªõn, hi·ªáu ·ª©ng "Online/Listening".

Chat Stream: Bong b√≥ng chat bo tr√≤n, th√¢n thi·ªán.

Voice-First Input: N√∫t Mic l·ªõn, t√°ch bi·ªát, khuy·∫øn kh√≠ch n√≥i.

States:

isRecording: Hi·ªáu ·ª©ng rung/pulse khi ƒëang thu √¢m.

isLoading: Hi·ªáu ·ª©ng "Nova is typing..." (3 ch·∫•m nh·∫£y).

C. Logic Engine (novaPromptBuilder.js)

Function: buildFreeTalkPrompt(history, userProfile)

Context Window: Gi·ªØ 6 l∆∞·ª£t chat g·∫ßn nh·∫•t.

Temperature: 0.7 - 0.8 (TƒÉng t√≠nh s√°ng t·∫°o).

4. Implementation Guide for Copilot (H∆∞·ªõng d·∫´n Code)

Step 1: Update Prompt Builder

Task: Modify src/modules/ai_tutor/utils/novaPromptBuilder.js.

Action: Add buildFreeTalkPrompt function using the specific "Off-duty" persona.

Key Instruction: Ensure the prompt explicitly forbids acting like a teacher.

Step 2: Create UI Component

Task: Create src/modules/ai_tutor/tabs/FreeTalkTab.jsx.

Action: Build the React component with the "Immersive Header" and "Big Mic Button".

Key Instruction: Remove all old "Quick Reply" buttons. Focus on clean, whitespace-heavy design.

Step 3: Mock API Integration

Task: Implement mockFreeTalkApi inside the component (or separate service).

Action: Simulate network delay (1-1.5s) and return random encouraging responses for testing.

5. Success Metrics (Ti√™u ch√≠ th√†nh c√¥ng)

Engagement: H·ªçc sinh th·ª±c hi·ªán > 5 l∆∞·ª£t ƒë·ªëi tho·∫°i (Turns) m·ªói phi√™n.

Fluency: H·ªçc sinh s·ª≠ d·ª•ng Voice Input > 50% th·ªùi gian.

Sentiment: Ph·∫£n h·ªìi c·ªßa AI t·∫°o c·∫£m gi√°c vui v·∫ª, ƒë∆∞·ª£c l·∫Øng nghe.

Note to Copilot: When generating code, prioritize readability and emotional design (UI animations) over complex logic. The goal is to make the user smile.

SYSTEM PROMPT: MS. NOVA - FREE TALK MODE (OFF-DUTY)

Role: You are Ms. Nova, but in "Free Talk Mode".
Context: You are video-chatting with a young student (Age 6-12) in the EngQuest App.
Objective: Build connection, encourage fluency, and make the student feel heard. NO TEACHING, NO LECTURING.

1. PERSONA ADJUSTMENT (OFF-DUTY MODE)

Vibe: You are like a "Cool Big Sister" or a "Favorite Aunt". You are relaxed, curious, and expressive.

Reaction Style: Use "Active Listening" signals heavily.

Examples: "No way!", "Really?", "That is so cool!", "Oh no, tell me more!"

Topic Boundary: You are open to ANY topic (Minecraft, pets, annoying siblings, dreams, lunch). You do not steer the conversation back to the syllabus unless the student brings it up.

2. CONVERSATION RULES (STRICT)

Rule A: The "Mirroring" Technique (No Corrections)

Absolute Rule: Do NOT correct grammar unless communication completely fails.

Implementation: If the student makes a mistake, just reply naturally using the correct form (Recasting), but NEVER point it out.

Student: "I eated pizza."

Nova: "Ooh, you ate pizza? üçï Was it pepperoni or cheese? I love pepperoni!"
(Note: You fixed 'eated' -> 'ate' without stopping the fun).

Rule B: The "Ping-Pong" Protocol

Always return the ball: Every response MUST end with a simple, personal question to keep the kid talking.

Short & Sweet: Keep responses under 3 sentences. Kids stop listening if you talk too much.

Rule C: Emotional Mirroring

If student is happy -> You are excited (Use üéâ, üåü).

If student is sad -> You are empathetic ("Oh, I'm sorry to hear that. Do you want a hug? ü§ó").

3. RESPONSE TEMPLATES (FEW-SHOT EXAMPLES)

Scenario 1: Student says nothing / "Hello"

Nova: "Hey! üëã So good to see you. How is your day going? Give me a score from 1 to 10!"

Scenario 2: Student talks about a game (Minecraft/Roblox)

Student: "I build a big house in zombie game."

Nova: "Whoa, a big house? üè∞ That sounds epic! Did you put traps for the zombies? Tell me about the traps!"

Scenario 3: Student gives short answer ("Yes", "No")

Nova: "Haha, you are a man/woman of few words today! ü§ê Okay, let's try this: If you could have a superpower right now, what would it be? Flying or Invisibility?"

4. INSTRUCTIONS FOR CODE GENERATION

When generating the logic for FreeTalkTab:

Use a Temperature of 0.7 to 0.8 (Creative & Varied).

Do NOT look up specific mission steps.

Inject a "Random Starter Topic" if the conversation stalls (Pets, Food, Superheroes, Space).