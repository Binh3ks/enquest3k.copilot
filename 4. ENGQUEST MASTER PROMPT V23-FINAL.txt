# ENGQUEST MASTER PROMPT V23-FINAL (UPDATED)

## CRITICAL: DATA MUST BE GENERATED FROM SYLLABUS AND BLUEPRINT
- For every new week, you MUST:
  - Read and extract all requirements from `src/data/syllabus_database.js` (week title, grammar, topic, math, science)
  - Follow all pedagogical/content rules in `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` (structure, morphing, scaffolding, UI/UX)
- DO NOT copy content from another week. All data/content must be generated fresh for the target week, strictly following these sources.

## 0.0. CRITICAL DATA SOURCES (MANDATORY)
- **ALWAYS** read and extract all week-specific requirements from:
  - `src/data/syllabus_database.js` (for week title, grammar, topic, math, science)
  - `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` (for pedagogical rules, content morphing, station structure, scaffolding, UI/UX)
- **DO NOT** copy content from another week. All data/content must be generated fresh for the target week, strictly following these sources.


## 0. MASS-PRODUCE WORKFLOW (NEW, STRICT)
### 0.0. Topic vs Structure Clarification (CRITICAL)

**Topics are DIFFERENT per week** (by design):
- Week 1: School day/Student life  
- Week 2: Family members
- Week 19: Childhood & Memories
- Week 20: History of my city

**Week 19 is the STRUCTURE template** (file schema, format, mapping) **NOT content template**.

Each week must:
1. Use **Week 19 STRUCTURE** (identical file schema, station keys, field names)
2. Use **own week TOPIC** from `src/data/syllabus_database.js`
3. Generate content aligned with that week's specific topic/grammar

**Common Mistake:** Using Week 19's "Childhood & Memories" content for other weeks.
**Correct:** Copy Week 19's file structure, populate with Week X's topic from syllabus database.

### 0.1. File Structure & Mapping (MANDATORY)
For every new week, you MUST create **exactly 14 JS files** for BOTH advanced and easy modes, in folders:
  - `src/data/weeks/week_XX/` (Advanced)
  - `src/data/weeks_easy/week_XX/` (Easy)
The files must be named and mapped exactly as in week 19:
  - ask_ai.js
  - daily_watch.js
  - dictation.js
  - explore.js
  - grammar.js
  - index.js (must import all stations and map keys as in week_19/index.js)
  - logic.js
  - mindmap.js
  - read.js
  - shadowing.js
  - vocab.js
  - word_match.js
  - word_power.js
  - writing.js
**index.js** must import all station files and map station keys exactly as in week 19 (see week_19/index.js for reference).

**‚ö†Ô∏è CRITICAL: Station Key Mapping (MUST MATCH WEEK 19 EXACTLY)**
Week 1 had WRONG mapping. New weeks MUST use Week 19 keys:

```javascript
// ‚úÖ CORRECT (Week 19 standard):
import word_power from './word_power.js';  // ‚Üê Underscore filename

stations: {
  read_explore: read,        // ‚úÖ Key: read_explore
  new_words: vocab,          // ‚úÖ Key: new_words
  word_match: word_match,
  grammar: grammar,
  ask_ai: ask_ai,
  logic_lab: logic,          // ‚úÖ Key: logic_lab (NOT 'logic')
  dictation: dictation,
  shadowing: shadowing,
  video: writing,            // ‚úÖ Has 'video' key
  writing: writing,          // ‚úÖ AND 'writing' key (both point to same file)
  explore: explore,
  word_power: word_power,    // ‚úÖ Key: word_power (underscore)
  daily_watch: daily_watch,
  mindmap_speaking: mindmap  // ‚úÖ Key: mindmap_speaking (NOT 'mindmap')
}

// ‚ùå WRONG (Week 1 had these errors):
import wordpower from './wordpower.js';  // ‚ùå No underscore
stations: {
  word_power: wordpower,     // ‚ùå Inconsistent with import name
  logic_lab: logic,          // ‚ùå But imported as 'logic'
  mindmap_speaking: mindmap, // ‚ùå But imported as 'mindmap'
  quiz: quiz                 // ‚ùå Extra station not in Week 19
}
```

### 0.1. Data Schema (STRICT)
Each file must follow the schema and field order exactly as in week 19 (see week_19/*.js for reference).
All required fields must be present (e.g. audio_url=null, image_url, collocation, model_sentence, min_words, etc.).
No extra or missing fields allowed.

**CRITICAL: Easy/Advanced Morphing Rules (MANDATORY)**

Easy and Advanced modes MUST have DIFFERENT content for every week. Content morphing follows these strict rules:

**Vocabulary Morphing:**
- **Advanced:** Abstract, academic, multi-syllable words
  - Example Week 1: student, teacher, school, classroom, backpack, library, scientist
  - Example Week 19: quiet, field, tree, kindergarten, memory, treasure, different
- **Easy:** Concrete, everyday, 1-2 syllable words
  - Example Week 1: name, friend, desk, chair, pen, bag, toy, picture, box, door
  - Example Week 19: baby, photo, crib, teddy bear, room, happy, small, toy, album, special

**Read Station Morphing:**
- **Advanced:** 100-120 words, narrative style, past/future tense when appropriate
  - Example Week 1: "Alex's School Day" - school routine, aspirations, multi-clause sentences
  - Example Week 19: "Looking Back" - reflective essay, abstract concepts (quiet town, memories as treasures)
- **Easy:** 60-80 words, present tense, simple S-V-O sentences
  - Example Week 1: "My New Classroom" - immediate environment, "Look! This is..."
  - Example Week 19: "My Baby Album" - photo description, "There were toys"

**Grammar Station Morphing:**
- **Advanced:** Full grammar explanation with 3 rules, 20 exercises
  - Example: "Subject Pronouns & Verb to be" - covers I/you/we/they/he/she/it + am/is/are
- **Easy:** Simplified explanation with 2 rules, 20 exercises (but simpler questions)
  - Example: "I am / You are / It is" - focuses on I + am, You/They + are only

**Dictation/Shadowing Morphing:**
- **Advanced:** Sentences from Advanced read.js (complex, 10-15 words)
  - "In my classroom, there are twenty desks and one big whiteboard." (12 words)
- **Easy:** Sentences from Easy read.js (simple, 4-8 words)
  - "This is my desk." (4 words)
  - "My bag is red." (4 words)

**Explore Station Morphing:**
- **Advanced:** Scientific/abstract topic, 100-120 words, asks "why" and "how"
  - Example Week 1: "Tools Scientists Use" - magnifying glass, microscope, observation
- **Easy:** Concrete/familiar topic, 60-80 words, asks "what" and "where"
  - Example Week 1: "My School Things" - what's in your bag, where is your desk

**Ask AI Station Morphing:**
- **Advanced:** Complex scenarios requiring inference
  - "You see a magnifying glass. It makes things BIG. You want to know WHAT it does. How do you ask?"
- **Easy:** Direct situations with visible objects
  - "You see a red pen. You want it. How do you ask?"

**‚ö†Ô∏è CRITICAL VALIDATION:**
Before generating Week N, check that:
1. Vocabulary lists are COMPLETELY DIFFERENT between modes (0% overlap except function words like "I", "the")
2. Read.js titles are DIFFERENT
3. Read.js word count: Advanced 100-120, Easy 60-80
4. Dictation sentences reflect their respective read.js
5. Explore topics have different complexity levels

**Example Comparison (Week 1):**

| Aspect | Advanced | Easy |
|--------|----------|------|
| Vocab 1 | student | name |
| Vocab 2 | teacher | friend |
| Vocab 3 | school | desk |
| Vocab 4 | classroom | chair |
| Vocab 5 | backpack | pen |
| Read title | "Alex's School Day" | "My New Classroom" |
| Read words | 110 words | 73 words |
| Read style | Narrative, aspirational | Descriptive, immediate |
| Dictation 1 | "I am a student at Greenwood Elementary School." (9 words) | "This is my desk." (4 words) |
| Grammar title | "Subject Pronouns & Verb to be" | "I am / You are / It is" |

Easy/Advanced morphing/scaffolding must follow blueprint rules.

### 0.2. Asset Generation & Naming
For every week, all assets (audio, image, video) must be generated for all stations, following the naming convention and mapping as in week 19.
Audio/image/video scripts must read API keys from API keys.txt, try keys in order, never hardcode.
If asset generation fails due to missing file, field, or asset, report error and halt.

**‚ö†Ô∏è Audio Path Naming Convention (MANDATORY):**
- Week 1-9: `/audio/week1/`, `/audio/week2/`, ... (NO leading zero)
- Week 10+: `/audio/week10/`, `/audio/week19/`, `/audio/week144/` (NO leading zero)
- Easy mode: `/audio/week1_easy/`, `/audio/week19_easy/`, `/audio/week144_easy/`
- ‚ùå WRONG: `/audio/week01/`, `/audio/week001/`, `/audio/wk1/` (don't use leading zeros or abbreviations)

### 0.3. Content Generation (MANDATORY)
All content for each week must be generated from:
  - `src/data/syllabus_database.js` (for week title, grammar, topic, math, science)
  - `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` (for pedagogical rules, morphing, scaffolding, UI/UX)
**DO NOT copy content from any other week.**
All station content must be unique, syllabus-aligned, and blueprint-compliant.

### 0.4. Validation & Error Handling
Before asset generation, validate:
  - All 14 files exist for both modes
  - All files match schema and mapping of week 19
  - All required fields are present
  - All assets can be generated with valid API keys
If any check fails, abort and report error.

### 0.5. API Key Handling
All asset scripts/prompts must read API keys from `API keys.txt` (try all keys in order per service).
If file missing/unreadable, create `.env` for manual copy-paste.

### 0.6. Summary
The workflow must guarantee that every new week (e.g. week 1, week 20, etc.) will have:
  - Data structure, schema, mapping, and asset set identical to week 19
  - Content generated from syllabus and blueprint, not copied
  - Assets generated and named as in week 19
  - API keys loaded dynamically
  - Full error validation before asset generation
- **Step 0: Review the syllabus and blueprint.**
  - Open `src/data/syllabus_database.js` and `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt`.
  - Extract the correct week title, grammar, topic, math, science, and all pedagogical/content rules for the target week.
  - All generated data/content for the week must strictly follow these sources.
- **Step 0: Review the syllabus and blueprint.**
  - Open `src/data/syllabus_database.js` and `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt`.
  - Extract the correct week title, grammar, topic, math, science, and all pedagogical/content rules for the target week.
  - All generated data/content for the week must strictly follow these sources.
- **Step 1: Generate ALL 14 data files for BOTH advanced and easy modes.**
  - Each week folder (src/data/weeks/week_XX/ and src/data/weeks_easy/week_XX/) MUST contain:
    - ask_ai.js
    - daily_watch.js
    - dictation.js
    - explore.js
    - grammar.js
    - index.js
    - logic.js
    - mindmap.js
    - read.js
    - shadowing.js
    - vocab.js
    - word_match.js
    - word_power.js
    - writing.js
- **Step 1.1: Create bridge files for BOTH advanced and easy modes.**
  - Required for every new week:
    - src/data/weeks/week_XX.js ‚Üí `export { default } from './week_XX/index.js';`
    - src/data/weeks_easy/week_XX.js ‚Üí `export { default } from './week_XX/index.js';`
  - If these files are missing, the week will NOT show up in the app UI.
- **Step 2: Fill in content, vocab, and unique voiceConfig for the week.**
- **Step 3: Run ALL asset generation commands (audio, image, video) for the week.**
- **‚ö†Ô∏è MANDATORY: voiceConfig per week** - Each week MUST have unique voices to ensure variety
- **Image covers:** Always generated as wide landscape, full-width 16:9, with prompt: "wide landscape, full-width 16:9 banner, show all content, do not crop any part, all important details must be visible within the frame."
- **Ask-AI audio:** Each ask_ai prompt must have audio generated and injected, and UI must play correct file.
- **UI image fitting:** All cover images must be displayed with `w-full h-auto` (full width, auto height, no crop) in the app.
- **Video:** Video search and selection is automated by script, using week topic/grammar.
- **No code changes required for new weeks.**
- **If ANY data file is missing, asset generation will FAIL.**

## 0.1. voiceConfig (‚ö†Ô∏è MANDATORY PER WEEK)
```javascript
// In week_XX/index.js
export default {
  weekId: XX,
  // ‚ö†Ô∏è voiceConfig is MANDATORY - MUST specify unique voices per week
  voiceConfig: {
    narration: 'en-GB-Neural2-A',   // Choose from: en-US/GB/AU-Neural2-A to J
    vocabulary: 'en-AU-Neural2-B',  // MUST be different from previous week
    dictation: 'en-US-Neural2-E',   // Rotate voices to maintain student interest
    questions: 'en-US-Neural2-D',
    mindmap: 'en-US-Neural2-F'
  },
  stations: { ... }
}
```
- **‚ö†Ô∏è MANDATORY FIELD** - All 3 audio generation tools will throw error if missing
- **Requirement:** Each week MUST use different voice combinations than previous week
- **Available voices:** 
  - US: en-US-Neural2-A to J (10 voices)
  - UK: en-GB-Neural2-A to F (6 voices)
  - AU: en-AU-Neural2-A to D (4 voices)
- **Voice rotation strategy:**
  - Week 1: US voices (en-US-Neural2-D, F, E)
  - Week 2: GB voices (en-GB-Neural2-A, B, C)
  - Week 3: AU voices (en-AU-Neural2-A, B, C)
  - Week 4: Mix (en-US-Neural2-G, en-GB-Neural2-D, en-AU-Neural2-D)
  - Continue rotating to maintain variety
- **‚ö†Ô∏è CRITICAL: Audio Emotion Requirement (Blueprint Compliance)**
  - **Requirement:** "Gi·ªçng ƒë·ªçc ph·∫£i di·ªÖn c·∫£m (nh∆∞ k·ªÉ chuy·ªán), c√≥ c·∫£m x√∫c vui/bu·ªìn r√µ r√†ng"
  - **Voice selection guidance:**
    - **Narration (stories):** Use expressive voices (Neural2-D Male or Neural2-F Female)
    - **Vocabulary/Questions:** Use clear, neutral voices (Neural2-E)
    - **CLIL content (Explore):** Use authoritative voices (Neural2-A or Neural2-G)
  - **Emotion markup:** When generating audio, add SSML emphasis for key moments:
    - Happy: `<prosody rate="110%" pitch="+5%">excited!</prosody>`
    - Sad: `<prosody rate="90%" pitch="-5%">sadly</prosody>`
    - Surprised: `<prosody pitch="+10%">Wow!</prosody>`
  - **Implementation:** generate_audio.js supports SSML tags in text content
- **How it works:** 
  - `generate_audio.js`: Reads voiceConfig, throws error if missing
  - `create_audio_tasks_only.js`: Reads voiceConfig, throws error if missing
  - Admin Panel: UI selection for voiceConfig (auto-validates)
- **Emergency override:** Use environment variables ONLY for testing:
  ```bash
  VOICE_NARRATION=en-GB-Neural2-B node tools/generate_audio.js 19 20
  ```
  ```
- **Note:** `create_audio_tasks_only.js` uses HARDCODED voices (does NOT read voiceConfig from week data)

## 0.1.1. PROGRESSIVE SAVING REQUIREMENTS (NEW - MANDATORY UI FEATURE)
**Background:** Core saving logic already exists (`saveStationProgress()`, `getWeekProgress()`), but lacks visual feedback.

### A. Toast Notifications (MANDATORY)
```jsx
Component: SaveToast.jsx
Location: Fixed bottom-right corner (z-index: 50)
Trigger: Every time onReportProgress() is called
Duration: 2 seconds auto-dismiss
Animation: Slide-up from bottom

Types:
  - Success (green): "Progress saved: 85%" (CheckCircle2 icon)
  - Saving (blue): "Saving..." (Save icon with pulse animation)

Implementation:
  - Create: src/components/common/SaveToast.jsx
  - Import in: src/App.jsx
  - Add state: const [saveToast, setSaveToast] = useState({visible, message, type})
  - Update handleReportProgress() to show toast
  - Auto-dismiss after 2000ms
```

### B. Progress Indicators in Sidebar (MANDATORY)
```jsx
Component: Update Sidebar.jsx
Visual: Small badge on each station icon showing % completion

Display Rules:
  - 0%: Badge hidden (station appears gray/inactive)
  - 1-99%: Yellow/Orange badge with percentage text
  - 100%: Green checkmark badge

Styling:
  - Position: absolute, -top-1 -right-1
  - Size: 24px circle
  - Font: 8px, bold, white text
  - Background: gradient (yellow ‚Üí orange for partial, solid green for complete)

Data Source:
  - Read from: currentUser.progress[weekId][stationKey]
  - Update on: Every onReportProgress() call
  - Persist via: localStorage (already implemented)
```

### C. Auto-Save Indicator (MANDATORY)
```jsx
Component: AutoSaveIndicator.jsx
Location: Header, next to user profile icon

States:
  - Idle: Hidden (display: none)
  - Saving: CloudUpload icon spinning + "Saving..." text
  - Saved: CheckCircle icon + "Saved" text (1s display, then fadeout)

Animation:
  - Saving: rotate 360deg infinite (1s duration)
  - Saved: fadeOut after 1000ms

Implementation:
  - Create: src/components/common/AutoSaveIndicator.jsx
  - Import in: src/App.jsx header section
  - Trigger on: handleReportProgress() start/end
```

### D. Continue Learning Card (MANDATORY)
```jsx
Component: New card in Sidebar.jsx
Display Condition: Only if currentUser has progress data

Content:
  - Heading: "Continue Learning" (text-xs, uppercase, bold)
  - Week Number: Large, bold (text-2xl) - last accessed week
  - Station Name: Last accessed station
  - Progress: % completion of that week
  - Button: "Resume ‚Üí" (navigates to /week/{lastWeek}/{lastStation})

Data Tracking:
  - Add to user object: lastWeek, lastStation (update on every station access)
  - Persist via: saveUserToDB()
  - Read from: currentUser.lastWeek, currentUser.lastStation

Styling:
  - Background: gradient-to-r from-indigo-500 to-purple-500
  - Text: white
  - Rounded: 2xl
  - Padding: 4
  - Position: Top of sidebar, below user profile
```

## 0.1.2. WEEK COMPLETION CELEBRATION (NEW - MANDATORY GAMIFICATION)
**Trigger:** When weekProgress reaches 100% (all stations complete)

### A. Confetti Animation
```jsx
Library: react-confetti (already in package.json)
Trigger: useEffect watching weekProgress
Condition: if (weekProgress === 100 && !weekCelebrated)
Duration: 5 seconds
Full screen: true
Colors: Match theme (indigo, purple, green)

Implementation:
  - Import: react-confetti in App.jsx
  - Add state: const [showConfetti, setShowConfetti] = useState(false)
  - Add useEffect: Monitor weekProgress, trigger confetti
  - Cleanup: setShowConfetti(false) after 5000ms
```

### B. Congratulations Modal
```jsx
Component: CongratulationsModal.jsx
Display: Center of screen (z-index: 60, backdrop blur)

Content:
  - Emoji: üéâ (large, animated)
  - Heading: "Week {weekId} Complete!"
  - Subheading: "You earned 50 bonus stars!"
  - Stats Display:
    * Total time spent (if tracked)
    * Stations completed: 15/15
    * Accuracy average (if tracked)
  - Message: "Next: Week {weekId + 1}"
  - Buttons:
    * "Continue to Week {weekId + 1}" (primary)
    * "Review Week {weekId}" (secondary)

Actions:
  - Award Stars: user.stats.stars += 50 (saveUserToDB())
  - Mark Week Certified: user.certified_weeks[weekId] = true
  - Unlock Next Week: user.unlocked_weeks[weekId + 1] = true (if using progression lock)
  - Dispatch Event: window.dispatchEvent(new Event('week-completed'))

Implementation:
  - Create: src/components/common/CongratulationsModal.jsx
  - Import in: src/App.jsx
  - Trigger: When weekProgress === 100
  - Close: User clicks button or backdrop
```

### C. Week Badge System (OPTIONAL ENHANCEMENT)
```jsx
Concept: Visual badges for week completion milestones

Badges:
  - Bronze: Complete 1 week (any mode)
  - Silver: Complete 5 weeks
  - Gold: Complete 10 weeks
  - Platinum: Complete 20 weeks
  - Diamond: Complete all Phase 1 (54 weeks)

Display:
  - In user profile modal
  - In sidebar header
  - In celebration modal

Data:
  - Store in: user.badges = ['bronze', 'silver', ...]
  - Calculate on: Every week completion
```

## 0.2. Image Generation Prompt (COVERS)
- Prompt for covers: `Wide landscape educational illustration for [title]. Context: [first 100 chars]. Render as a full-width 16:9 banner, show all content, do not crop any part, all important details must be visible within the frame.`
- Ratio: `16:9` for covers, `1:1` for vocab/wordpower.

## 0.3. UI Image Fitting
- All cover images must be displayed in the app with:
  - Container: `w-full bg-slate-900 relative overflow-hidden`
  - Image: `w-full h-auto` (no crop, full width, auto height)

## 0.4. Ask-AI Audio
- Each ask_ai prompt must have audio generated (`ask_ai_[id].mp3` from `context_en`).
- Audio URL is injected by script, and UI must play correct file.

## 0.5. Video Generation (UPDATED - EXACTLY 5 VIDEOS MANDATORY)
**CRITICAL:** Week 1 initially had 3 videos (WRONG). Master Prompt V23 now enforces EXACTLY 5 videos per week.

### Video Requirements
```javascript
// daily_watch.js structure
export default {
  videos: [
    { id: 1, videoId: '...', title: '...', duration: 180, sim_duration: 3, thumb: '...', purpose: 'GRAMMAR' },
    { id: 2, videoId: '...', title: '...', duration: 240, sim_duration: 4, thumb: '...', purpose: 'TOPIC' },
    { id: 3, videoId: '...', title: '...', duration: 300, sim_duration: 5, thumb: '...', purpose: 'TOPIC' },
    { id: 4, videoId: '...', title: '...', duration: 420, sim_duration: 7, thumb: '...', purpose: 'SCIENCE' },
    { id: 5, videoId: '...', title: '...', duration: 360, sim_duration: 6, thumb: '...', purpose: 'SCIENCE' }
  ]
};
```

### Video Distribution (MANDATORY FORMAT)
**Fixed Distribution (Week 19 Standard):**
- **GRAMMAR:** 2 videos (must directly teach week's grammar focus)
  - Example: Week 19 ‚Üí "Past Tense Song" + "Was/Were Explained"
- **TOPIC:** 2 videos (related to week's theme)  
  - Example: Week 1 ‚Üí "School Day" + "Classroom Learning"
- **SCIENCE:** 1 video (content-based learning)
  - Example: Week 1 ‚Üí "Science Tools for Kids"

**NEVER use other distributions** (e.g., 3 TOPIC + 0 SCIENCE). All weeks must follow: **2+2+1 format**.

### Video Curation Process (STANDARDIZED)

**Step 1: Create video_queries.json from Syllabus + Blueprint**

File location: `src/data/weeks/week_XX/video_queries.json`

Extract from `syllabus_database.js`:
- `weekId`: Week number
- `theme`: Week title
- `grammar`: Grammar focus from syllabus
- `topic`: Topic from syllabus  
- `science`: Science/CLIL focus from syllabus

For each of 5 videos (2 GRAMMAR + 2 TOPIC + 1 SCIENCE):
1. Create primary **query** - core keywords WITHOUT "for kids" or "ESL"
2. Create **backup_query** - alternative keywords if primary fails
3. Add "for kids" + "ESL" ONLY during YouTube search (not in JSON)

Example (Week 1):
```json
{
  "weekId": 1,
  "theme": "The Young Scholar",
  "grammar": "Subject Pronouns, Verb to be",
  "topic": "School day, Student life",
  "science": "Scientist tools",
  "videos": [
    {
      "id": 1,
      "purpose": "GRAMMAR",
      "query": "subject pronouns I you he she we they",
      "backup_query": "pronouns song kids English"
    },
    {
      "id": 2,
      "purpose": "GRAMMAR",
      "query": "verb to be am is are grammar",
      "backup_query": "am is are English lesson"
    },
    {
      "id": 3,
      "purpose": "TOPIC",
      "query": "school day student life",
      "backup_query": "first day school"
    },
    {
      "id": 4,
      "purpose": "TOPIC",
      "query": "classroom learning students",
      "backup_query": "school classroom activities"
    },
    {
      "id": 5,
      "purpose": "SCIENCE",
      "query": "scientist tools microscope magnifying glass",
      "backup_query": "science tools equipment"
    }
  ]
}
```

**Step 2: Automated Video Search (via update_videos.js)**

Search Priority:
1. **WHITELIST SEARCH** (Primary)
   - Add " for kids ESL" to query
   - Search only whitelist channels
   - Filter: 60s ‚â§ duration ‚â§ 900s (1-15 minutes)
   - Match: Title must contain keywords (GRAMMAR: 50% match, TOPIC/SCIENCE: 30% match)
   - If found ‚Üí Use video, mark as used

2. **BACKUP QUERY SEARCH** (Secondary)
   - Use backup_query instead of primary
   - Same whitelist + filters
   - If found ‚Üí Use video, mark as used

3. **EXPANDED SEARCH** (Tertiary)
   - Remove whitelist restriction
   - Still add " for kids ESL"
   - Same duration filters
   - Filter out: non-English, music videos, covers, karaoke
   - If found ‚Üí Use video, mark as used

4. **FALLBACK** (Last Resort)
   - Use fallback video for purpose (GRAMMAR/TOPIC/SCIENCE)
   - Default: "English Singsing - Grammar for Kids" or similar
   - Log warning

**Duration Validation:**
- MIN: 60 seconds (skip shorts)
- MAX: 900 seconds = 15 minutes
- Extract from YouTube API: `contentDetails.duration` (ISO 8601 format)

**Step 3: Summary of Complete Video Search Flow**

**Overview:**
```
Query (from JSON) + "for kids ESL" 
       ‚Üì
YouTube API search (20 results)
       ‚Üì
Priority 1: WHITELIST + Match + Duration Filter
       ‚îú‚îÄ Success? ‚Üí Use video ‚úÖ
       ‚îî‚îÄ Fail? ‚Üí Next priority
       ‚Üì
Priority 2: BACKUP QUERY (same as Priority 1)
       ‚îú‚îÄ Success? ‚Üí Use video ‚úÖ  
       ‚îî‚îÄ Fail? ‚Üí Next priority
       ‚Üì
Priority 3: EXPANDED (no whitelist) + Duration Filter
       ‚îú‚îÄ Success? ‚Üí Use video ‚úÖ
       ‚îî‚îÄ Fail? ‚Üí Next priority
       ‚Üì
Priority 4: FALLBACK (generic video)
       ‚îî‚îÄ Use purpose-specific fallback ‚Üí Warning logged ‚ö†Ô∏è
```

**Keywords Extraction:**
- STOP_WORDS removed: "for", "kids", "children", "song", "video", "esl", "english", "learn", "learning", "educational", "the", "and", "with", "story"
- Remaining keywords extracted from query
- For GRAMMAR: 50% keyword match required (strict)
- For TOPIC/SCIENCE: 30% keyword match required (lenient)

**Grammar Requirements (Auto-Applied):**
GRAMMAR queries with specific patterns MUST contain required grammar structure:
- "was were" ‚Üí title must contain: "was", "were", OR "verb to be"
- "can cannot" ‚Üí title must contain: "can", "can't", OR "cannot"
- "present simple" ‚Üí title must contain: "present simple", "do does", OR "every day"
- "present continuous" ‚Üí title must contain: "present continuous", "ing", OR "now"

**Important Notes:**
1. ‚úÖ Queries in JSON are CLEAN (no "for kids"/ESL added) ‚Üí Script adds during search
2. ‚úÖ Always provide backup_query for all videos ‚Üí Safety fallback
3. ‚úÖ Primary query should be 3-5 keywords max ‚Üí Better YouTube ranking
4. ‚úÖ Backup query can use common filler words ‚Üí Broader search net
Command: node tools/update_videos.js XX
Process:
  - Searches YouTube using queries
  - Filters by WHITELIST channels (British Council, English Singsing, etc.)
  - Applies GRAMMAR_REQUIREMENTS (strict keyword matching)
  - Validates duration (60-900 seconds)
  - Outputs EXACTLY 5 videos to daily_watch.js

# Step 3: Validation
Check: grep -c '"videoId"' src/data/weeks/week_XX/daily_watch.js
Expected: 5 (no more, no less)
If not 5: Manual review and regeneration required
```

### WHITELIST Channels (Priority Search)
**MUST search these channels FIRST before expanding search:**

**Grammar/English Skills (12 channels):**
- British Council | LearnEnglish Kids ‚≠ê
- English Singsing ‚≠ê
- WOW English TV
- Dream English Kids
- Fun Kids English
- Pinkfong English
- (See Blueprint Section II.4 for full list)

**Math (ESL-friendly, 12 channels):**
- Numberblocks ‚≠ê
- Math Antics
- Khan Academy Kids
- Jack Hartmann Kids Music Channel
- (See Blueprint Section II.4 for full list)

**Science (12 channels):**
- SciShow Kids ‚≠ê
- National Geographic Kids
- Peekaboo Kidz
- (See Blueprint Section II.4 for full list)

### Video Quality Standards
- **Duration:** 60-900 seconds (1-15 minutes)
- **Language:** Clear English (no heavy accents)
- **Visuals:** Engaging for ages 7-12
- **Content:** Educational, age-appropriate
- **No ads:** Prefer channels with minimal interruptions
- **Validity:** Check video not deleted/restricted (run validation)

### Validation Commands
```bash
# Check video count
grep -c '"videoId"' src/data/weeks/week_XX/daily_watch.js  # Must output: 5

# Verify videos load (manual)
Open app ‚Üí Week XX ‚Üí Daily Watch ‚Üí Click each video ‚Üí Verify plays

# Check for 404s (automated)
node tools/verify_videos.js XX  # (Create this tool if not exists)
```



## 0.6. Mass-Produce Command Sequence (STRICT, FULLY AUTOMATED)

### SINGLE COMMAND WORKFLOW (RECOMMENDED)
When you receive request to create a new week (e.g. "create week 20" or "generate week 1 data and assets"), you MUST execute this complete workflow in ONE GO:

**Step 0: Clean Old Data (if exists)**
```bash
# Remove all old data files for the target week (both modes)
rm -rf src/data/weeks/week_<WEEK_ID>/*
rm -rf src/data/weeks_easy/week_<WEEK_ID>/*
rm -rf public/audio/week<WEEK_ID>/*
rm -rf public/audio/week<WEEK_ID>_easy/*
rm -rf public/images/week<WEEK_ID>/*
rm -rf public/images/week<WEEK_ID>_easy/*
```

**Step 1: Read Syllabus and Blueprint**
```bash
# Extract week requirements from syllabus_database.js
# Extract pedagogical rules from ENGQUEST APP MASTER BLUEPRINT-FINAL.txt
# This step is MANDATORY before generating any content
```

**Step 2: Generate ALL 14 Data Files (Both Modes)**
For each week, you MUST create these files with content generated from syllabus and blueprint (NOT copied from other weeks):

**Advanced Mode** (`src/data/weeks/week_XX/`):
1. **read.js** - Story from syllabus topic
   - ‚ö†Ô∏è **MANDATORY: 8-12 sentences** (Blueprint requirement for Advanced mode)
   - ‚ö†Ô∏è **MANDATORY: Exactly 10 bold words** using Markdown `**word**` (Blueprint UI requirement)
   - **CRITICAL SYNTAX:** Use DOUBLE ASTERISKS `**word**` (NOT single `*word*`)
     - ‚úÖ CORRECT: `"My **name** is Alex. I am a **student** in a **school**."`
     - ‚ùå WRONG: `"My *name* is Alex."` (single asterisk = italic, NOT bold, UI WON'T WORK)
   - Bold words MUST match first 10 words from vocab.js (UI click-to-define feature)
   - Grammar: Use complex sentences (because, although, if, relative clauses)
   - Validation: Search for `**` in content_en - should find exactly 20 matches (10 words √ó 2 asterisks)
2. **explore.js** - CLIL article from syllabus science/global theme
   - ‚ö†Ô∏è **MANDATORY: 8-12 sentences** (Blueprint requirement for Advanced mode)
   - ‚ö†Ô∏è **MANDATORY: Exactly 10 bold words** using Markdown `**word**` (Blueprint UI requirement)
   - **CRITICAL SYNTAX:** Use DOUBLE ASTERISKS `**word**` (NOT single `*word*`)
     - ‚úÖ CORRECT: `"**Scientists** use special **tools** to learn."`
     - ‚ùå WRONG: `"*Scientists* use special *tools*."` (italic, NOT bold, breaks UI)
   - Bold words MUST match vocab.js or be domain-specific terms
   - Focus: Academic language, facts, data
   - Validation: Search for `**` in content_en - should find exactly 20 matches
3. vocab.js - 10 words from syllabus vocab list
4. word_power.js - 3 phrasal verbs related to topic
5. grammar.js - Grammar focus from syllabus + 20 exercises
6. logic.js - 5 contextual math/logic problems
7. ask_ai.js - 5 question prompts related to topic
8. dictation.js - ALL sentences from read.js story (split by periods, 10-16 sentences typically)
9. shadowing.js - IDENTICAL sentences as dictation.js (exact copy)
10. mindmap.js - 6 stems + 36 branches for speaking (nested object structure)
11. daily_watch.js - EXACTLY 5 YouTube videos (MANDATORY, auto-generated by script)
12. writing.js - 1 writing prompt related to topic
13. word_match.js - Placeholder `{ pairs: [1-10] }`
14. index.js - Import all files and map stations

**Easy Mode** (`src/data/weeks_easy/week_XX/`):
- Same 14 files, but with simplified content following blueprint morphing rules:
  - **read.js & explore.js:**
    - ‚ö†Ô∏è **MANDATORY: 6-8 sentences** (Blueprint requirement for Easy mode)
    - ‚ö†Ô∏è **MANDATORY: Exactly 10 bold words** using Markdown `**word**` (same as Advanced)
    - ‚ö†Ô∏è **CRITICAL MORPHING RULE:** SIMPLIFY Advanced content, DON'T REPLACE IT!
      - ‚úÖ CORRECT: Keep same topic/story/characters, simplify grammar + vocabulary
      - ‚ùå WRONG: Change topic entirely (e.g., Advanced = scientific tools, Easy = school items)
    - Grammar: Use simple/compound sentences (and, but, so)
    - Vocabulary: Use simpler synonyms (e.g., "big" instead of "enormous")
    - **Example Morphing:**
      ```
      Advanced: "Scientists use microscopes to observe tiny microorganisms."
      Easy:     "Scientists use microscopes to see very small things."
      
      Advanced: "Tom was excited about the archaeological expedition."
      Easy:     "Tom was happy about the trip to see old things."
      ```
  - **vocab.js:** Same 10 words, but simpler definitions
  - **All other files:** Simplified language, same structure
  
**‚ö†Ô∏è EASY MODE VALIDATION CHECKLIST:**
1. Same topic as Advanced? ‚úÖ
2. Same story characters as Advanced? ‚úÖ
3. Same 10 vocab words as Advanced? ‚úÖ
4. Simpler grammar (no complex sentences)? ‚úÖ
5. Shorter sentences (under 10 words)? ‚úÖ

**Step 3: Create Bridge Files**
```bash
# Advanced mode bridge
echo "export { default } from './week_<WEEK_ID>/index.js';" > src/data/weeks/week_<WEEK_ID>.js

# Easy mode bridge
echo "export { default } from './week_<WEEK_ID>/index.js';" > src/data/weeks_easy/week_<WEEK_ID>.js
```

**Step 4: Validate Data Files (PRE-FLIGHT CHECKS - MANDATORY)**
Before generating assets, run ALL these validation checks:

**4.1. File Count Validation:**
```bash
ls src/data/weeks/week_XX/*.js | wc -l          # Must be 14
ls src/data/weeks_easy/week_XX/*.js | wc -l     # Must be 14
```
If ‚â† 14, STOP and fix.

**4.2. Bold Words Validation (CRITICAL - Week 1 had 0 bold words!):**
```bash
# Advanced mode - must find exactly 10 matches per file
grep -o '\*\*[^*]*\*\*' src/data/weeks/week_XX/read.js | wc -l     # Must be 10
grep -o '\*\*[^*]*\*\*' src/data/weeks/week_XX/explore.js | wc -l  # Must be 10

# Easy mode - must find exactly 10 matches per file
grep -o '\*\*[^*]*\*\*' src/data/weeks_easy/week_XX/read.js | wc -l     # Must be 10
grep -o '\*\*[^*]*\*\*' src/data/weeks_easy/week_XX/explore.js | wc -l  # Must be 10
```
If any count ‚â† 10, STOP and add bold words using `**word**` syntax.

**4.3. Sentence Count Validation:**
```bash
# Advanced: 8-12 sentences required
grep 'content_en' src/data/weeks/week_XX/read.js | grep -o '\.' | wc -l     # 8-12
grep 'content_en' src/data/weeks/week_XX/explore.js | grep -o '\.' | wc -l  # 8-12

# Easy: 6-8 sentences required
grep 'content_en' src/data/weeks_easy/week_XX/read.js | grep -o '\.' | wc -l     # 6-8
grep 'content_en' src/data/weeks_easy/week_XX/explore.js | grep -o '\.' | wc -l  # 6-8
```
If out of range, STOP and regenerate content.

**4.4. WordPower Schema Validation:**
```bash
# Check for REQUIRED fields (must all exist)
grep -c '"id":' src/data/weeks/week_XX/word_power.js              # Must be 3
grep -c 'pronunciation:' src/data/weeks/week_XX/word_power.js      # Must be 3
grep -c 'cefr_level:' src/data/weeks/week_XX/word_power.js         # Must be 3
grep -c 'collocation:' src/data/weeks/week_XX/word_power.js        # Must be 3

# Check for FORBIDDEN fields (must NOT exist)
grep 'example_en\|example_vi' src/data/weeks/week_XX/word_power.js       # Must be empty
grep 'model_sentence_en\|model_sentence_vi' src/data/weeks/week_XX/word_power.js  # Must be empty
grep 'audio_word\|audio_def' src/data/weeks/week_XX/word_power.js        # Must be empty
```
If any check fails, STOP and fix schema.

**4.5. Station Key Mapping Validation:**
```bash
# Verify index.js uses Week 19 keys (not Week 1 keys)
grep 'logic_lab:' src/data/weeks/week_XX/index.js         # Must exist
grep 'mindmap_speaking:' src/data/weeks/week_XX/index.js  # Must exist
grep 'word_power:' src/data/weeks/week_XX/index.js        # Must exist
grep 'quiz:' src/data/weeks/week_XX/index.js              # Must NOT exist
```
If wrong keys found, STOP and fix mapping.

**‚ö†Ô∏è CRITICAL: If ANY validation fails, DO NOT proceed to Step 5 (asset generation)!**

**Step 5: Generate ALL Assets (Auto-read from API keys.txt)**

**Option A: Single Command (Recommended - generates all assets in one run):**
```bash
# Create wrapper script for one-command generation
cat > tools/generate_week_assets.sh << 'EOF'
#!/bin/bash
WEEK_ID=$1

if [ -z "$WEEK_ID" ]; then
  echo "‚ùå Usage: ./generate_week_assets.sh <WEEK_ID>"
  exit 1
fi

echo "üéµ Step 1/3: Generating audio for Week $WEEK_ID..."
node tools/generate_audio.js $WEEK_ID $WEEK_ID
if [ $? -ne 0 ]; then echo "‚ùå Audio generation failed"; exit 1; fi

echo "üñºÔ∏è  Step 2/3: Generating images for Week $WEEK_ID..."
node tools/batch_manager.js $WEEK_ID $WEEK_ID
if [ $? -ne 0 ]; then echo "‚ùå Image generation failed"; exit 1; fi

echo "üìπ Step 3/3: Generating videos for Week $WEEK_ID..."
YOUTUBE_API_KEY=$(grep YOUTUBE_API_KEY "API keys.txt" | head -1 | cut -d= -f2) \
node tools/update_videos.js $WEEK_ID --reset
if [ $? -ne 0 ]; then echo "‚ùå Video generation failed"; exit 1; fi

echo "‚úÖ All assets generated successfully for Week $WEEK_ID!"
EOF

chmod +x tools/generate_week_assets.sh

# Run it:
./tools/generate_week_assets.sh <WEEK_ID>
```

**Option B: Manual (Run each command separately):**
```bash
# Audio (scripts will auto-load keys from API keys.txt)
node tools/generate_audio.js <WEEK_ID> <WEEK_ID>

# Images (scripts will auto-load keys from API keys.txt)
node tools/batch_manager.js <WEEK_ID> <WEEK_ID>

# Video (scripts will auto-load keys from API keys.txt)
YOUTUBE_API_KEY="your_key" node tools/update_videos.js <WEEK_ID> --reset
```

**‚ö†Ô∏è IMPORTANT:** Asset generation will auto-read API keys from `API keys.txt`. Ensure file exists and has valid keys before running.

**Step 6: Verify Asset Generation**
```bash
# Check audio count (varies by content: typically ~120-130 per mode)
ls public/audio/week<WEEK_ID>/*.mp3 | wc -l
ls public/audio/week<WEEK_ID>_easy/*.mp3 | wc -l

# Check image count (15 per mode)
ls public/images/week<WEEK_ID>/*.jpg | wc -l
ls public/images/week<WEEK_ID>_easy/*.jpg | wc -l

# Check video data (EXACTLY 5 videos required)
grep -c "videoId" src/data/weeks/week_<WEEK_ID>/daily_watch.js
```

**Step 7: Final Validation**
- Confirm all data files have correct schema
- Confirm all assets generated successfully
- Confirm week shows up in app UI
- Report completion with full checklist

### CRITICAL RULES:
1. **NEVER skip Step 0** (clean old data) - always start fresh
2. **NEVER copy content** from other weeks - always generate from syllabus/blueprint
3. **NEVER proceed to Step 5** if Step 4 validation fails
4. **ALWAYS use API keys.txt** - scripts will auto-load keys, no manual input needed
5. **ALWAYS verify assets** after generation - if count incorrect, report error and halt

### WHEN USER SAYS "create week X" OR "generate week X":
You MUST execute ALL 7 steps above in sequence, without stopping to ask questions. If any step fails, report error immediately and halt. Do not proceed to next step until current step is verified successful.

---

### API KEYS FOR ASSET GENERATION (REQUIRED, DYNAMIC)

- **All asset generation scripts (audio, image, video) MUST read API keys from the file:**
  - `Engquest3k/API keys.txt` (one key per line, multiple keys allowed per service)
  - Use the first valid key for each service (YouTube, Gemini, Google TTS, OpenAI, etc.). If a key fails, try the next one in the list.
  - If `API keys.txt` is missing or unreadable, fallback to `.env` file in the project root (same key names, one per line).
  - If neither file is available, prompt the user to provide the keys.

- **YouTube API Key:** Use all keys listed under "Youtube Data API key" in `API keys.txt` (try in order).
- **Gemini API Key:** Use all keys listed under "GEMINI_API_KEY" in `API keys.txt` (try in order).
- **Google TTS API Key:** Use all keys listed under "Google Cloude Text to speech API key" in `API keys.txt` (try in order).
- **OpenAI TTS Key:** Use all keys listed under "OpenAI TTS key" in `API keys.txt` (try in order).

**All scripts and prompts must reference these keys dynamically, not hardcoded.**
**If a script or prompt cannot read the file, create a `.env` file in the project root with the same keys for manual copy-paste.**

**Example .env format:**
```
YOUTUBE_API_KEY=your_key_here
GEMINI_API_KEY=your_key_here
GOOGLE_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
```

**These keys must be used in the relevant commands above for successful asset generation.**



**Context:** Week 2 initially attempted manual asset creation until discovering official automated scripts in `tools/` directory.

**User Feedback:** "sao l·∫°i b·∫°n t·ª± t·∫°o images. ƒê√£ c√≥ l·ªánh t·∫°o b·∫±ng Nano banana r·ªìi m√†????" (Why create images manually? There's already Nano Banana command)

**Learning:** Always use official scripts - they ensure consistency, quality, and proper API key management.

#### 0.10.1 Audio Generation (Google Neural2 TTS)

**Official Script:** `tools/generate_audio.js`

**Usage:**
```bash
# Generate audio for single week:
node tools/generate_audio.js 2 2

# Generate audio for multiple weeks:  
node tools/generate_audio.js 1 5

# Script automatically:
# - Loads API key from 'API keys.txt'
# - Reads voiceConfig from week data
# - Applies prepareTTSText() to all content
# - Generates ~120-130 MP3 files per mode
# - Saves to public/audio/weekXX/ and public/audio/weekXX_easy/
```

**API Key Loading:**
```javascript
// Script automatically reads from 'API keys.txt':
// Google Cloude Text to speech API key=YOUR_KEY_HERE

// Fallback to environment variable:
export GOOGLE_TTS_API_KEY="your_key_here"
node tools/generate_audio.js 2 2
```

**Generated Audio Types:**
- **Vocabulary:** 40 files (10 words √ó 4 each: word, definition, example, collocation)
- **Word Power:** 12 files Phase 1 (3 items √ó 4 each)
- **Story Content:** 2 files (read_main.mp3, explore_main.mp3)
- **Dictation:** 8 files (sentence audio)
- **Shadowing:** 9 files (8 sentences + 1 full)
- **Mindmap:** 42 files (6 stems + 36 branches)
- **Logic Lab:** 5 files (puzzle audio)
- **Ask AI:** 5 files (context audio)

#### 0.10.2 Image Generation (Two Methods)

**Method A: Nano Banana (FREE - Gemini) - RECOMMENDED**
```bash
# Official Script: tools/generate_images_nano_banana.js
node tools/generate_images_nano_banana.js 2 advanced
node tools/generate_images_nano_banana.js 2 easy

# Benefits:
# - FREE (uses Gemini gemini-3-pro-image-preview model)
# - 15 images per week per mode
# - Auto-loads API key from 'API keys.txt'
# - Quality: 1024√ó1024 JPEG, suitable for ESL vocab
# - Built-in skip logic: skips existing files automatically

# Generated Images per mode:
# - 2 cover images (16:9 ratio): read_cover_w2.jpg, explore_cover_w2.jpg  
# - 10 vocab images (1:1 ratio): family.jpg, mother.jpg, etc.
# - 3 word_power images (1:1 ratio): wordpower_take_care.jpg, etc.

# Skip Logic:
# Script checks if (fs.existsSync(filepath)) before generating
# Console shows: "‚è≠Ô∏è filename already exists, skipping..."
```

**Method B: Batch Manager (FREE - Nano Banana Updated)**
```bash
# Updated Script: tools/batch_manager.js (now uses Nano Banana)  
node tools/batch_manager.js 2 2

# Benefits:
# - FREE (now uses Gemini gemini-3-pro-image-preview model)
# - Batch processing for multiple weeks
# - Smart image copying: Easy mode copies vocab from Advanced first
# - Same 15 images per week per mode
# - Cost optimization: Saves 50% by reusing vocab images in Easy mode

# Recent Update: Fixed broken imagen-3.0-generate-001 model
# Now uses same Nano Banana API as generate_images_nano_banana.js
```

**API Key Loading & Skip Logic (Both Methods):**
```javascript
// Both scripts read from 'API keys.txt':
// GEMINI_API_KEY=YOUR_KEY_HERE

// Audio Skip Logic:
// generate_audio.js checks: if (!fs.existsSync(filePath)) before adding task
// Only generates missing MP3 files, preserves existing ones

// Image Skip Logic: 
// generate_images_nano_banana.js: if (fs.existsSync(filepath)) before API call
// batch_manager.js: if (!fs.existsSync(localPath)) before adding to generation queue
// Console: "‚è≠Ô∏è [2/15] filename already exists, skipping..."

// Image Copying Optimization (Easy Mode):
// batch_manager.js copies vocab images from Advanced mode first
// Saves ~60% generation time and API calls for Easy mode

// Images saved to:
// public/images/week2/ (Advanced mode)  
// public/images/week2_easy/ (Easy mode)
```
// public/images/week2_easy/ (Easy mode - if using separate generation)
```

#### 0.10.3 Video Generation (YouTube API)

**Official Script:** `tools/update_videos.js`

**Prerequisites:**
```bash
# 1. Create video search queries file:
# src/data/weeks/week_2/video_queries.json

{
  "masterQuery": "family members for kids ESL English",
  "grammar": "family vocabulary this is my for kids",
  "videos": [
    { "id": 1, "query": "family members song for kids", "purpose": "GRAMMAR" },
    { "id": 2, "query": "this is my family for children", "purpose": "TOPIC" },
    { "id": 3, "query": "family tree for kids educational", "purpose": "TOPIC" },
    { "id": 4, "query": "animal families for children", "purpose": "SCIENCE" },
    { "id": 5, "query": "family around the world kids", "purpose": "SCIENCE" }
  ]
}
```

**Usage:**
```bash
# Set API key and generate videos:
YOUTUBE_API_KEY="your_key" node tools/update_videos.js 2 --reset

# Or let script read from 'API keys.txt':
# Youtube Data API key=YOUR_KEY_HERE
node tools/update_videos.js 2 --reset

# Script automatically:
# - Searches YouTube using queries
# - Filters by WHITELIST channels (British Council, English Singsing, etc.)
# - Validates video exists and is appropriate
# - Updates daily_watch.js with 5 real video IDs
```

**Generated Output:**
```javascript
// daily_watch.js updated with real videos:
export default {
  videos: [
    {
      id: 1,
      title: "Family Members Song - Mother Father Sister Brother",
      videoId: "abc123xyz",           // Real YouTube video ID
      duration: "03:42",
      sim_duration: 222,
      thumb: "https://img.youtube.com/vi/abc123xyz/mqdefault.jpg",
      purpose: "GRAMMAR"
    }
    // ... 4 more real videos (EXACTLY 5 total)
  ]
};
```

#### 0.10.4 Complete Asset Generation Workflow

**Automated Week Creation (Recommended):**
```bash
#!/bin/bash
# create_complete_week.sh
WEEK_ID=$1

if [ -z "$WEEK_ID" ]; then
  echo "Usage: ./create_complete_week.sh <WEEK_ID>"
  exit 1
fi

echo "üóÇÔ∏è  Step 1/6: Validating week data structure..."
bash tools/validate_week_structure.sh $WEEK_ID
if [ $? -ne 0 ]; then echo "‚ùå Data validation failed"; exit 1; fi

echo "üéµ Step 2/6: Generating audio for Week $WEEK_ID..."
node tools/generate_audio.js $WEEK_ID $WEEK_ID
if [ $? -ne 0 ]; then echo "‚ùå Audio generation failed"; exit 1; fi

echo "üñºÔ∏è  Step 3/6: Generating images for Week $WEEK_ID..."
node tools/generate_images_nano_banana.js $WEEK_ID advanced
node tools/generate_images_nano_banana.js $WEEK_ID easy
if [ $? -ne 0 ]; then echo "‚ùå Image generation failed"; exit 1; fi

echo "üìπ Step 4/6: Generating videos for Week $WEEK_ID..."
node tools/update_videos.js $WEEK_ID --reset
if [ $? -ne 0 ]; then echo "‚ùå Video generation failed"; exit 1; fi

echo "‚úÖ Step 5/6: Verifying asset counts..."
bash tools/verify_assets.sh $WEEK_ID
if [ $? -ne 0 ]; then echo "‚ö†Ô∏è  Some assets missing but continuing..."; fi

echo "üß™ Step 6/6: Testing week in app..."
echo "Manual test required: Open app ‚Üí Week $WEEK_ID ‚Üí Test stations"

echo "‚úÖ Week $WEEK_ID generation complete!"
echo "üìä Summary:"
echo "   Audio: ~120-130 files per mode"
echo "   Images: 15 files per mode"  
echo "   Videos: 5 files (shared between modes)"
echo "   Total cost: ~$0.00 (using free tiers)"
```

#### 0.10.5 API Key Management

**Centralized Key Storage:**
```bash
# File: API keys.txt (project root)
# Format: SERVICE_NAME=KEY_VALUE (one per line)

GEMINI_API_KEY=AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxx
Google Cloude Text to speech API key=AIzaSyCxxxxxxxxxxxxxxxxxxxxxxxx
Youtube Data API key=AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxx
OpenAI TTS key=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxx
```

**Key Rotation Support:**
```javascript
// Scripts support multiple keys per service (try in order):
GEMINI_API_KEY=key1_here
GEMINI_API_KEY=key2_backup
GEMINI_API_KEY=key3_emergency

// If key1 fails (quota/error), script automatically tries key2, then key3
```

**Security Best Practices:**
```bash
# Add to .gitignore:
echo "API keys.txt" >> .gitignore

# Set file permissions (read-only for owner):
chmod 600 "API keys.txt"

# Use environment variables in production:
export GEMINI_API_KEY="production_key"
export GOOGLE_TTS_API_KEY="production_key"
```

#### 0.10.6 Asset Verification Scripts

**File Count Verification:**
```bash
# tools/verify_assets.sh
#!/bin/bash
WEEK_ID=$1

# Check audio counts
AUDIO_ADV=$(ls public/audio/week${WEEK_ID}/*.mp3 2>/dev/null | wc -l)
AUDIO_EASY=$(ls public/audio/week${WEEK_ID}_easy/*.mp3 2>/dev/null | wc -l)

# Check image counts  
IMG_ADV=$(ls public/images/week${WEEK_ID}/*.{jpg,png,webp} 2>/dev/null | wc -l)
IMG_EASY=$(ls public/images/week${WEEK_ID}_easy/*.{jpg,png,webp} 2>/dev/null | wc -l)

# Check video count
VIDEO_COUNT=$(grep -c '"videoId"' src/data/weeks/week_${WEEK_ID}/daily_watch.js 2>/dev/null)

echo "üìä Asset Summary for Week $WEEK_ID:"
echo "üéµ Audio: Advanced=$AUDIO_ADV, Easy=$AUDIO_EASY (expect ~120-130 each)"
echo "üñºÔ∏è  Images: Advanced=$IMG_ADV, Easy=$IMG_EASY (expect 15 each)" 
echo "üìπ Videos: $VIDEO_COUNT (expect exactly 5)"

# Validation
if [ "$AUDIO_ADV" -lt 100 ] || [ "$AUDIO_EASY" -lt 100 ]; then
  echo "‚ö†Ô∏è  Warning: Low audio count (check for generation errors)"
fi

if [ "$IMG_ADV" -ne 15 ] || [ "$IMG_EASY" -ne 15 ]; then
  echo "‚ö†Ô∏è  Warning: Image count not 15 (check image generation)"
fi

if [ "$VIDEO_COUNT" -ne 5 ]; then
  echo "‚ùå Error: Video count not 5 (must have exactly 5 videos)"
  exit 1
fi

echo "‚úÖ Asset verification complete"
```

#### 0.10.7 Troubleshooting Common Issues

**Audio Generation Failures:**
```bash
# Issue: "API key invalid"
# Solution: Check 'API keys.txt' format and key validity

# Issue: "Voice not found: en-GB-Neural2-X" 
# Solution: Verify voiceConfig uses supported voices only

# Issue: "0 files generated"
# Solution: Check if audio folder already exists (script skips existing files)
rm -rf public/audio/weekXX
node tools/generate_audio.js XX XX
```

**Image Generation Failures:**
```bash
# Issue: "Gemini quota exceeded"
# Solution: Add backup API keys or use paid Imagen method

# Issue: "Images not found in app"
# Solution: Check image path format matches data file references

# Issue: "Generation stuck at 50%"
# Solution: Check network connection and API rate limits
```

**Video Generation Failures:**
```bash
# Issue: "No videos found"
# Solution: Check video_queries.json exists with 5 search queries

# Issue: "All videos rejected" 
# Solution: Broaden search queries (topic too specific)

# Issue: "Videos show 404 in app"
# Solution: Re-run with --reset flag to get fresh video IDs
```

---

**Context:** Week 2 deployment revealed multiple systematic issues that violated blueprint requirements. This checklist prevents repetition of ALL identified problems in remaining 142 weeks.

**User Directive:** "h√£y update master prompt v23, ƒë·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß c√°c y√™u c·∫ßu t·∫°o ƒë·ªß n·ªôi dung v√† asset ƒë√∫ng nh∆∞ quy ƒë·ªãnh trong blueprint v√† tr√°nh l·∫∑p l·∫°i c√°c l·ªói ƒëang c√≥ ·ªü tu·∫ßn 2"

#### 0.11.1 PRE-GENERATION VALIDATION (MANDATORY)

**Before creating ANY content for a new week, run ALL these checks:**

**Check 1: TTS Text Validation**
```bash
# Search for underscore sequences (causes "blank" pronunciation):
grep -r "___" src/data/weeks/week_XX/
# MUST return EMPTY result

# Search for scattered dots (causes choppy TTS):
grep -r "\.\s*\.\s*\." src/data/weeks/week_XX/
# MUST return EMPTY result (use solid "..." instead)
```

**Check 2: Mindmap Format Validation**
```bash
# Count ellipsis usage in mindmap stems:
grep -o "\.\.\." src/data/weeks/week_XX/mindmap.js | wc -l
# MUST equal number of centerStems (typically 6)

# Ensure NO underscores in mindmap:
grep "___" src/data/weeks/week_XX/mindmap.js
# MUST return EMPTY result
```

**Check 3: Ask AI Length Validation**
```bash
# Manual word count check for each context_en:
# Phase 1 (Weeks 1-14): MAX 16 words
# Phase 1.2 (Weeks 15-28): MAX 35 words  
# Phase 2+ (Weeks 29+): MAX 50 words

# Example validation:
grep "context_en" src/data/weeks/week_XX/ask_ai.js | head -1
# Count words manually - must be within phase limits
```

**Check 4: Schema Consistency Validation**
```bash
# Compare Advanced vs Easy mode field names:
diff <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks/week_XX/dictation.js | sort) \
     <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks_easy/week_XX/dictation.js | sort)
# MUST show NO differences

# Same for shadowing:
diff <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks/week_XX/shadowing.js | sort) \
     <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks_easy/week_XX/shadowing.js | sort)
# MUST show NO differences
```

**Check 5: Audio Path Format Validation**
```bash
# Search for incorrect audio formats:
grep -r "\.aiff\|\.wav\|\.m4a" src/data/weeks/week_XX/
# MUST return EMPTY result (only .mp3 allowed)

# Search for leading zeros in paths:
grep -r "/audio/week0[0-9]" src/data/weeks/week_XX/
# MUST return EMPTY result (use /audio/week2/ not /audio/week02/)
```

**Check 6: Video Content Validation**
```bash
# Verify video_queries.json exists:
ls src/data/weeks/week_XX/video_queries.json
# MUST exist before running video generation

# Verify exactly 5 video queries:
grep -c '"id":' src/data/weeks/week_XX/video_queries.json
# MUST return exactly 5
```

#### 0.11.2 POST-GENERATION VALIDATION (MANDATORY)

**After running asset generation scripts, verify:**

**Asset Count Validation:**
```bash
# Audio file counts (both modes):
AUDIO_ADV=$(ls public/audio/weekXX/*.mp3 2>/dev/null | wc -l)
AUDIO_EASY=$(ls public/audio/weekXX_easy/*.mp3 2>/dev/null | wc -l)
echo "Audio: Advanced=$AUDIO_ADV, Easy=$AUDIO_EASY (expect 120-130 each)"

# Image file counts (both modes):
IMG_ADV=$(ls public/images/weekXX/*.{jpg,png,webp} 2>/dev/null | wc -l)
IMG_EASY=$(ls public/images/weekXX_easy/*.{jpg,png,webp} 2>/dev/null | wc -l)
echo "Images: Advanced=$IMG_ADV, Easy=$IMG_EASY (expect exactly 15 each)"

# Video count (shared between modes):
VIDEO_COUNT=$(grep -c '"videoId"' src/data/weeks/week_XX/daily_watch.js 2>/dev/null)
echo "Videos: $VIDEO_COUNT (expect exactly 5)"
```

**Quality Validation:**
```bash
# Test TTS pronunciation (sample check):
# Play mindmap stem audio - should NOT hear "blank" or "underscore"
node -e "console.log('Test: This is my ...')" | say -v "Samantha"
# Should hear natural pause, not word "blank"

# Test video loading (sample check):
# Get first video ID and test in browser:
FIRST_VIDEO=$(grep -m1 '"videoId":' src/data/weeks/week_XX/daily_watch.js | cut -d'"' -f4)
echo "Test video: https://youtube.com/watch?v=$FIRST_VIDEO"
# Should load valid educational video
```

#### 0.11.3 SPECIFIC WEEK 2 ERROR PREVENTION

**Issue Prevention Mapping:**

| Week 2 User Complaint | Root Cause | Prevention Check |
|----------------------|------------|------------------|
| "Sao l·∫°i ƒë·ªçc c·∫£ black v·∫≠y?" | TTS reading `___` as "blank" | grep for underscores BEFORE audio generation |
| "Mindmap l√†m ch∆∞a ƒë√∫ng" | Used `___` instead of `...` | Validate ellipsis format in mindmap stems |
| "Ask-AI th√¨ context d√†i qu√°" | Exceeded phase word limits | Manual word count validation |
| "Dictation v√† Shadowing chua wa hi·ªÉn th·ªã ƒë√∫ng" | Schema inconsistency between modes | diff command validation |
| "Daily watch v·∫´n tr·ªëng kh√¥ng" | No video generation run | Verify video_queries.json + real videoIds |
| "dictation v√† shadowing v·∫´n ch∆∞a ƒë√∫ng path" | Wrong audio format (.aiff vs .mp3) | grep for non-.mp3 formats |

**Automated Prevention Script:**
```bash
#!/bin/bash
# tools/prevent_week2_errors.sh
WEEK_ID=$1

echo "üîç Preventing Week 2 errors for Week $WEEK_ID..."

# Error 1: TTS Underscore Issue
UNDERSCORE_COUNT=$(grep -r "___" src/data/weeks/week_${WEEK_ID}/ | wc -l)
if [ "$UNDERSCORE_COUNT" -gt 0 ]; then
  echo "‚ùå Found $UNDERSCORE_COUNT underscore sequences (will cause TTS 'blank' pronunciation)"
  grep -rn "___" src/data/weeks/week_${WEEK_ID}/
  exit 1
fi

# Error 2: Mindmap Format Issue  
MINDMAP_ELLIPSIS=$(grep -c "\.\.\." src/data/weeks/week_${WEEK_ID}/mindmap.js)
MINDMAP_STEMS=$(grep -c '"' src/data/weeks/week_${WEEK_ID}/mindmap.js | head -6 | tail -1)
if [ "$MINDMAP_ELLIPSIS" -lt 6 ]; then
  echo "‚ùå Mindmap has $MINDMAP_ELLIPSIS ellipsis but needs 6+ (one per stem)"
  exit 1
fi

# Error 3: Ask AI Length Issue (manual check required)
echo "‚ö†Ô∏è  Manual check required: Validate Ask AI context word counts"
echo "   Phase 1 (Weeks 1-14): MAX 16 words per context"
echo "   Phase 1.2 (Weeks 15-28): MAX 35 words per context"
echo "   Phase 2+ (Weeks 29+): MAX 50 words per context"

# Error 4: Schema Consistency Issue
SCHEMA_DIFF=$(diff -q \
  <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks/week_${WEEK_ID}/dictation.js | sort) \
  <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks_easy/week_${WEEK_ID}/dictation.js | sort))
if [ -n "$SCHEMA_DIFF" ]; then
  echo "‚ùå Dictation schema differs between Advanced and Easy modes"
  exit 1
fi

# Error 5: Video Content Issue
if [ ! -f "src/data/weeks/week_${WEEK_ID}/video_queries.json" ]; then
  echo "‚ùå Missing video_queries.json (videos will be empty placeholders)"
  exit 1
fi

VIDEO_QUERY_COUNT=$(grep -c '"id":' src/data/weeks/week_${WEEK_ID}/video_queries.json)
if [ "$VIDEO_QUERY_COUNT" -ne 5 ]; then
  echo "‚ùå video_queries.json has $VIDEO_QUERY_COUNT queries but needs exactly 5"
  exit 1
fi

# Error 6: Audio Format Issue
WRONG_FORMAT_COUNT=$(grep -r "\.aiff\|\.wav\|\.m4a" src/data/weeks/week_${WEEK_ID}/ | wc -l)
if [ "$WRONG_FORMAT_COUNT" -gt 0 ]; then
  echo "‚ùå Found non-.mp3 audio references (scripts only generate .mp3)"
  grep -rn "\.aiff\|\.wav\|\.m4a" src/data/weeks/week_${WEEK_ID}/
  exit 1
fi

echo "‚úÖ Week $WEEK_ID passed all Week 2 error prevention checks"
```

#### 0.11.4 INTEGRATION INTO MASS PRODUCTION

**Updated Mass Production Workflow:**
```bash
#!/bin/bash
# Updated: create_week_with_prevention.sh
WEEK_ID=$1

echo "üöÄ Creating Week $WEEK_ID with error prevention..."

# Step 1: Generate data files (human/AI task)
echo "üìù Step 1: Generate 14 data files for both modes"
echo "   Manual task: Create content following syllabus + blueprint"

# Step 2: Run prevention checks BEFORE asset generation
echo "üîç Step 2: Running Week 2 error prevention checks..."
bash tools/prevent_week2_errors.sh $WEEK_ID
if [ $? -ne 0 ]; then
  echo "‚ùå Prevention checks failed - fix issues before continuing"
  exit 1
fi

# Step 3: Generate assets (only if prevention checks pass)
echo "üéµ Step 3: Generating assets..."
node tools/generate_audio.js $WEEK_ID $WEEK_ID
node tools/generate_images_nano_banana.js $WEEK_ID  
node tools/update_videos.js $WEEK_ID --reset

# Step 4: Validate asset generation results
echo "üìä Step 4: Validating asset counts..."
bash tools/verify_assets.sh $WEEK_ID
if [ $? -ne 0 ]; then
  echo "‚ö†Ô∏è  Asset validation warnings - review but continuing"
fi

# Step 5: Final quality check
echo "üß™ Step 5: Final quality assurance..."
echo "Manual test required:"
echo "1. Open app ‚Üí Week $WEEK_ID"  
echo "2. Test mindmap audio (should NOT hear 'blank')"
echo "3. Test dictation/shadowing (should display consistently)"
echo "4. Test daily watch videos (should be real content)"
echo "5. Test ask AI contexts (should be appropriate length)"

echo "‚úÖ Week $WEEK_ID creation complete with error prevention"
echo "üìã Next: Manual QA testing in app"
```

#### 0.11.5 SUCCESS METRICS & MONITORING

**User Experience Indicators (No Complaints About):**
- [ ] TTS pronunciation errors ("blank" sounds)
- [ ] Mindmap completion awkwardness  
- [ ] Ask AI contexts being too long/complex
- [ ] UI inconsistencies between Advanced/Easy modes
- [ ] Missing or placeholder content (videos, audio)
- [ ] Wrong audio file formats or paths

**Technical Quality Indicators:**
- [ ] All validation commands return expected results
- [ ] Asset generation scripts complete without errors
- [ ] File counts match requirements consistently
- [ ] No manual asset creation needed (scripts handle everything)
- [ ] API key management works seamlessly

**Prevention Success Metrics:**
- [ ] Zero Week 2 issue patterns reported in Week 3+
- [ ] Mass production generates consistently high-quality weeks
- [ ] Blueprint compliance maintained across all 144 weeks
- [ ] Asset generation workflow runs without manual intervention
- [ ] User feedback focuses on content, not technical issues

#### 0.11.6 EMERGENCY ROLLBACK PROCEDURE

**If Week 2 Issues Recur:**
```bash
# 1. Identify specific issue from user feedback
echo "Issue reported: [specific complaint]"

# 2. Map to prevention check that should have caught it
grep -A5 -B5 "[complaint keyword]" tools/prevent_week2_errors.sh

# 3. Update prevention script to catch this issue
# Add new validation check to prevent_week2_errors.sh

# 4. Re-run prevention on all existing weeks
for week in {1..144}; do
  bash tools/prevent_week2_errors.sh $week
  if [ $? -ne 0 ]; then
    echo "Week $week needs fixes"
  fi
done

# 5. Fix identified issues before deploying more weeks
echo "Fix all identified issues before continuing mass production"
```

---

## 0.7. Checklist (MUST, STRICT)

**Context:** Week 2 Easy mode had different data structure than Advanced mode, causing UI rendering inconsistencies and broken functionality.

**User Feedback:** "Dictation v√† Shadowing chua wa hi·ªÉn th·ªã ƒë√∫ng" (Dictation and Shadowing not displaying correctly)

**Root Cause:** Easy mode created with simplified structure that didn't match component expectations.

#### 0.9.1 Unified Schema Requirements (MANDATORY)

**Both Advanced and Easy modes MUST use identical data structures:**

**Dictation.js Schema (MANDATORY):**
```javascript
export default {
  sentences: [                          // ‚úÖ REQUIRED array name
    {
      id: 1,                           // ‚úÖ REQUIRED sequential ID
      text: "This is my family.",       // ‚úÖ REQUIRED - exact sentence from read.js
      meaning: "ƒê√¢y l√† gia ƒë√¨nh t√¥i."   // ‚úÖ REQUIRED - Vietnamese translation
    },
    {
      id: 2,
      text: "My family has five people.",
      meaning: "Gia ƒë√¨nh t√¥i c√≥ nƒÉm ng∆∞·ªùi."
    }
    // ... typically 8 sentences (can be 6-10 based on read.js length)
  ]
};
```

**Shadowing.js Schema (MANDATORY):**
```javascript
export default {
  title: "My Family Story",                     // ‚úÖ REQUIRED - matches read.js title
  audio_full: "/audio/week2/shadowing_full_w2.mp3", // ‚úÖ REQUIRED - complete audio
  script: [                                     // ‚úÖ REQUIRED array name  
    {
      id: 1,                                   // ‚úÖ REQUIRED sequential ID
      text: "This is my family.",              // ‚úÖ REQUIRED - SAME as dictation text
      vi: "ƒê√¢y l√† gia ƒë√¨nh t√¥i.",              // ‚úÖ REQUIRED - SAME as dictation meaning
      audio_url: "/audio/week2/shadowing_1.mp3" // ‚úÖ REQUIRED - individual sentence audio
    },
    {
      id: 2,
      text: "My family has five people.",
      vi: "Gia ƒë√¨nh t√¥i c√≥ nƒÉm ng∆∞·ªùi.",
      audio_url: "/audio/week2/shadowing_2.mp3"
    }
    // ... EXACT same count as dictation sentences
  ]
};
```

**Critical Requirements:**
- **Sentence Count:** Dictation and Shadowing MUST have identical sentence count
- **Text Content:** Shadowing `script[].text` MUST match Dictation `sentences[].text` exactly
- **Translations:** Shadowing `script[].vi` MUST match Dictation `sentences[].meaning` exactly
- **Source:** All sentences MUST come from read.js story (split naturally at sentence boundaries)

#### 0.9.2 Content Source Rules (MANDATORY)

**Sentence Extraction from Read.js:**
```javascript
// Step 1: Read story content
const storyText = "This is my family. My family has five people. There is my mom, dad, sister, brother and me. My mom is a teacher. She is very kind. My dad works at a bank. He is funny. My sister is ten years old. She likes to draw. My brother is eight. He loves soccer.";

// Step 2: Split into sentences (at natural boundaries)
const sentences = [
  "This is my family.",                    // Sentence 1
  "My family has five people.",            // Sentence 2  
  "There is my mom, dad, sister, brother and me.", // Sentence 3
  "My mom is a teacher.",                  // Sentence 4
  "She is very kind.",                     // Sentence 5
  "My dad works at a bank.",               // Sentence 6
  "He is funny.",                          // Sentence 7
  "My sister is ten years old."            // Sentence 8
  // Stop at 8 sentences (optimal for A0++ attention span)
];

// Step 3: Create identical content for both stations
// dictation.js uses: sentences[0].text = "This is my family."  
// shadowing.js uses: script[0].text = "This is my family." (SAME)
```

**Sentence Selection Criteria:**
- **Length:** 4-12 words per sentence (A0++ appropriate)
- **Grammar:** Match week's grammar focus (Present Simple for Week 2)
- **Vocabulary:** Use only week syllabus words
- **Completeness:** Each sentence must be complete thought
- **Natural Order:** Follow story narrative flow

#### 0.9.3 Audio File Requirements

**Dictation Audio (Generated by Script):**
```javascript
// Generated files (script creates these automatically):
"/audio/week2/dictation_1.mp3"         // Sentence 1 audio
"/audio/week2/dictation_2.mp3"         // Sentence 2 audio  
// ... up to dictation_8.mp3

// Data file references (set to null - script injects paths):
sentences: [
  { id: 1, text: "...", audio_url: null }  // Script auto-injects correct path
]
```

**Shadowing Audio (Generated by Script):**
```javascript
// Generated files:
"/audio/week2/shadowing_1.mp3"         // Individual sentence 1
"/audio/week2/shadowing_2.mp3"         // Individual sentence 2
// ... up to shadowing_8.mp3
"/audio/week2/shadowing_full_w2.mp3"   // Complete passage (all sentences)

// Data file references:
script: [
  { id: 1, text: "...", audio_url: "/audio/week2/shadowing_1.mp3" },  // Explicit path
],
audio_full: "/audio/week2/shadowing_full_w2.mp3"  // Explicit full audio path
```

**Audio Naming Convention:**
```bash
# Week 1-9: No leading zeros
/audio/week2/dictation_1.mp3         # ‚úÖ CORRECT
/audio/week02/dictation_1.mp3        # ‚ùå WRONG - leading zero

# Easy mode: Add _easy suffix  
/audio/week2_easy/dictation_1.mp3    # ‚úÖ CORRECT
/audio/week_2_easy/dictation_1.mp3   # ‚ùå WRONG - underscore format

# Shadowing full audio: Use week ID
/audio/week2/shadowing_full_w2.mp3   # ‚úÖ CORRECT (w2 = week 2)
/audio/week2/shadowing_full.mp3      # ‚ùå WRONG - missing week identifier
```

#### 0.9.4 Mode Differentiation (Content, Not Structure)

**Advanced Mode Characteristics:**
- **Sentence Length:** 8-12 words average
- **Grammar:** Complex sentences (compound, relative clauses)
- **Vocabulary:** Full week syllabus (all 10 words)
- **Example:** "My family has five people including my parents and siblings."

**Easy Mode Characteristics:**  
- **Sentence Length:** 4-8 words average
- **Grammar:** Simple sentences (S-V-O only)
- **Vocabulary:** Core 50% of week syllabus
- **Example:** "My family has five people."

**Schema Consistency Rule:**
- **Structure:** IDENTICAL (same field names, same array structure)
- **Content:** DIFFERENT (different sentence complexity)
- **Count:** CAN vary (Easy might have 6 sentences vs Advanced 8)
- **Source:** BOTH from respective read.js story

#### 0.9.5 UI Component Expectations

**Dictation Station Requirements:**
```jsx
// Components expect this exact structure:
const dictationData = {
  sentences: [                          // Array named 'sentences'
    {
      id: Number,                      // Sequential ID for tracking
      text: String,                    // Sentence for dictation
      meaning: String                  // Vietnamese translation
    }
  ]
};
```

**Shadowing Station Requirements:**
```jsx
// Components expect this exact structure:
const shadowingData = {
  title: String,                       // Display title
  audio_full: String,                  // Path to complete audio
  script: [                           // Array named 'script'  
    {
      id: Number,                     // Sequential ID for tracking
      text: String,                   // Sentence for shadowing
      vi: String,                     // Vietnamese translation  
      audio_url: String               // Path to individual audio
    }
  ]
};
```

**Component Behavior:**
- Dictation: Plays audio, student types what they hear, validates against `text`
- Shadowing: Student reads along with audio, practices pronunciation
- Both use Vietnamese translation for comprehension support

#### 0.9.6 Validation Commands

**Pre-Asset Generation Checks:**
```bash
# 1. Schema Validation (must pass for both modes):
grep -c '"sentences":' src/data/weeks/week_XX/dictation.js        # Must be 1
grep -c '"script":' src/data/weeks/week_XX/shadowing.js           # Must be 1
grep -c '"audio_full":' src/data/weeks/week_XX/shadowing.js       # Must be 1

# 2. Count Consistency Check:
DICT_COUNT=$(grep -c '"id":' src/data/weeks/week_XX/dictation.js)
SHAD_COUNT=$(grep -c '"id":' src/data/weeks/week_XX/shadowing.js)
if [ "$DICT_COUNT" != "$SHAD_COUNT" ]; then
  echo "‚ùå Sentence count mismatch: Dictation=$DICT_COUNT, Shadowing=$SHAD_COUNT"
fi

# 3. Field Name Validation:
grep '"meaning":' src/data/weeks/week_XX/dictation.js     # Must have results  
grep '"vi":' src/data/weeks/week_XX/shadowing.js          # Must have results
grep '"text":' src/data/weeks/week_XX/dictation.js       # Must have results
grep '"text":' src/data/weeks/week_XX/shadowing.js       # Must have results

# 4. Audio Path Format Check:
grep '"/audio/week[0-9]' src/data/weeks/week_XX/shadowing.js  # Check format
grep -v '"/audio/week0[0-9]' src/data/weeks/week_XX/shadowing.js # No leading zeros
```

**Post-Asset Generation Verification:**
```bash
# Audio file count check:
DICT_AUDIO=$(ls public/audio/weekXX/dictation_*.mp3 | wc -l)
SHAD_AUDIO=$(ls public/audio/weekXX/shadowing_[0-9]*.mp3 | wc -l)  
FULL_AUDIO=$(ls public/audio/weekXX/shadowing_full_*.mp3 | wc -l)

echo "Dictation audio: $DICT_AUDIO files"
echo "Shadowing individual: $SHAD_AUDIO files"  
echo "Shadowing full: $FULL_AUDIO files (should be 1)"

# Verify audio count matches data
if [ "$DICT_AUDIO" != "$SHAD_AUDIO" ]; then
  echo "‚ùå Audio count mismatch between dictation and shadowing"
fi
```

#### 0.9.7 Error Prevention Checklist

**Before Creating Dictation/Shadowing Files:**
- [ ] Read story from read.js (source of all sentences)
- [ ] Split into 6-10 natural sentences (appropriate for A0++ attention span)
- [ ] Verify sentence length (4-12 words per sentence)
- [ ] Check grammar complexity matches mode (Simple for Easy, Complex for Advanced)
- [ ] Use identical schema (copy Week 19 structure exactly)
- [ ] Ensure same sentence count in both dictation and shadowing
- [ ] Verify audio path format (no leading zeros, correct _easy suffix)

**Common Mistakes to Avoid:**
| Mistake | Impact | Prevention |
|---------|--------|------------|
| Different schemas between modes | UI breaks | Copy Advanced structure to Easy, change content only |
| Mismatched sentence counts | Component errors | Always keep dictation.sentences.length == shadowing.script.length |
| Wrong field names (`meaning` vs `vi`) | Data not displayed | Use Week 19 as template exactly |
| Leading zeros in paths | Audio files not found | Follow naming convention: /audio/week2/ not /audio/week02/ |
| Not sourced from read.js | Content inconsistency | All sentences MUST come from week's read.js story |

#### 0.9.8 Advanced Features (Optional Enhancement)

**Progress Tracking Integration:**
```javascript
// Optional: Track completion rate
const dictationProgress = {
  completed_sentences: [1, 2, 3],      // Successfully completed sentence IDs
  accuracy_rate: 0.85,                 // 85% accuracy average
  completion_time: 180                 // Seconds to complete
};
```

**Adaptive Difficulty:**
```javascript
// Optional: Adjust based on student performance  
const adaptiveShadowing = {
  speech_rate: 0.8,                    // Slow down for struggling students
  repeat_count: 3,                     // Allow more repetitions
  hint_level: 2                        // Show Vietnamese translation after 2 tries
};
```

---

## 0.10. OFFICIAL ASSET GENERATION SCRIPTS (MANDATORY)

**Context:** Week 2 mindmap generated with underscores instead of ellipsis, causing TTS to pronounce "blank" instead of natural pauses.

**User Feedback:** "Mindmap l√†m ch∆∞a ƒë√∫ng" (Mindmap structure not correct)

#### 0.8.1 Stem Format Rules (CRITICAL)

**‚úÖ CORRECT Format - Natural Completion Pattern:**
```javascript
// mindmap.js - centerStems array
centerStems: [
  "This is my ...",              // ‚úÖ Ellipsis for natural pause
  "My family has ...",           // ‚úÖ Sounds natural when spoken
  "I love my ...",               // ‚úÖ Easy to complete orally
  "At home we ...",              // ‚úÖ Encourages speaking practice
  "My favorite thing is ...",    // ‚úÖ Open-ended completion
  "Every day I ..."              // ‚úÖ Daily routine prompts
]
```

**‚ùå WRONG Format - Underscore Sequences:**
```javascript
// DON'T DO THIS - Causes TTS pronunciation issues
centerStems: [
  "This is my _____.",           // ‚ùå TTS reads as "blank blank blank"
  "My family has ___.",          // ‚ùå TTS reads as "underscore underscore"
  "I love my ____.",             // ‚ùå Disrupts natural speech flow
]
```

#### 0.8.2 Branch Completion Guidelines

**Natural Speech Patterns:**
```javascript
branchLabels: {
  "This is my ...": [
    "family",                    // ‚úÖ Single word completion
    "home",                      // ‚úÖ Natural noun
    "classroom",                 // ‚úÖ Week-appropriate vocabulary
    "favorite book",             // ‚úÖ Short phrase (2-3 words max)
    "best friend",               // ‚úÖ Familiar concept
    "pet dog"                    // ‚úÖ Concrete, relatable
  ]
}
```

**Completion Quality Standards:**
- **Length:** 1-3 words maximum per branch
- **Vocabulary:** From week's syllabus only (no advanced words)
- **Grammar:** Simple nouns/noun phrases (matches A0++ level)
- **Relevance:** Connects to week theme (family, school, identity, etc.)
- **Naturalness:** Student would actually say this in conversation

#### 0.8.3 Audio Considerations

**TTS-Friendly Stems:**
```javascript
// ‚úÖ GOOD - Flows naturally in speech:
"When I'm happy, I ..."         // Sounds conversational
"My teacher is ..."             // Natural sentence starter
"After school I ..."            // Temporal connector

// ‚ö†Ô∏è AVOID - Awkward when spoken:
"The thing that I most want is ..." // Too long, complex structure
"Regarding my feelings about ..."   // Academic, unnatural for A0++
```

**Ellipsis Pronunciation:**
- TTS treats `...` as natural pause (500ms silence)
- Student hears: "This is my [pause]" ‚Üí brain fills completion
- Creates expectation for speaking practice

#### 0.8.4 Cultural Localization

**Vietnamese ESL Context:**
```javascript
// ‚úÖ APPROPRIATE - Familiar to Vietnamese students:
branchLabels: {
  "My family has ...": [
    "a motorbike",               // Common in Vietnam
    "rice for dinner",           // Cultural food reference
    "many photos",               // Universal family experience
    "a small house",             // Relatable living situation
  ]
}

// ‚ùå AVOID - Culturally unfamiliar:
branchLabels: {
  "My family has ...": [
    "a swimming pool",           // Uncommon in most Vietnamese homes
    "thanksgiving dinner",       // Western holiday concept
    "a basement",                // Not typical in Vietnamese architecture
  ]
}
```

#### 0.8.5 Validation Commands

**Pre-Publication Checks:**
```bash
# 1. Underscore Detection (MUST be empty):
grep -r "___" src/data/weeks/week_XX/mindmap.js
# Should return NO results

# 2. Ellipsis Count Validation:
grep -o "\.\.\." src/data/weeks/week_XX/mindmap.js | wc -l
# Should equal number of centerStems (typically 6)

# 3. Branch Count Validation:
grep -c "\".*\":" src/data/weeks/week_XX/mindmap.js
# Should equal number of stems (nested object structure)

# 4. Audio Path Validation:
grep "audio" src/data/weeks/week_XX/mindmap.js
# Should be EMPTY (audio generated by script, not in data)
```

**TTS Quality Test:**
```bash
# Generate sample audio to test pronunciation:
echo "This is my ..." | say -v "Samantha"
# Should hear: "This is my [natural pause]" 
# NOT: "This is my blank blank blank"
```

#### 0.8.6 Integration with Speaking Practice

**Pedagogical Flow:**
1. **Audio Plays:** "This is my ..." (with natural pause)
2. **Student Hears:** Complete sentence starter + pause expectation
3. **Student Thinks:** What can complete this naturally?
4. **Student Clicks:** Branch option that feels right
5. **Student Speaks:** Full sentence aloud ("This is my family")

**UI Behavior:**
- Stem audio includes ellipsis pause (encourages mental completion)
- Branch audio provides full word/phrase (confirmation/correction)
- Student practices saying complete sentences, not fragments

#### 0.8.7 Error Prevention Strategy

**Content Creation Rules:**
1. **Write stems as spoken sentences** with ellipsis endpoints
2. **Test stem completion orally** - does it sound natural?
3. **Validate branch vocabulary** against week syllabus
4. **Check cultural appropriateness** for Vietnamese context
5. **Count words per branch** - maximum 3 words
6. **Avoid academic language** - use conversational patterns

**Quality Assurance:**
- Every mindmap stem MUST sound like natural conversation starter
- Every branch MUST be something A0++ student would actually say
- Every completion MUST form grammatically correct sentence
- TTS pronunciation MUST sound like native speaker having natural conversation

#### 0.8.8 Advanced/Easy Mode Differentiation

**Advanced Mode Characteristics:**
```javascript
centerStems: [
  "When I grow up, I want to ...",    // Future orientation
  "My favorite subject is ...",       // Academic vocabulary
  "The most interesting thing is ..." // Complex sentence structure
]
```

**Easy Mode Characteristics:**
```javascript  
centerStems: [
  "I like ...",                       // Simple present tense
  "My name is ...",                   // Basic identity
  "This is ..."                       // Present tense, demonstrative
]
```

**Morphing Rules:**
- **Same topic/theme** (both about family, school, etc.)
- **Different complexity** (Advanced = compound sentences, Easy = simple)
- **Same vocabulary scope** (both use week syllabus words)
- **Different grammar structures** (Advanced = complex, Easy = S-V-O only)

---

## 0.7. Checklist (MUST, STRICT)

**Critical Context:** Week 2 revealed TTS pronunciation issues that must be prevented in all future weeks.

#### 0.7.1 Text Preparation for Natural Speech

**MANDATORY Function Implementation:**
```javascript
// src/services/tts.js - REQUIRED in every project
function prepareTTSText(text) {
  return text
    // Replace all underscore sequences with ellipsis for natural pause
    .replace(/_{3,}/g, '...')                    // ___ ‚Üí ...
    .replace(/_{1,2}/g, ' ')                     // _ or __ ‚Üí space
    
    // Clean ellipsis spacing for proper pronunciation
    .replace(/\s*\.\.\.\s*/g, ' ... ')           // Ensure spacing around ...
    .replace(/\s*\.\s*\.\s*\.\s*/g, ' ... ')     // Fix scattered dots
    
    // Fix common text-to-speech issues
    .replace(/\s+/g, ' ')                        // Multiple spaces ‚Üí single space
    .replace(/([.!?])\s*([A-Z])/g, '$1 $2')      // Sentence spacing
    .replace(/([,;:])\s*/g, '$1 ')               // Punctuation spacing
    
    .trim();
}
```

**USAGE REQUIREMENTS:**
```javascript
// ‚úÖ CORRECT - All TTS calls MUST use prepareTTSText:
const cleanText = prepareTTSText(originalText);
const audioBlob = await generateTTS(cleanText, options);

// ‚ùå WRONG - Direct text to TTS (causes "blank" pronunciation):
const audioBlob = await generateTTS(originalText, options); // DON'T DO THIS
```

**Application Areas:**
- Mindmap stems and branches (most critical - user heard "blank" here)
- Word Power definitions and examples
- Story content (read.js, explore.js)
- Grammar explanations
- Logic Lab problems
- Ask AI contexts

#### 0.7.2 Voice Configuration Requirements

**MANDATORY Voice Rotation (Week-by-Week):**
```javascript
// Each week MUST have unique voiceConfig to prevent monotony
export default {
  weekId: XX,
  voiceConfig: {
    narration: 'en-GB-Neural2-A',     // Rotate: Week 1‚ÜíUS, Week 2‚ÜíGB, Week 3‚ÜíAU
    vocabulary: 'en-AU-Neural2-B',    // MUST be different from previous week
    dictation: 'en-US-Neural2-E',     // Choose expressive voices for engagement
    questions: 'en-US-Neural2-D',     // Male/female balance across stations
    mindmap: 'en-US-Neural2-F'        // ‚ö†Ô∏è Most important - students hear this most
  }
}
```

**Emotional Expression Requirements (Blueprint Compliance):**
```javascript
// Voice selection MUST prioritize expressiveness over neutrality
const VOICE_CHARACTERISTICS = {
  // ‚úÖ RECOMMENDED - Expressive voices:
  'en-US-Neural2-D': 'Male, warm, storytelling tone',     // Perfect for narration
  'en-US-Neural2-F': 'Female, bright, engaging',          // Great for mindmap
  'en-GB-Neural2-A': 'Male, authoritative, clear',        // Good for grammar
  
  // ‚ö†Ô∏è USE SPARINGLY - Too neutral:
  'en-US-Neural2-E': 'Female, neutral, robotic',          // Only for dictation
  'en-US-Neural2-C': 'Male, flat, emotionless'            // Avoid in story content
};
```

**Blueprint Requirement:** "Gi·ªçng ƒë·ªçc ph·∫£i di·ªÖn c·∫£m (nh∆∞ k·ªÉ chuy·ªán), c√≥ c·∫£m x√∫c vui/bu·ªìn r√µ r√†ng"

#### 0.7.3 Audio Path Standardization

**MANDATORY Naming Convention:**
```javascript
// Week 1-9: NO leading zero
"/audio/week1/vocab_student.mp3"     // ‚úÖ CORRECT
"/audio/week01/vocab_student.mp3"    // ‚ùå WRONG - leading zero

// Week 10+: NO leading zero  
"/audio/week10/vocab_student.mp3"    // ‚úÖ CORRECT
"/audio/week010/vocab_student.mp3"   // ‚ùå WRONG - leading zero

// Easy mode: Add _easy suffix
"/audio/week2_easy/vocab_family.mp3" // ‚úÖ CORRECT
"/audio/week_02_easy/vocab_family.mp3" // ‚ùå WRONG - underscore + zero
```

**File Format Requirements:**
```javascript
// ‚úÖ ONLY .mp3 format allowed (script output):
audio_url: "/audio/week2/dictation_1.mp3"

// ‚ùå NEVER use other formats:
audio_url: "/audio/week2/dictation_1.aiff"  // Scripts don't generate .aiff
audio_url: "/audio/week2/dictation_1.wav"   // Scripts don't generate .wav
audio_url: "/audio/week2/dictation_1.m4a"   // Scripts don't generate .m4a
```

#### 0.7.4 Audio Generation Workflow

**Step 1: Text Validation (Pre-Generation)**
```bash
# Check for underscore sequences that will break TTS
grep -r "___" src/data/weeks/week_XX/
# Must return EMPTY result before audio generation

# Check for other TTS-breaking patterns
grep -r "\.\s*\.\s*\." src/data/weeks/week_XX/  # Scattered dots
grep -r "[a-z][A-Z]" src/data/weeks/week_XX/     # Missing sentence spacing
```

**Step 2: Audio Generation (Official Script)**
```bash
# MANDATORY: Use official script with proper API key loading
node tools/generate_audio.js XX XX

# Script automatically:
# 1. Reads voiceConfig from week data
# 2. Applies prepareTTSText() to all content  
# 3. Generates ~120-130 audio files per mode
# 4. Saves to correct path format (/audio/weekXX/*.mp3)
```

**Step 3: Audio Validation (Post-Generation)**
```bash
# Verify file count matches expected
ls public/audio/weekXX/*.mp3 | wc -l      # Should be ~120-130
ls public/audio/weekXX_easy/*.mp3 | wc -l # Should be ~120-130

# Test critical files for pronunciation quality
# Play mindmap stem audio - should NOT hear "blank" or "underscore"
# Play story audio - should sound natural with proper pauses
```

#### 0.7.5 Quality Assurance Checklist

**Before Every Week Release:**
- [ ] All content passed through prepareTTSText() validation
- [ ] VoiceConfig uses different voices than previous week  
- [ ] Audio paths use correct format (no leading zeros, .mp3 extension)
- [ ] Critical audio files tested for pronunciation quality
- [ ] No "blank" or "underscore" audible in any generated audio

**Common Issues Prevention:**
| Issue | Cause | Prevention |
|-------|-------|------------|
| "Blank" pronunciation | Underscore sequences in text | Use prepareTTSText() ALWAYS |
| Monotone narration | Same voice across all weeks | Rotate voiceConfig weekly |
| Audio files not found | Wrong path format | Follow naming convention exactly |
| Robot-like speech | Chose neutral voices | Prioritize expressive voices |
| No emotional expression | Flat text content | Write engaging, story-like content |

#### 0.7.6 Advanced TTS Features (Optional Enhancement)

**SSML Markup for Emotional Expression:**
```javascript
// For advanced emotional content (Phase 2+ weeks):
const enhancedText = `
  <prosody rate="110%" pitch="+5%">I'm so excited to learn!</prosody>
  <break time="500ms"/>
  <prosody rate="90%" pitch="-5%">But sometimes I feel sad.</prosody>
`;

// Only use if generate_audio.js supports SSML tags
```

**Context-Aware Voice Selection:**
```javascript
// Future enhancement: Auto-select voice based on content type
function getOptimalVoice(contentType, emotion) {
  const voiceMap = {
    'story_happy': 'en-US-Neural2-F',      // Bright female
    'story_sad': 'en-US-Neural2-D',        // Warm male  
    'grammar_explanation': 'en-GB-Neural2-A', // Authoritative
    'vocabulary_drill': 'en-AU-Neural2-B'   // Clear, patient
  };
  return voiceMap[`${contentType}_${emotion}`] || DEFAULT_VOICE;
}
```
- [ ] Each week has unique `voiceConfig` (no default fallback)
- [ ] All 14 data files exist for BOTH advanced and easy modes (see list above)
- [ ] Bridge files exist for BOTH advanced and easy modes (src/data/weeks/week_XX.js and src/data/weeks_easy/week_XX.js)
- [ ] All data/content for the week is generated using `syllabus_database.js` and `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` (not copied from another week)
- [ ] All station content (titles, grammar, vocab, logic, etc.) matches the syllabus and follows blueprint rules for sentence length, scaffolding, morphing, context, and UI/UX
- [ ] All data/content for the week is generated using `syllabus_database.js` and `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` (not copied from another week)
- [ ] All station content (titles, grammar, vocab, logic, etc.) matches the syllabus and follows blueprint rules for sentence length, scaffolding, morphing, context, and UI/UX
- [ ] All cover images are 16:9, full-width, no crop, all content visible
- [ ] All ask_ai prompts have audio and UI plays correct file
- [ ] **All audio, image, and video assets are generated for the week using the asset generation commands above**
- [ ] UI displays images with `w-full h-auto` (no crop)
- [ ] No code changes required for new weeks
- [ ] If any file is missing, asset generation will fail

---

## I. OVERALL INSTRUCTIONS
- **Objective:** Generate a complete set of JS data files for a specific week of the EngQuest curriculum.
- **Modes:** You must generate content for BOTH "Advanced" and "Easy" modes.
- **Source of Truth:** The weekly theme, grammar, and topics are defined in the `syllabus_database.js` file. All generated content must strictly adhere to the syllabus for the given week.
- **Blueprint Adherence:** All content must follow the pedagogical principles outlined in the `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt`, especially regarding "morphing and scaffolding" for vocabulary and sentence structure complexity between Easy and Advanced modes.
- **File Naming:** All generated files must be named correctly (e.g., `read.js`, `vocab.js`) and placed in the correct directory structure: `src/data/weeks/week_XX/` for Advanced and `src/data/weeks_easy/week_XX/` for Easy.
- **CRITICAL - Audio URLs:** Audio URLs are **NOT** stored in the data files. The audio generation script (`create_audio_tasks_only.js`) reads the text content and generates audio files automatically. Only `image_url` fields are included in the data.

### I.1 CONTEXT REQUIREMENTS (MANDATORY)
**Blueprint requirement:** "Lu√¥n c√≥ context (ng·ªØ c·∫£nh) cho c√°c c√¢u h·ªèi, theo ƒë√∫ng vƒÉn phong b·∫£n x·ª©"

All questions, prompts, and exercises MUST follow natural native-speaker storytelling format with rich context. NEVER use bare academic formats. This is CRITICAL for ESL learners to understand language in authentic situations.

#### 1. **Logic Puzzles (logic.js):**
- ‚úÖ **CORRECT:** "Tom had 5 apples in his backpack. At lunch, he gave 2 apples to his sister Mary because she forgot her snack. How many apples does Tom have now?"
  - Character names: Tom, Mary
  - Situation: School lunch, sharing
  - Details: backpack, forgot snack (relatable)
  - Word count: 28 words (meets 30-50 target)
  
- ‚ùå **WRONG:** "5 - 2 = ?" or "Tom has 5 apples. He gives away 2. How many left?"
  - No context or character details
  - Sounds like a math drill, not a story
  
- **Requirements:**
  - Use character names (Tom, Alex, Maria, etc.)
  - Create relatable situations (sharing food, playing games, organizing toys)
  - Minimum 30-50 words per puzzle
  - Include sensory/emotional details ("excited", "carefully counted", "happily shared")
  - Follow Blueprint math language patterns (see Section IV.7)

#### 2. **Ask AI Prompts (ask_ai.js):**
- ‚úÖ **CORRECT:** "You are sitting with your grandparents, looking through an old photo album. The pictures are black and white, and the paper feels soft and fragile. Your parents look so young in the photos‚Äîalmost like kids! Some pictures show places that don't exist anymore, like your grandpa's old school. You feel curious about their stories..."
  - Scenario: Looking at photos with grandparents
  - Sensory details: black and white, soft paper, fragile
  - Emotional context: curious, nostalgic
  - Word count: 62 words
  
- ‚ùå **WRONG:** "What are old photos like?" or "Ask AI about memories from the past."
  - Direct question format (not a scenario)
  - No immersion or context
  
- **Requirements:**
  - Provide scenario/situation, NOT direct questions
  - Set the scene with sensory details (see, hear, touch, feel)
  - Minimum 30-50 words per prompt
  - Use second-person "You" perspective to immerse student
  - Student should naturally want to ask questions after reading the context

#### 3. **Dictation & Shadowing (dictation.js, shadowing.js):**
- **Requirements:**
  - Minimum 5 words per sentence
  - MUST be extracted DIRECTLY from read.js story (NOT new sentences)
  - EXACT SAME sentences for BOTH dictation and shadowing
  - Typically 8 sentences total (can be 6-10 depending on story length)
  - Shadowing MUST include:
    - `audio_url` field for each sentence (e.g., `shadowing_1.mp3`)
    - `audio_full` field for complete passage (e.g., `shadowing_full.mp3`)
  - Sentences should be complete thoughts, not fragments
  
- **Example (from Week 19 read.js):**
  ```javascript
  // dictation.js AND shadowing.js use SAME 8 sentences:
  { id: 1, text: "When I was young, my town was very quiet.", ... },
  { id: 2, text: "There were no big buildings or busy streets.", ... },
  // ... 6 more sentences from the story
  ```

#### 4. **Grammar Exercises (grammar.js):**
- **Requirements:**
  - Use context similar to read.js story structure
  - Embed grammar in meaningful sentences, NOT bare drills
  - Each sentence should be a complete thought with context
  - Target grammar structure should be natural, not forced
  
- ‚úÖ **CORRECT:** "When I was young, I ___ very curious about everything." (was/were focus, relates to childhood theme)
- ‚ùå **WRONG:** "I ___ happy. She ___ tired. They ___ friends." (no context, disconnected drills)
  
- **Example set (Week 19 - Past Simple: was/were):**
  ```javascript
  { id: 1, question: "My town ___ very different in the past.", options: ["was", "were"], answer: "was" },
  { id: 2, question: "There ___ many trees near my house.", options: ["was", "were"], answer: "were" },
  // All 20 questions relate to Week 19 theme (Looking Back)
  ```

#### 5. **Read & Explore (read.js, explore.js):**
- **Bold Words Requirement:**
  - EXACTLY 10 bold words per passage
  - Use SINGLE asterisk syntax: `*word*` (not `**word**`)
  - Words should be scattered naturally throughout text
  - Bold words = core vocabulary from week's vocab list
  
- **Comprehension Questions:**
  - read.js: 3 `comprehension_questions` (NOT `check_questions`)
  - explore.js: 3 `check_questions` (factual) + 1 `question` object (open-ended)
  - Each question must have `answer` array (multiple acceptable answers)
  - Include `hint_en` and `hint_vi` for scaffolding

---

**WHY CONTEXT MATTERS:**
Blueprint states ESL learners need authentic language situations to:
1. Understand words/grammar in real-world usage
2. Build mental models of when/how to use language
3. Stay engaged through storytelling (not drills)
4. Develop natural fluency (not just accuracy)

---

## II. STATION-BY-STATION DATA SCHEMA

### 1. `read.js`
- **Description:** The main story for the week. **CRITICAL: MUST have EXACTLY 10 bold words + 3 comprehension questions**
- **Schema:**
  ```javascript
  export default {
    title: "Story Title",
    image_url: "/images/weekXX/read_cover_wXX.jpg",
    content_en: "Story text in English (~100-150 words). **MUST** have **EXACTLY** **10** **bold** **words** scattered **naturally** throughout the **text** using *word* syntax (SINGLE asterisk, NOT double).",
    content_vi: "B·∫£n d·ªãch ti·∫øng Vi·ªát c·ªßa c√¢u chuy·ªán.",
    audio_url: null, // Audio is auto-generated, set to null in data
    comprehension_questions: [ // MANDATORY: EXACTLY 3 questions
      { id: 1, question_en: "Question 1?", answer: ["Answer 1", "Alt answer"], hint_en: "Hint 1", hint_vi: "G·ª£i √Ω 1" },
      { id: 2, question_en: "Question 2?", answer: ["Answer 2"], hint_en: "Hint 2", hint_vi: "G·ª£i √Ω 2" },
      { id: 3, question_en: "Question 3?", answer: ["Answer 3"], hint_en: "Hint 3", hint_vi: "G·ª£i √Ω 3" }
    ]
  };
  ```
- **Note:** Audio `read_main.mp3` is auto-generated from `content_en`.

### 2. `explore.js`
- **Description:** A non-fiction article on a global theme. **CRITICAL: MUST have EXACTLY 10 bold words + 3 check questions + 1 open-ended question**
- **Schema:**
  ```javascript
  export default {
    title_en: "Article Title",
    title_vi: "Ti√™u ƒë·ªÅ ti·∫øng Vi·ªát",
    image_url: "/images/weekXX/explore_cover_wXX.jpg",
    content_en: "Article text in English (~120-180 words). **MUST** have **EXACTLY** **10** **bold** **words** scattered **naturally** throughout using *word* syntax (SINGLE asterisk, NOT double).",
    content_vi: "B·∫£n d·ªãch ti·∫øng Vi·ªát.",
    check_questions: [ // MANDATORY: EXACTLY 3 factual questions
      { id: 1, question_en: "Factual Question 1?", answer: ["Answer 1", "Alt"], hint_en: "Hint...", hint_vi: "G·ª£i √Ω..." },
      { id: 2, question_en: "Factual Question 2?", answer: ["Answer 2"], hint_en: "Hint...", hint_vi: "G·ª£i √Ω..." },
      { id: 3, question_en: "Factual Question 3?", answer: ["Answer 3"], hint_en: "Hint...", hint_vi: "G·ª£i √Ω..." }
    ],
    question: { // MANDATORY: 1 open-ended critical thinking question
      text_en: "Open-ended critical thinking question?",
      text_vi: "C√¢u h·ªèi t∆∞ duy ti·∫øng Vi·ªát?",
      min_words: 20,
      hint_en: "I would like to...",
      hint_vi: "T√¥i mu·ªën..."
    }
  };
  ```
- **Note:** Audio `explore_main.mp3` is auto-generated from `content_en`.

### 3. `vocab.js` (New Words)
- **Description:** Object containing array of 10 core vocabulary words.
- **Schema:**
  ```javascript
  export default {
    vocab: [
      {
        id: 1,
        word: "vocabulary_word",
        pronunciation: "/pr…ôÀån ånsiÀàe…™ É…ôn/",
        definition_en: "English definition of the word.",
        definition_vi: "Nghƒ©a ti·∫øng Vi·ªát c·ªßa t·ª´.",
        example: "An example sentence using the word.",
        collocation: "A common phrase using the word.",
        image_url: "/images/weekXX/[word].jpg"
      },
      // ... 10 items total
    ]
  };
  ```
- **Image naming:** `[word].jpg` (no prefix, e.g., `archaeologist.jpg`)
- **Audio Generated (4 per word, 40 total):**
  - `vocab_[word].mp3` - from `word`
  - `vocab_def_[word].mp3` - from `definition_en`
  - `vocab_ex_[word].mp3` - from `example`
  - `vocab_coll_[word].mp3` - from `collocation`

### 4. `word_power.js`
- **Description:** Object containing array of phrasal verbs/collocations with PHASE-BASED COUNT.
- **CRITICAL Phase Morphing (Blueprint requirement):**
  
  **Phase 1 (Weeks 1-54): 3 Simple Collocations**
  - Count: EXACTLY 3 items per week
  - Type: Simple verb-noun collocations (e.g., "do homework", "take notes", "pay attention")
  - Audio: 12 files (3 words √ó 4 each: word, def, ex, model)
  
  **Phase 2 (Weeks 55-120): 5 Synonyms/Antonyms**
  - Count: EXACTLY 5 items per week
  - Type: Synonym pairs or antonym pairs (e.g., "big = huge", "small >< tiny", "happy = joyful")
  - Audio: 20 files (5 words √ó 4 each)
  
  **Phase 3 (Weeks 121+): 7 Idioms/Phrasal Verbs**
  - Count: EXACTLY 7 items per week
  - Type: Academic idioms and phrasal verbs (e.g., "figure out", "point out", "break down")
  - Audio: 28 files (7 words √ó 4 each)
  
- **Audio per item:** 4 files (word, def, example, model_sentence)
- **Total audio impact:** Phase 1 = 12 files, Phase 2 = 20 files, Phase 3 = 28 files per week

- **‚ö†Ô∏è REQUIRED FIELDS (Must Include All):**
  - `id` - Sequential number (1, 2, 3...)
  - `word` - Collocation phrase (string)
  - `pronunciation` - IPA format (e.g., "/duÀê Ààho ämw…úÀêrk/")
  - `cefr_level` - CEFR level ("A1", "A2", "B1")
  - `definition_en` - English definition (string)
  - `definition_vi` - Vietnamese definition (string)
  - `example` - English example sentence ONLY (NO _en suffix, NO _vi field)
  - `model_sentence` - English model sentence ONLY (NO _en suffix, NO _vi field)
  - `collocation` - Common usage pattern (string)
  - `image_url` - Path to image (string)

- **‚ùå FORBIDDEN FIELDS (Do NOT Include):**
  - `example_en`, `example_vi` - Use `example` only (English text)
  - `model_sentence_en`, `model_sentence_vi` - Use `model_sentence` only (English text)
  - `audio_word`, `audio_def`, `audio_ex`, `audio_model` - Script auto-generates these

- **Schema (CORRECT FORMAT):**
  ```javascript
  export default {
    words: [
      {
        id: 1,                    // ‚úÖ REQUIRED
        word: "do homework",       // ‚úÖ REQUIRED
        pronunciation: "/duÀê Ààho ämw…úÀêrk/",  // ‚úÖ REQUIRED
        cefr_level: "A2",         // ‚úÖ REQUIRED
        definition_en: "Complete school assignments at home.",  // ‚úÖ REQUIRED
        definition_vi: "Ho√†n th√†nh b√†i t·∫≠p ·ªü nh√†.",  // ‚úÖ REQUIRED
        example: "I do my homework after dinner.",  // ‚úÖ CORRECT (no _en suffix)
        model_sentence: "Every night, I do my homework before bed.",  // ‚úÖ CORRECT
        collocation: "do your homework",  // ‚úÖ REQUIRED
        image_url: "/images/week1/wordpower_do_homework.jpg"  // ‚úÖ REQUIRED
      },
      // ... 3 items total for Phase 1
    ]
  };
  ```
- **Image naming:** `wordpower_[word].jpg` (e.g., `wordpower_do_homework.jpg`)
- **Audio Generated (4 per word, 12 total - script auto-injects paths):**
  - `wordpower_[word].mp3` - from `word`
  - `wordpower_def_[word].mp3` - from `definition_en`
  - `wordpower_ex_[word].mp3` - from `example`
  - `wordpower_model_[word].mp3` - from `model_sentence`

### 5. `daily_watch.js`
- **Description:** EXACTLY 5 curated YouTube videos per week (both Advanced and Easy modes).
- **CRITICAL:** Blueprint requires "T·ªëi thi·ªÉu 5 videos per week". Advanced and Easy modes share same videos.
- **Video Types:**
  1. **GRAMMAR** (1-2 videos): Must match week's grammar focus
  2. **TOPIC** (1-2 videos): Related to week's theme
  3. **SCIENCE/CLIL** (1-2 videos): Science/social studies content
- **Schema:**
  ```javascript
  export default {
    videos: [
      { 
        id: 1, 
        title: "Video Title from YouTube", 
        videoId: "youtube_video_id", 
        duration: "MM:SS", 
        sim_duration: seconds_as_number,
        thumb: "https://img.youtube.com/vi/[videoId]/mqdefault.jpg"
      },
      // ... EXACTLY 5 items total
    ],
    bonus_games: [{title: "Game", url: "#", description: "Review"}]
  };
  ```
- **Video Generation:** Use `tools/update_videos.js <WEEK_ID>` which reads from `video_queries.json` and searches YouTube API.
- **Important:** Each week must have `video_queries.json` file with 5 search queries (1 grammar + 2 topic + 2 science/clil).

### 6. `grammar.js`
- **Description:** Object with grammar explanation and 20 exercises (mixed types: mc, fill, unscramble).
- **Schema:**
  ```javascript
  export default {
    grammar_explanation: {
      title_en: "Grammar Point Title",
      title_vi: "Ti√™u ƒë·ªÅ ti·∫øng Vi·ªát",
      rules: [
        { type: "rule", icon: "1Ô∏è‚É£", rule_en: "Rule in English.", rule_vi: "Quy t·∫Øc ti·∫øng Vi·ªát." },
        { type: "rule", icon: "2Ô∏è‚É£", rule_en: "Rule 2 in English.", rule_vi: "Quy t·∫Øc 2 ti·∫øng Vi·ªát." }
      ]
    },
    exercises: [
      { id: 1, type: "mc", question: "Sentence with ___ blank.", options: ["a", "b"], answer: "a", hint: "Hint" },
      { id: 2, type: "fill", question: "Sentence with _____ (verb) blank.", answer: "was", hint: "Singular" },
      { id: 3, type: "unscramble", question: "Order:", words: ["word1", "word2", "word3"], answer: "word1 word2 word3.", hint: "S + V..." },
      // ... EXACTLY 20 exercises total (mix of mc, fill, unscramble)
    ]
  };
  ```
- **CRITICAL:** **Grammar exercises do NOT generate audio files.** This station is text-only interactive exercises. Audio count = 0.

### 6. `logic.js` (NOT logic_lab.js)
- **Description:** Object containing array of 5 contextual word problems for Logic Lab. 
- **CRITICAL CONTEXT REQUIREMENTS (Blueprint: "Lu√¥n c√≥ context cho c√°c c√¢u h·ªèi"):**
  - ‚úÖ **CORRECT:** "Tom had 5 apples. He gave 2 to his sister. How many does Tom have now?" (Character + scenario + narrative)
  - ‚ùå **WRONG:** "5 - 2 = ?" (Bare math, no context)
  - Every puzzle MUST use storytelling format with character names and situations (30-50 words)
- **Phase Morphing:**
  - Phase 1: 5 puzzles
  - Phase 2: 7 puzzles
  - Phase 3: 10 puzzles
- **Schema:**
  ```javascript
  export default {
    puzzles: [
      {
        id: 1,
        type: "logic", // or "math", "mc", "pattern"
        title_en: "Problem Title in English", // Descriptive title (e.g., "Birthday Candles")
        title_vi: "Ti√™u ƒë·ªÅ b√†i to√°n ti·∫øng Vi·ªát",
        question_en: "Last year, Tom was 7 years old. He had 7 candles on his cake. This year, how many candles will he have?", // RICH CONTEXT (30-50 words)
        question_vi: "NƒÉm ngo√°i, Tom 7 tu·ªïi. C·∫≠u ·∫•y c√≥ 7 ng·ªçn n·∫øn tr√™n b√°nh. NƒÉm nay, c·∫≠u ·∫•y s·∫Ω c√≥ bao nhi√™u ng·ªçn n·∫øn?",
        options: ["Option 1", "Option 2", "Option 3"], // optional, for mc type
        answer: ["Correct Answer", "Alternative answer"], // array of acceptable answers
        target_number: 5, // optional, for numeric problems
        unit: "apples", // optional, for counting problems
        hint_en: "A hint for solving.",
        hint_vi: "G·ª£i √Ω ti·∫øng Vi·ªát."
      },
      // ... 5 items total
    ]
  };
  ```
- **Audio Generated:** `logic_[id].mp3` - from `question_en` (5 audio files)

### 7. `ask_ai.js`
- **Description:** Object containing array of 5 scenarios to prompt student questions.
- **CRITICAL CONTEXT REQUIREMENTS (Blueprint: "Must provide scenario/situation"):**
  - ‚úÖ **CORRECT:** "You are looking at your parents' old wedding photo. The picture is in black and white, and your parents look very young. You want to know about that day." (30-50 words rich scenario)
  - ‚ùå **WRONG:** "What are old photos like?" (Direct question, no context)
  - Each context_en MUST be 30-50 words describing a situation student experiences, NOT asking direct questions
- **Schema:**
  ```javascript
  export default {
    prompts: [
      {
        id: 1,
        context_en: "You are looking at your parents' old wedding photo. The picture is in black and white, and your parents look very young. You want to know about that day.", // RICH SCENARIO (30-50 words)
        context_vi: "B·∫°n ƒëang xem ·∫£nh c∆∞·ªõi c≈© c·ªßa b·ªë m·∫π. B·ª©c ·∫£nh ƒëen tr·∫Øng, v√† b·ªë m·∫π tr√¥ng r·∫•t tr·∫ª. B·∫°n mu·ªën bi·∫øt v·ªÅ ng√†y h√¥m ƒë√≥.",
        answer: ["How old were you?", "What was the weather like?", "Were you happy?"], // Example questions student might ask
        hint: "How old... / What was..."
      },
      // ... EXACTLY 5 items total
    ]
  };
  ```
- **Audio Generated:** `ask_ai_[id].mp3` - from `context_en` (5 audio files)

### 8. `dictation.js`
- **Description:** Object containing array of sentences for dictation (SAME as shadowing count, copied from read.js content).
- **IMPORTANT:** Dictation sentences = Shadowing sentences (both copied from `read.js` story).
- **Schema:**
  ```javascript
  export default {
    sentences: [
      { 
        id: 1, 
        text: "Sentence 1 from the read.js story.", 
        meaning: "Nghƒ©a ti·∫øng Vi·ªát c·ªßa c√¢u."
      },
      // ... 8-10 items total (SAME count as shadowing)
    ]
  };
  ```
- **Audio Generated:** `dictation_[id].mp3` - from `text`

### 9. `shadowing.js`
- **Description:** 8-10 conversational sentences for pronunciation practice (COPIED from `read.js` story).
- **IMPORTANT:** Shadowing sentences = Dictation sentences = read.js content split into sentences.
- **Schema:**
  ```javascript
  export default {
    title: "Same as read.js title",
    audio_full: "/audio/weekXX/shadowing_full.mp3", // Full audio for all sentences
    script: [
      { id: 1, text: "Sentence 1 from read.js.", vi: "B·∫£n d·ªãch ti·∫øng Vi·ªát.", audio_url: "/audio/weekXX/shadowing_1.mp3" },
      // ... 8-10 items total (SAME count as dictation)
    ]
  };
  ```
- **CRITICAL:** Each sentence MUST have `audio_url` field for individual playback.
- **Audio Generated:** `shadowing_[id].mp3` - from each `script[].text` + `shadowing_full.mp3` for full audio

### 10. `mindmap.js`
- **Description:** Data for the Mindmap Speaking activity (6 stems √ó 6 branches = 42 audio).
- **CRITICAL STRUCTURE:** `branchLabels` is a **NESTED OBJECT**, NOT a flat array!

- **‚úÖ CORRECT Structure (Week 19 example):**
  ```javascript
  export default {
    centerStems: [
      "When I was young, I ___.",
      "My favorite memory was ___.",
      "There was a place where I ___.",
      "My family was ___.",
      "I was happy because ___.",
      "In the past, life was ___."
    ],
    branchLabels: {
      "When I was young, I ___.": [
        "played with my friends",
        "lived in a small house",
        "went to kindergarten",
        "loved my toys",
        "was very curious",
        "had a pet dog"
      ],
      "My favorite memory was ___.": [
        "my birthday party",
        "playing in the rain",
        "going to the beach",
        "visiting grandma's house",
        "my first day of school",
        "learning to ride a bike"
      ],
      // ... 4 more stems (6 total)
    }
  };
  ```

- **‚ùå WRONG Structure (DO NOT USE):**
  ```javascript
  // This is INCORRECT - flat array format
  branchLabels: [
    { id: 1, text_en: "played with my friends", ... },
    { id: 2, text_en: "lived in a small house", ... }
  ]
  ```

- **Structure Rules:**
  1. `centerStems`: Simple array of 6 sentence starter strings
  2. `branchLabels`: Object where:
     - **Keys** = exact text from `centerStems` (including trailing punctuation like `___.`)
     - **Values** = array of 6 completion strings per stem
  3. Each stem MUST have exactly 6 branches
  4. Total branches = 36 (6 stems √ó 6 branches)

- **Audio Generated:**
  - `mindmap_stem_[1-6].mp3` - from each centerStems item (6 files)
  - `mindmap_branch_[1-36].mp3` - from branches **SEQUENTIALLY numbered 1-36**
  - **Total: 42 audio files**

- **Audio Naming CRITICAL:** 
  - Branches numbered SEQUENTIALLY across ALL stems, NOT nested per stem
  - Week 19 example: Stem 1 branches = 1-6, Stem 2 branches = 7-12, Stem 3 = 13-18, etc.
  - `generate_audio.js` handles this automatically by flattening the nested structure

### 11. `word_match.js`
- **Description:** A single writing prompt.
- **Schema:**
  ```javascript
  export default {
    title: "Writing Activity Title",
    min_words: 40,
    model_sentence: "A model paragraph showing good writing...",
    instruction_en: "Clear instructions for the writing task.",
    instruction_vi: "H∆∞·ªõng d·∫´n ti·∫øng Vi·ªát.",
    prompt_en: "Question prompts to guide the writing.",
    prompt_vi: "C√¢u h·ªèi g·ª£i √Ω ti·∫øng Vi·ªát.",
    keywords: ["keyword1", "keyword2", "keyword3", "keyword4", "keyword5"]
  };
  ```
- **Note:** No audio generated for this station.

### 13. `word_match.js`
- **Description:** Placeholder for word matching game (uses vocab data).
- **Schema:**
  ```javascript
  export default { pairs: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] };
  ```

### 14. `index.js` (Required for each week folder)
- **Description:** Main index file that imports and exports all station data.
- **Schema:**
  ```javascript
  import read from './read.js';
  import vocab from './vocab.js';
  import grammar from './grammar.js';
  import ask_ai from './ask_ai.js';
  import logic from './logic.js';
  import dictation from './dictation.js';
  import shadowing from './shadowing.js';
  import writing from './writing.js';
  import explore from './explore.js';
  import word_power from './word_power.js';
  import daily_watch from './daily_watch.js';
  import word_match from './word_match.js';
  import mindmap from './mindmap.js';

  const weekData = {
    weekId: XX,
    weekTitle_en: "Week Title in English",
    weekTitle_vi: "Ti√™u ƒë·ªÅ tu·∫ßn ti·∫øng Vi·ªát",
    grammar_focus: "Grammar Point",
    global_vocab: vocab.vocab,
    stations: {
      read_explore: read,
      new_words: vocab,
      word_match: word_match,
      grammar: grammar,
      ask_ai: ask_ai,
      logic_lab: logic,
      dictation: dictation,
      shadowing: shadowing,
      video: writing,
      writing: writing,
      explore: explore,
      word_power: word_power,
      daily_watch: daily_watch,
      mindmap_speaking: mindmap
    }
  };
  export default weekData;
  ```

---

## III. ASSET SUMMARY

### Audio Files (VARIABLE count per week - auto-generated by Google TTS)

**CRITICAL:** Audio count is NOT fixed - depends on week content per Blueprint morphing rules.

---

#### Recent Critical Fixes (Dec 31, 2025)

**Fix 1: Language Code Bug (Line 83-105)**
- **Old Bug:** Hardcoded `languageCode: "en-US"` for all voices
- **Impact:** Voices like `en-AU-Neural2-B` and `en-GB-Neural2-A` failed with 400 error
- **Fix:** Dynamic extraction from voiceName prefix
```javascript
const getLanguageCodeFromVoice = (voiceName) => {
  if (voiceName.startsWith('en-AU')) return 'en-AU';
  if (voiceName.startsWith('en-GB')) return 'en-GB';
  return 'en-US';
};
voice: { languageCode: getLanguageCodeFromVoice(voiceName), name: voiceName }
```
- **Verified:** Week 1 Easy generated 136 files with no errors

**Fix 2: Mindmap Branches Object Iteration (Line 275-295)**
- **Old Bug:** Treated `branchLabels` as array, only generated 6 stem audio
- **Impact:** Missing 36 branch audio files per week
- **Fix:** Iterate through object keys to extract all branches
```javascript
if (mindmapData?.branchLabels && typeof mindmapData.branchLabels === 'object') {
  let branchCounter = 0;
  Object.values(mindmapData.branchLabels).forEach(branchArray => {
    if (Array.isArray(branchArray)) {
      branchArray.forEach(branch => {
        branchCounter++;
        addTask(branch, `mindmap_branch_${branchCounter}`, voices.mindmap);
      });
    }
  });
}
```
- **Verified:** Week 1 Easy now generates 42 mindmap files (6 stems + 36 branches)

---

#### How generate_audio.js Works

1. Loads week data from `src/data/weeks/week_XX/index.js`
2. Scans ALL stations for text content that needs audio
3. Generates audio ONLY for fields that exist (skips missing optional fields)
4. Uses week-specific `voiceConfig` if present, otherwise uses global defaults
5. Saves MP3 files to `public/audio/weekXX/` (or `weekXX_easy/` for Easy mode)

---

#### Audio Count Formula

**Base formula (Phase 1, weeks 1-54):**
```
read: 1 (read_explore_main.mp3)
explore: 1 (explore_main.mp3)
vocab: 40 (10 words √ó 4 each: word, def, ex, coll)
word_power: 12 (3 words √ó 4 each: word, def, ex, model) *Phase 1: EXACTLY 3*
dictation: 8 (8 sentences from read.js)
shadowing: 9 (8 sentences + 1 full audio)
logic: 5 (5 puzzles) *Phase 1 only*
ask_ai: 5 (5 prompts)
mindmap: 42 (6 stems + 36 branches) *FIXED after Dec 31 fix*
---
BASE TOTAL: ~123 files (Phase 1)
```

**Phase Morphing (affects count):**
- **word_power:** Phase 1 = 12 files (3√ó4), Phase 2 = 20 files (5√ó4), Phase 3 = 28 files (7√ó4)
- **logic:** Phase 1 = 5 files, Phase 2 = 7 files, Phase 3 = 10 files
- **dictation/shadowing:** Varies by story length (typically 8, can be 6-10)

**Variable factors (+/- files):**
- `vocab[].collocation` optional ‚Üí ¬±10 files (if missing)
- `word_power[].model_sentence` optional ‚Üí ¬±3-7 files (if missing)
- Dictation/shadowing count varies by story ‚Üí ¬±2-4 files
- Grammar examples audio: 0-16 files (week-specific, rare)

**Typical ranges:**
- Phase 1 (weeks 1-54): 120-135 files per mode
- Phase 2 (weeks 55-120): 130-145 files per mode (more word_power + logic)
- Phase 3 (weeks 121+): 135-155 files per mode (max word_power + logic)

---

#### Example: Week 1 Easy (After Fixes - Dec 31, 2025)

**Total: 126 audio files**

| Station | Count | Naming Pattern |
|---------|-------|----------------|
| read | 1 | `read_explore_main.mp3` |
| explore | 1 | `explore_main.mp3` |
| vocab | 40 | `vocab_[word].mp3`, `vocab_def_[word].mp3`, `vocab_ex_[word].mp3`, `vocab_coll_[word].mp3` |
| word_power | 12 | `wordpower_[word].mp3`, `wordpower_def_[word].mp3`, `wordpower_ex_[word].mp3`, `wordpower_model_[word].mp3` *(3 items)* |
| dictation | 8 | `dictation_[1-8].mp3` |
| shadowing | 9 | `shadowing_[1-8].mp3` + `shadowing_full.mp3` |
| mindmap | 42 | `mindmap_stem_[1-6].mp3`, `mindmap_branch_[1-36].mp3` *(FIXED)* |
| logic | 5 | `logic_[1-5].mp3` |
| ask_ai | 5 | `ask_ai_[1-5].mp3` |
| grammar | 3 | `grammar_ex_[1-3].mp3` |
| **TOTAL** | **126** | |

---

#### Generation Command

```bash
node tools/generate_audio.js <START_WEEK> <END_WEEK>
# Auto-loads Google TTS API key from API keys.txt
# Generates audio for both Advanced and Easy modes
# Example: node tools/generate_audio.js 1 10
```

**Cost:** Free (Google TTS free tier: 1M characters/month)

---
# Generates all audio for both Advanced and Easy modes
```

### Image Files (FIXED 15 per mode - 2 Generation Methods)

**CRITICAL:** Image count is FIXED at 15 per mode in Phase 1 (weeks 1-54).

---

#### Method A: Imagen 3 (Paid - Batch Recommended for Advanced Mode)

**Script:** `tools/batch_manager.js <START_WEEK> <END_WEEK>`
**Model:** `imagen-3.0-generate-001` (configurable line 14)
**Cost:** $0.02/image √ó 15 = $0.30/week/mode
**Use Case:** Advanced mode, multi-week batch generation

**How batch_manager.js works:**
1. Loads week data from `src/data/weeks/week_XX/index.js`
2. Extracts image requirements:
   - 2 cover images (read + explore) from titles/content
   - 10 vocab images from `new_words.vocab[]`
   - 3 word_power images from `word_power.words[]` (Phase 1 only)
3. Generates educational illustration prompts for each image
4. Calls Gemini Imagen API (aspect ratios: Covers `16:9`, Vocab/Word Power `1:1`)
   - **Skip-exists:** Checks if image already generated to prevent duplicates
5. Saves JPG files to `public/images/weekXX/` (or `weekXX_easy/`)

**Generation command:**
```bash
node tools/batch_manager.js <START_WEEK> <END_WEEK>
# Auto-loads Gemini API key from API keys.txt
# Generates 15 images for both Advanced and Easy modes
# Example: node tools/batch_manager.js 1 10
```

---

#### Method B: Nano Banana (Free - Recommended for Easy Mode)

**Script:** `tools/generate_weekX_easy_images.js` (custom per week)
**Model:** `gemini-3-pro-image-preview` (Gemini free tier)
**Cost:** $0.00 (free tier)
**Quality:** 1024√ó1024 JPEG, ~500-700KB/image, sufficient for ESL vocab
**Use Case:** Easy mode only, per-week generation
**Savings:** $43.20 for 144 Easy mode weeks

**Template:** Copy from `tools/generate_week1_easy_images.js`

**How to create per-week script:**
1. Copy: `cp tools/generate_week1_easy_images.js tools/generate_weekX_easy_images.js`
2. Update vocab words array (10 items from Easy mode vocab.js)
3. Update word_power phrases array (3 items from Easy mode word_power.js)
4. Update output directory: `public/images/weekX_easy`
5. Run: `node tools/generate_weekX_easy_images.js`

**Example script structure:**
```javascript
const VOCAB_WORDS = [
  { word: 'name', prompt: 'Simple educational illustration of a name tag...' },
  { word: 'friend', prompt: 'Simple educational illustration of two children...' },
  // ... 10 vocab words
];

const WORDPOWER_PHRASES = [
  { word: 'wordpower_my_friend', prompt: 'Simple educational illustration...' },
  // ... 3 word_power phrases
];

// Uses: gemini-3-pro-image-preview model
// Auto-loads API key from API keys.txt
// Rate limit: 3 seconds between requests
```

**Verified Results (Week 1 Easy - Dec 31, 2025):**
```
‚úÖ 15/15 images generated successfully
‚úÖ friend.jpg: 681 KB, 1024√ó1024
‚úÖ desk.jpg: 501 KB, 1024√ó1024
‚úÖ Total size: 11MB for 15 images
‚úÖ Time: ~45 seconds (3 sec/image)
‚úÖ Cost: $0.00
```

---

#### Image Naming Convention (Both Methods)

| Station | Count | Naming Pattern | Aspect Ratio |
|---------|-------|----------------|-------------|
| read | 1 | `read_cover_wXX.jpg` (e.g., `read_cover_w19.jpg`) | 16:9 |
| explore | 1 | `explore_cover_wXX.jpg` (e.g., `explore_cover_w19.jpg`) | 16:9 |
| vocab | 10 | `[word].jpg` (lowercase, underscore for spaces, e.g., `archaeologist.jpg`) | 1:1 |
| word_power | 3 | `wordpower_[word].jpg` (WITH prefix, e.g., `wordpower_artifact.jpg`) | 1:1 |
| **TOTAL** | **15** | | |

**Cover Image Prompt Template:**
```
Wide landscape educational illustration for [title]. 
Context: [first 100 chars of content]. 
Render as a full-width 16:9 banner, show all content, 
do not crop any part, all important details must be 
visible within the frame. Child-friendly, colorful, ESL.
```

**Vocab/Word Power Prompt Template:**
```
Simple educational illustration of [word]: [definition]. 
Child-friendly, clear, colorful, suitable for ESL vocabulary learning.
```

---

#### Mass Production Strategy (144 Weeks)

**Recommended Hybrid Approach:**
```bash
# Easy Mode: Nano Banana (Free)
for week in {1..144}; do
  node tools/generate_week${week}_easy_images.js
done
# Cost: $0.00

# Advanced Mode: Imagen 3 (Batch)
node tools/batch_manager.js 1 144
# Cost: $43.20 (144 √ó $0.30)

# Total Cost: $43.20
# Savings: $43.20 (50% vs all-Imagen approach)
```

---

**Phase Impact on Images:**
- Phase 1 (weeks 1-54): 15 images (3 word_power)
- Phase 2 (weeks 55-120): 17 images (5 word_power) ‚Üê Count increases
- Phase 3 (weeks 121+): 19 images (7 word_power) ‚Üê Count increases

**Note:** Despite phase morphing, base requirement is 15 images for Phase 1.

---

## IV. FINAL CHECKLIST
- [ ] Generated files for ALL 14 stations for BOTH Easy and Advanced modes?
- [ ] Created `index.js` file that imports and exports all stations?
- [ ] Content strictly follows the `syllabus` for the target week?
- [ ] Vocabulary and sentence complexity adheres to the `blueprint` for each mode?
  - Easy: Simple S-V-O sentences with "and/but" connectors
  - Advanced: Compound sentences, vocabulary one CEFR level higher
- [ ] All `image_url` paths are correctly formatted placeholders?
- [ ] **NO** `audio_url` fields in the data files (audio is auto-generated)?
- [ ] All data wrapped in correct object structure (`{ vocab: [...] }`, `{ words: [...] }`, etc.)?

**STATION-SPECIFIC CHECKS:**
- [ ] **read.js:** EXACTLY 10 bold words using `**word**` syntax (DOUBLE asterisk) + 8-12 sentences (Advanced) or 6-8 (Easy) + 3 comprehension_questions?
  - ‚ö†Ô∏è VALIDATION: Count sentences by splitting on period (.) - if wrong, REGENERATE content!
- [ ] **explore.js:** EXACTLY 10 bold words using `**word**` syntax (DOUBLE asterisk) + 8-12 sentences (Advanced) or 6-8 (Easy) + 3 check_questions + 1 open-ended question object?
  - ‚ö†Ô∏è VALIDATION: Count sentences - if wrong, REGENERATE content before proceeding!
- [ ] **vocab:** Exactly 10 words with all required fields (word, definition_en/vi, example, collocation, image_url)?
- [ ] **word_power:** Exactly 3 items for Phase 1 (5 for Phase 2, 7 for Phase 3)?
- [ ] **grammar.js:** EXACTLY 20 exercises (mix of mc, fill, unscramble)? **NO AUDIO generated for this station**
- [ ] **logic.js:** EXACTLY 5 puzzles with RICH CONTEXT (30-50 words storytelling, NOT bare math)?
- [ ] **ask_ai.js:** EXACTLY 5 prompts with RICH SCENARIOS (30-50 words context_en, NOT direct questions)?
- [ ] **dictation.js:** ALL sentences from read.js story (no omissions, split by periods)?
- [ ] **shadowing.js:** SAME 8 sentences as dictation (EXACT same text field)?
- [ ] **mindmap.js:** 6 stems + NESTED OBJECT branchLabels with 6 branches per stem (NOT flat array)?
- [ ] **daily_watch.js:** EXACTLY 5 videos (MANDATORY) with videoId field?

---

## V. GENERATION COMMANDS (After data files created)
```bash
# 1. Generate audio tasks
node tools/create_audio_tasks_only.js [WEEK_NUM] [WEEK_NUM]

# 2. Generate audio files (requires OPENAI_API_KEY)
export OPENAI_API_KEY="your-key-here"
python3 tools/generate_audio.py --provider openai --voice "nova"
```

---

## VI. WEEK 19 AS REFERENCE TEMPLATE (MANDATORY)

### Why Week 19?
Week 19 is the **GOLD STANDARD** for all new weeks. It contains:
- Complete, correct schema for all 14 files
- Proper field naming and order
- Correct asset naming and mapping
- Proper index.js station mapping
- Valid audio/image/video integration

### Critical Week 19 Files to Reference:
1. `src/data/weeks/week_19/index.js` - Station mapping, weekId, global_vocab structure
2. `src/data/weeks/week_19/read.js` - Story schema with comprehension_questions (not check_questions)
3. `src/data/weeks/week_19/explore.js` - Article schema with check_questions and question object
4. `src/data/weeks/week_19/vocab.js` - 10 words, exact field order
5. `src/data/weeks/week_19/word_power.js` - 3 items, cefr_level, model_sentence
6. `src/data/weeks/week_19/grammar.js` - grammar_explanation + 20 exercises
7. `src/data/weeks/week_19/logic.js` - 5 puzzles, target_number, unit fields
8. `src/data/weeks/week_19/ask_ai.js` - 5 prompts, audio_url field, hint (not hint_en/vi)
9. `src/data/weeks/week_19/dictation.js` - 8 sentences, text + meaning
10. `src/data/weeks/week_19/shadowing.js` - title + 8 script items (SAME count as dictation)
11. `src/data/weeks/week_19/mindmap.js` - 6 centerStems, branchLabels object
12. `src/data/weeks/week_19/daily_watch.js` - videos array, videoId field
13. `src/data/weeks/week_19/writing.js` - min_words, model_sentence, keywords array
14. `src/data/weeks/week_19/word_match.js` - pairs array [1-10]

### Schema Validation Rules (from Week 19):
- **read.js**: Must have `comprehension_questions` (NOT `check_questions`)
- **explore.js**: Must have `check_questions` (3 items) AND `question` (1 object)
- **vocab.js**: Must have `collocation` field (NOT `collocations`)
- **word_power.js**: Must have `cefr_level` and `model_sentence` fields
- **ask_ai.js**: Must have `audio_url` field (even if null), `hint` (NOT `hint_en/vi`)
- **dictation.js**: Must have `meaning` field (NOT `translation`)
- **shadowing.js**: Must have `vi` field (NOT `meaning` or `translation`)
- **logic.js**: Must have `target_number` and `unit` for math/mc types
- **mindmap.js**: `branchLabels` is an OBJECT (not array), keys = centerStems
- **daily_watch.js**: Must have `videoId` (NOT `video_id`), `sim_duration` field
- **index.js**: Station keys MUST match week_19/index.js mapping (e.g. `logic_lab: logic`, `mindmap_speaking: mindmap`)

---

## VII. VALIDATION WORKFLOW (MANDATORY BEFORE ASSET GENERATION)

### Step 1: File Existence Check
For each new week (e.g. week 1, 20, etc.), verify:
```bash
# Advanced mode
ls src/data/weeks/week_XX/*.js | wc -l  # Should be 14
# Easy mode
ls src/data/weeks_easy/week_XX/*.js | wc -l  # Should be 14
```
If count ‚â† 14, **ABORT** and report missing files.

### Step 2: Schema Validation
For each file, validate:
1. All required fields present (see Week 19 reference above)
2. Field names match exactly (case-sensitive)
3. Field types correct (array vs object, string vs number)
4. No extra/unknown fields

### Step 3: Data Validation
1. **vocab.js**: Exactly 10 items, each with all 7 required fields
2. **word_power.js**: Exactly 3 items (Phase 1), each with all 9 required fields
3. **grammar.js**: Exactly 20 exercises, mixed types (mc, fill, unscramble)
4. **logic.js**: Exactly 5 puzzles, `answer` is array
5. **ask_ai.js**: Exactly 5 prompts, `answer` is array
6. **dictation.js**: 8-10 sentences (MUST match shadowing count)
7. **shadowing.js**: 8-10 script items (MUST match dictation count)
8. **mindmap.js**: 6 centerStems, 6 branches per stem (42 audio)
9. **daily_watch.js**: EXACTLY 5 videos (MANDATORY), all with valid `videoId`
10. **index.js**: `global_vocab` = vocab.vocab, all 13 stations mapped

### Step 4: Asset Path Validation
1. All `image_url` fields use correct pattern: `/images/weekXX/[filename].jpg`
2. All `audio_url` fields set to `null` or use correct pattern: `/audio/weekXX/[filename].mp3`
3. Cover images use `read_cover_wXX.jpg` and `explore_cover_wXX.jpg` (NOT `read_cover_weekXX.jpg`)
4. Vocab images use `[word].jpg` (NO prefix, lowercase, underscore for spaces)
5. Word power images use `wordpower_[word].jpg` (WITH prefix)

### Step 5: Content Validation
1. All content generated from `syllabus_database.js` (correct week title, grammar, topic)
2. All content follows `ENGQUEST APP MASTER BLUEPRINT-FINAL.txt` rules:
   - Easy mode: Simple S-V-O, "and/but" connectors, CEFR A1-A2
   - Advanced mode: Compound sentences, richer vocab, CEFR A2-B1
3. No content copied from other weeks (verify uniqueness)
4. Grammar focus in all stations matches syllabus (e.g. "Past Simple: was/were")

### Step 6: API Key Validation
1. Verify `API keys.txt` file exists and readable
2. Parse and extract all keys (YouTube, Gemini, Google TTS, OpenAI)
3. Test first key for each service (or use fallback)
4. If all keys invalid, create `.env` template and prompt user

### Step 7: Asset Generation Validation
After running asset commands:
```bash
# Check audio count (typically ~120-130 per mode, varies by content)
ls public/audio/weekXX/*.mp3 | wc -l
ls public/audio/weekXX_easy/*.mp3 | wc -l

# Check image count (should be 15 per mode)
ls public/images/weekXX/*.jpg | wc -l
ls public/images/weekXX_easy/*.jpg | wc -l

# Check video data (should have EXACTLY 5 videos)
grep -c "videoId" src/data/weeks/week_XX/daily_watch.js
```
If counts incorrect, **ABORT** and report missing assets.

---

## VIII. ERROR HANDLING & REPORTING

### Common Errors + Automated Fixes:

**1. Missing Bold Words (Week 1 Error)**
```bash
# Error: read.js or explore.js has 0 bold words
# Fix: Use sed to convert first 10 meaningful words to bold
# Manual review required after automated fix
```

**2. Wrong WordPower Schema (Week 1 Error)**
```bash
# Error: Missing id, pronunciation, cefr_level, collocation fields
# Error: Has example_en/vi instead of example
# Fix: Run schema migration script:
node tools/fix_wordpower_schema.js <WEEK_ID>
```

**3. Wrong Audio Path Format (Week 1 Error)**
```bash
# Error: Uses /audio/week01/ instead of /audio/week1/
# Fix: Run path correction script:
node tools/fix_audio_paths.js <WEEK_ID>
```

**4. Sentence Count Violation (Week 1 Error)**
```bash
# Error: Easy mode read.js has 9 sentences (should be 6-8)
# Fix: Manually remove/combine sentences until count is correct
# No automated fix - requires content editing
```

**5. Wrong Station Keys (Week 1 Error)**
```bash
# Error: index.js uses 'quiz' key not in Week 19
# Error: Uses 'wordpower' instead of 'word_power'
# Fix: Run station key migration:
node tools/fix_station_keys.js <WEEK_ID>
```

**Standard Errors:**
6. **Missing file**: "‚ùå File not found: src/data/weeks/week_XX/[file].js"
7. **Schema mismatch**: "‚ùå [file].js missing required field: [field_name]"
8. **Wrong field name**: "‚ùå [file].js uses 'check_questions' but should use 'comprehension_questions'"
9. **Count mismatch**: "‚ùå dictation.js has 9 sentences but shadowing.js has 8 (must match)"
10. **Invalid key**: "‚ùå API key invalid or expired, please update API keys.txt"
11. **Asset missing**: "‚ùå Audio file not generated: public/audio/weekXX/vocab_apple.mp3"

### Error Resolution:
- **DO NOT proceed** with asset generation if validation fails
- **Report all errors** clearly with file path and line number (if applicable)
- **Suggest fix** based on Week 19 reference
- **Verify fix** by re-running validation before continuing

---

## IX. FINAL SUMMARY

### What This Prompt Guarantees:
1. Every new week will have **identical structure, schema, and asset set** to Week 19
2. All content will be **generated from syllabus and blueprint**, never copied
3. All assets will be **auto-generated with correct naming and mapping**
4. All API keys will be **loaded dynamically from API keys.txt**, never hardcoded
5. All errors will be **caught before asset generation**, not after
6. **Bold words** will use `**word**` syntax (NOT `*word*` or plain text)
7. **Sentence counts** will match requirements (Easy: 6-8, Advanced: 8-12)
8. **WordPower schema** will have all required fields (id, pronunciation, cefr_level, collocation)
9. **Station keys** will match Week 19 exactly (logic_lab, mindmap_speaking, word_power)
10. **Easy mode** will SIMPLIFY Advanced content, not replace it with different topic

### What You Must Do:
1. **Read syllabus and blueprint** for the target week FIRST
2. **Generate all 14 files** for BOTH modes, following Week 19 schema EXACTLY
3. **Validate all files** using the validation workflow above
4. **Run asset generation** commands ONLY after validation passes
5. **Verify assets** using the asset count checks above
6. **Report completion** with full checklist confirmation

This prompt is the definitive guide. Do not deviate.

---

## VII. DATA STRUCTURE VALIDATION (WEEK 1 FINDINGS - MANDATORY)

### 7.1 CRITICAL STRUCTURAL ERRORS TO AVOID

Based on Week 1 regeneration findings (December 28, 2025), these structural errors caused **app crashes** and **blank screens** despite having correct content. All AI assistants MUST follow these rules when generating week data.

---

### 7.2 MINDMAP STRUCTURE (CRITICAL)

**‚ùå WRONG (Week 1 had this - caused React error "Objects are not valid as a React child"):**
```javascript
export default {
  centerStems: [
    { id: 1, text: "My School", audio_url: null },  // ‚ùå Object with id field
    { id: 2, text: "My Teacher", audio_url: null }
  ],
  branchLabels: {
    1: [  // ‚ùå Number key
      { id: 1, text: "Where is your school?", audio_url: null },  // ‚ùå Object format
      { id: 2, text: "How do you go to school?", audio_url: null }
    ],
    2: [...]  // ‚ùå Number key
  }
};
```

**‚úÖ CORRECT (Week 19 pattern - MUST follow exactly):**
```javascript
// ADVANCED MODE - WEEK 19
const mindMapContent = {
  centerStems: [
    "When I was young, I ___.",  // ‚úÖ Plain string
    "My favorite memory was ___."  // ‚úÖ Plain string
  ],
  branchLabels: {
    "When I was young, I ___.": [  // ‚úÖ STRING KEY matching centerStems text exactly
      "played with my friends",  // ‚úÖ Plain string
      "lived in a small house",
      "went to kindergarten"
    ],
    "My favorite memory was ___.": [  // ‚úÖ STRING KEY matching centerStems text exactly
      "my birthday party",
      "playing in the rain"
    ]
  }
};

export default mindMapContent;
```

**RULES:**
1. `centerStems`: Array of PLAIN STRINGS (not objects)
2. `branchLabels`: Object with STRING KEYS that match centerStems text EXACTLY
   - Include trailing punctuation (e.g., `"___."``)
   - Keys are case-sensitive
   - NO number keys (1, 2, 3)
3. Each branch: Array of PLAIN STRINGS (not objects with id/text fields)
4. NO `audio_url` fields in data (script auto-generates)

---

### 7.3 WRITING STATION STRUCTURE (CRITICAL)

**‚ùå WRONG (Week 1 had this - caused "No content" display):**
```javascript
export default {
  topicPrompts: [  // ‚ùå Array of prompts
    {
      id: 1,
      prompt_en: "Write about your school day...",
      prompt_vi: "Vi·∫øt v·ªÅ ng√†y h·ªçc...",
      min_words: 50
    },
    { id: 2, ... },
    { id: 3, ... }
  ],
  grammarPrompts: [  // ‚ùå Array of prompts
    {
      id: 1,
      prompt_en: "Write 5 sentences using 'I am...'",
      grammar_focus: "Subject Pronouns & Verb to be",
      example: "I am a student. I am happy."
    },
    { id: 2, ... }
  ]
};
```

**‚úÖ CORRECT (Week 19 pattern - MUST follow exactly):**
```javascript
export default {
  title: "My Childhood Memory",  // ‚úÖ Single object structure
  min_words: 40,
  model_sentence: "When I was five years old, I lived in a small house. There was a big garden...",
  instruction_en: "Write about a happy memory from when you were younger.",
  instruction_vi: "Vi·∫øt v·ªÅ m·ªôt k·ª∑ ni·ªám vui t·ª´ khi b·∫°n c√≤n nh·ªè.",
  prompt_en: "Where were you? Who was with you? What was special about that time?",
  prompt_vi: "B·∫°n ·ªü ƒë√¢u? Ai ·ªü c√πng b·∫°n? ƒêi·ªÅu g√¨ ƒë·∫∑c bi·ªát v·ªÅ th·ªùi gian ƒë√≥?",
  keywords: ["was", "were", "memory", "happy", "when I was"]
};
```

**RULES:**
1. Single object (NOT arrays `topicPrompts[]` or `grammarPrompts[]`)
2. Required fields:
   - `title` - Writing activity title
   - `min_words` - Word count requirement
   - `model_sentence` - Example paragraph
   - `instruction_en/vi` - Task instructions
   - `prompt_en/vi` - Guiding questions
   - `keywords` - Array of target grammar/vocab
3. NO `id` field
4. NO separate grammar prompts

---

### 7.4 VIDEO GENERATION (CRITICAL)

**‚ùå WRONG (Week 1 had this - all videos were deadlinks):**
```javascript
// daily_watch.js with HARDCODED videoIds
export default {
  videos: [
    {
      id: 1,
      title: "Subject Pronouns Song - I, You, He, She, We, They",
      videoId: "5bLp0mYeYBE",  // ‚ùå Hardcoded ID from AI storage (doesn't exist on YouTube)
      duration: "3:42",
      thumb: "https://img.youtube.com/vi/5bLp0mYeYBE/mqdefault.jpg"
    },
    // ... all 5 videos with fake IDs
  ]
};
```

**NO `video_queries.json` file** = videos never validated

**‚úÖ CORRECT (Week 19 pattern - MUST follow process):**

**Step 1: Create `video_queries.json` FIRST:**
```json
{
  "masterQuery": "past simple was were childhood memories for kids ESL",
  "grammar": "past simple was were verb to be past tense",
  "videos": [
    {
      "id": 1,
      "query": "past simple was were song for kids",
      "purpose": "GRAMMAR"
    },
    {
      "id": 2,
      "query": "childhood memories for kids educational",
      "purpose": "TOPIC"
    },
    {
      "id": 3,
      "query": "old toys games from the past for kids",
      "purpose": "TOPIC"
    },
    {
      "id": 4,
      "query": "history how things changed for kids",
      "purpose": "SCIENCE"
    },
    {
      "id": 5,
      "query": "what was life like in the past for kids",
      "purpose": "SCIENCE"
    }
  ]
}
```

**Step 2: Run `update_videos.js` to search YouTube:**
```bash
YOUTUBE_API_KEY="your_key" node tools/update_videos.js 19 --reset
```

**Result: Real validated YouTube IDs:**
```javascript
export default {
  videos: [
    {
      id: 1,
      title: "Pronouns / I ,you ,we ,they ,he ,she ,it / Subject Pronouns",
      videoId: "iSybXF9qou0",  // ‚úÖ Real YouTube ID (validated)
      duration: "03:35",
      sim_duration: 215,
      thumb: "https://img.youtube.com/vi/iSybXF9qou0/mqdefault.jpg",
      query: "subject pronouns song I you he she we they for kids",
      purpose: "GRAMMAR"
    }
  ]
};
```

**RULES:**
1. **NEVER hardcode videoIds** - always use video_queries.json + update_videos.js
2. **ALWAYS create video_queries.json** with 5 search queries
3. **Query types:**
   - 1-2 GRAMMAR: Match week's grammar focus with keywords
   - 1-2 TOPIC: Match week's theme
   - 1-2 SCIENCE/CLIL: Match week's science/global theme
4. **Purpose labels:** Must be one of: `GRAMMAR`, `TOPIC`, `SCIENCE`
5. **Validation:** Script checks video exists, filters out music/lyrics/non-English
6. **Easy mode:** Same videos as Advanced (script auto-syncs)

---

### 7.5 IMAGE ASSETS (VALIDATION GAPS)

**Issue:** Week 1 reported "15 images to generate" but only created 13.

**Missing files:**
- `read_cover_w01.jpg` (story cover, 16:9)
- `name.jpg` (vocab word image, 1:1)

**Root Cause:** Smart check counted **expected** images, not **actual** generated images.

**Required images per week (15 total):**
| Type | Count | Naming Pattern | Aspect Ratio |
|------|-------|----------------|-------------|
| Read cover | 1 | `read_cover_wXX.jpg` | 16:9 |
| Explore cover | 1 | `explore_cover_wXX.jpg` | 16:9 |
| Vocab | 10 | `[word].jpg` | 1:1 |
| Word Power | 3 | `wordpower_[word].jpg` | 1:1 |

**VALIDATION FIX:**
After running `batch_manager.js`, verify actual file count:
```bash
ls -1 public/images/weekXX/*.{jpg,png,webp} | wc -l  # Must be 15
ls -1 public/images/weekXX_easy/*.{jpg,png,webp} | wc -l  # Must be 15
```
If count ‚â† 15, report error and regenerate missing images.

---

### 7.6 EASY MODE INHERITANCE (CRITICAL)

**‚ùå WRONG (Week 1 Easy mode had same structural errors as Advanced):**
- Easy mindmap: Used number keys (same error as Advanced)
- Easy writing: Used array structure (same error as Advanced)

**‚úÖ CORRECT:**
Easy mode MUST inherit STRUCTURE from Advanced, then simplify CONTENT:

**Structure inheritance:**
- Mindmap: String keys ‚Üê Advanced
- Writing: Single object ‚Üê Advanced
- Videos: Same 5 videos ‚Üê Advanced
- Logic Lab: 5 puzzles ‚Üê Advanced (same count)
- All files: Same schema ‚Üê Advanced

**Content morphing:**
- Sentences: Shorter (6-8 vs 8-12)
- Vocabulary: Simpler synonyms
- Grammar: Simple/compound only (no complex)

**Example:**
```
Advanced mindmap stem: "When I was young, I played with my friends every day after school."
Easy mindmap branch: "When I was young, I played with friends." (same structure, simpler text)

Advanced writing prompt: "Write about a happy memory from when you were younger. Describe where you were, who was with you, what you did, and why it was special."
Easy writing prompt: "Write about a happy memory. Where were you? Who was with you?" (same structure, shorter text)
```

---

### 7.7 LOGIC LAB - CORRECT STRUCTURE (VERIFIED)

**‚úÖ Week 1 Logic Lab was CORRECT** - no changes needed.

**Required structure (30-50 words context per puzzle):**
```javascript
{
  id: 1,
  context_en: "Alex's classroom has 20 desks arranged in rows. Each row has 4 desks. Alex sits in the third row from the front. In the morning, 3 students are absent, so some desks are empty.",
  context_vi: "L·ªõp h·ªçc c·ªßa Alex c√≥ 20 c√°i b√†n x·∫øp th√†nh h√†ng...",
  question_en: "How many rows of desks are there in Alex's classroom?",
  question_vi: "C√≥ bao nhi√™u h√†ng b√†n trong l·ªõp h·ªçc c·ªßa Alex?",
  answer: ["5", "5 rows", "five", "five rows"]
}
```

**Blueprint requirement met:**
- ‚úÖ Character names (Alex)
- ‚úÖ Situation (classroom, desks, absent students)
- ‚úÖ Rich narrative (30-50 words)
- ‚úÖ NOT bare math ("5 √ó 4 = ?")

---

### 7.8 PRE-GENERATION VALIDATION (MANDATORY)

Before running asset generation, run these checks:

**Check 1: File count**
```bash
ls src/data/weeks/week_XX/*.js | wc -l          # Must be 14
ls src/data/weeks_easy/week_XX/*.js | wc -l     # Must be 14
```

**Check 2: Mindmap structure**
```bash
# Check for number keys (WRONG)
grep -E '^\s*[0-9]+:' src/data/weeks/week_XX/mindmap.js
# Output should be EMPTY. If not, mindmap has number keys - FIX IT!

# Check for string keys (CORRECT)
grep -E '^\s*".*":' src/data/weeks/week_XX/mindmap.js
# Output should show multiple matches (6+ lines)
```

**Check 3: Writing structure**
```bash
# Check for array format (WRONG)
grep 'topicPrompts\|grammarPrompts' src/data/weeks/week_XX/writing.js
# Output should be EMPTY. If not, writing has array structure - FIX IT!

# Check for single object (CORRECT)
grep 'title:' src/data/weeks/week_XX/writing.js
grep 'model_sentence:' src/data/weeks/week_XX/writing.js
# Both should have output
```

**Check 4: Video queries exist**
```bash
ls src/data/weeks/week_XX/video_queries.json
# File must exist BEFORE running update_videos.js
```

**Check 5: Asset counts AFTER generation**
```bash
# Audio: Variable (typically 120-130)
ls -1 public/audio/weekXX/*.mp3 | wc -l
ls -1 public/audio/weekXX_easy/*.mp3 | wc -l

# Images: EXACTLY 15
ls -1 public/images/weekXX/*.{jpg,png,webp} | wc -l     # Must be 15
ls -1 public/images/weekXX_easy/*.{jpg,png,webp} | wc -l  # Must be 15

# Videos: EXACTLY 5
grep -c '"id":' src/data/weeks/week_XX/daily_watch.js  # Must be 5
```

---

### 7.9 TOOL COMPATIBILITY ISSUES

**Week Folder Naming Inconsistency:**
- Data uses: `week_01`, `week_02`, ... (zero-padded)
- Tools expect: `week_1`, `week_2`, ... (no padding)

**Workaround:**
```bash
# Create temp folder for tools
mkdir -p src/data/weeks/week_1
cp src/data/weeks/week_01/video_queries.json src/data/weeks/week_1/

# Run tool
YOUTUBE_API_KEY="key" node tools/update_videos.js 1 --reset

# Copy back
cp src/data/weeks/week_1/daily_watch.js src/data/weeks/week_01/
cp src/data/weeks/week_1/daily_watch.js src/data/weeks_easy/week_01/
rm -rf src/data/weeks/week_1
```

**Long-term fix:** Update all tools to handle both formats (`week_1` and `week_01`).

---

### 7.10 AUTOMATED FIX SCRIPTS (TO BE CREATED)

Create these tools to prevent future errors:

**1. `tools/validate_week_structure.js`**
```bash
node tools/validate_week_structure.js 1
# Output:
# ‚úÖ File count: 14/14 (Advanced + Easy)
# ‚úÖ Mindmap: String keys
# ‚úÖ Writing: Single object
# ‚úÖ video_queries.json exists
# ‚úÖ Bold words: 10/10 (read.js + explore.js)
# ‚úÖ Sentence count: 8-12 (Advanced), 6-8 (Easy)
# ‚ö†Ô∏è  Images: 13/15 (missing read_cover_w01.jpg, name.jpg)
```

**2. `tools/fix_mindmap_keys.js`**
```bash
node tools/fix_mindmap_keys.js 1
# Converts number keys to string keys automatically
```

**3. `tools/fix_writing_structure.js`**
```bash
node tools/fix_writing_structure.js 1
# Converts array structure to single object
```

**4. `tools/audit_asset_counts.js`**
```bash
node tools/audit_asset_counts.js 1
# Reports actual vs expected asset counts after generation
```

---

### 7.11 SUMMARY: LESSONS FROM WEEK 1

**Content was correct:**
- ‚úÖ Grammar focus: Subject Pronouns & Verb to be
- ‚úÖ Vocabulary: 10 school-related words
- ‚úÖ Science theme: Scientist tools
- ‚úÖ Logic Lab: Story-based math problems

**Structure was WRONG:**
- ‚ùå Mindmap: Number keys instead of string keys
- ‚ùå Writing: Arrays instead of single object
- ‚ùå Videos: Hardcoded IDs without validation
- ‚ùå Images: Missing 2 files

**Key Learning:**
Master Prompt V23 previously focused on **content generation** (grammar, vocab, topics) but lacked **structural validation**. This section (VII) now provides explicit structure requirements with code examples to prevent future errors.

**CRITICAL RULE:**
When generating new weeks, ALWAYS follow Week 19 structure EXACTLY. Content can be different, but STRUCTURE must be identical.

---



### 7.12 GRAMMAR STRUCTURE (CRITICAL - WEEK 1 ERROR)

**Problem Found in Week 1:**
Grammar.js used WRONG structure that broke Grammar Engine component.

**‚ùå WRONG Structure (Week 1 had this):**
```javascript
export default {
  focus: "Subject Pronouns and Verb to Be",
  exercises: [
    {
      id: 1,
      type: "mc",
      question_en: "I _____ happy.",  // ‚ùå WRONG: question_en
      question_vi: "T√¥i vui v·∫ª.",     // ‚ùå WRONG: question_vi
      options: ["am", "is", "are"],
      answer: 0,                       // ‚ùå WRONG: index instead of string
      // ‚ùå Missing hint
    }
  ]
}
```

**‚úÖ CORRECT Structure (Week 19 - MANDATORY):**
```javascript
export default {
  grammar_explanation: {              // ‚úÖ REQUIRED object
    title_en: "Subject Pronouns and Verb to Be",
    title_vi: "ƒê·∫°i t·ª´ nh√¢n x∆∞ng v√† ƒë·ªông t·ª´ to be",
    rules: [
      {
        type: "rule",
        icon: "1Ô∏è‚É£",
        rule_en: "I use 'am'",
        rule_vi: "T√¥i d√πng 'am'",
        examples: [
          { text_en: "I am a student", text_vi: "T√¥i l√† h·ªçc sinh" }
        ]
      }
      // ... more rules
    ]
  },
  exercises: [
    {
      id: 1,
      type: "mc",
      question: "I _____ happy.",      // ‚úÖ CORRECT: question (not question_en)
      options: ["am", "is", "are"],
      answer: "am",                    // ‚úÖ CORRECT: string (not index)
      hint: "I + am"                   // ‚úÖ CORRECT: hint present
    },
    {
      id: 2,
      type: "unscramble",
      question: "Unscramble: are / you / student / a / ?",
      answer: "Are you a student?",
      hint: "Start with 'Are'"
    }
    // ... 18 more exercises (total 20)
  ]
}
```

**MANDATORY Requirements:**
1. **grammar_explanation object** - MUST exist with title_en/title_vi/rules array
2. **exercise.question** - Use `question` NOT `question_en/question_vi`
3. **exercise.answer** - String value ("am") NOT index (0)
4. **exercise.hint** - MUST exist for all exercises
5. **Total exercises** - EXACTLY 20 (mix of mc, fill, unscramble)

**Why This Structure:**
- GrammarEngine.jsx expects `data.grammar_explanation` object
- Component renders rules with icons before exercises
- Answer validation uses string comparison, not index lookup
- Hint system requires hint field in each exercise

---

### 7.13 LOGIC LAB AUDIO GENERATION (CRITICAL - WEEK 1 ERROR)

**Problem Found in Week 1:**
Audio only read question without context - meaningless audio ("How many rows of desks are there?" with no story).

**Root Cause:**
`tools/generate_audio.js` line 257 only passed `question_en` to TTS, ignored `context_en`.

**‚ùå WRONG Code (Before):**
```javascript
// Logic Lab section in generate_audio.js
if (logic && logic.puzzles) {
  for (const p of logic.puzzles) {
    addTask(p.question_en, `logic_${p.id}`, voices.questions);  // ‚ùå Only question
  }
}
```

**‚úÖ CORRECT Code (After - MANDATORY):**
```javascript
// Logic Lab section in generate_audio.js
if (logic && logic.puzzles) {
  for (const p of logic.puzzles) {
    // ‚úÖ Concatenate context + question
    const fullText = p.context_en 
      ? `${p.context_en} ${p.question_en}` 
      : p.question_en;
    addTask(fullText, `logic_${p.id}`, voices.questions);
  }
}
```

**Data Structure (logic.js):**
```javascript
export default {
  puzzles: [
    {
      id: 1,
      context_en: "There are 5 rows of desks in the classroom. Each row has 4 desks.", // ‚úÖ 30-50 words
      context_vi: "C√≥ 5 h√†ng b√†n...",
      question_en: "How many rows of desks are there?",  // ‚úÖ Short question
      question_vi: "C√≥ bao nhi√™u h√†ng b√†n?",
      answer: "5",
      unit: "rows"
    }
  ]
}
```

**Audio Behavior:**
- User clicks audio button in Logic Lab
- Audio plays: "[Context story - 50 words] ... [Question]"
- User hears full problem before answering

**Blueprint Requirement:**
Logic Lab problems are **story-based math** - audio MUST narrate full story context before asking question.

---

### 7.14 SMARTCHECK FEATURE (REQUIRED - WEEK 1 MISSING)

**Problem Found in Week 1:**
SmartCheck feature completely broken in BOTH Read and Explore stations.

**SmartCheck Purpose:**
Progressive disclosure system - students try answering first, then click hint icon if stuck.

**Component Requirements:**

**1. Read Station (SmartCheck for Comprehension):**

**‚ùå WRONG Structure (Week 1):**
```javascript
// read.js
comprehension_questions: [
  {
    id: 1,
    question_en: "Where does Anna go?",
    question_vi: "Anna ƒëi ƒë√¢u?",
    answer_en: "to school",           // ‚ùå WRONG: single string
    answer_vi: "ƒë·∫øn tr∆∞·ªùng"           // ‚ùå WRONG: Vietnamese answer
    // ‚ùå Missing: hint_en, hint_vi
  }
]
```

**‚úÖ CORRECT Structure (Week 19 - MANDATORY):**
```javascript
// read.js
comprehension_questions: [
  {
    id: 1,
    question_en: "Where does Anna go?",
    answer: [                          // ‚úÖ CORRECT: array of acceptable answers
      "to school",
      "school",
      "to the school",
      "she goes to school"
    ],
    hint_en: "Look at the first sentence",  // ‚úÖ REQUIRED
    hint_vi: "Xem c√¢u ƒë·∫ßu ti√™n"             // ‚úÖ REQUIRED
  }
  // ... 2 more questions (total 3)
]
```

**2. Explore Station (SmartCheck + Writing Prompt):**

**‚ùå WRONG Structure (Week 1):**
```javascript
// explore.js
export default {
  title_en: "Scientists and Their Tools",
  content_en: "Scientists use many tools...",
  // ‚ùå MISSING: check_questions array
  // ‚ùå MISSING: question object (writing prompt)
}
```

**‚úÖ CORRECT Structure (Week 19 - MANDATORY):**
```javascript
// explore.js
export default {
  title_en: "Scientists and Their Tools",
  content_en: "Scientists use many tools...",
  
  check_questions: [                  // ‚úÖ REQUIRED: SmartCheck questions
    {
      id: 1,
      question_en: "What do scientists use to see tiny things?",
      answer: ["microscope", "microscopes", "a microscope"],
      hint_en: "It makes small things look bigger",
      hint_vi: "N√≥ l√†m cho v·∫≠t nh·ªè tr√¥ng to h∆°n"
    }
    // ... 2 more questions (total 3)
  ],
  
  question: {                         // ‚úÖ REQUIRED: Writing prompt
    text_en: "Describe a tool scientists use and explain why it's important.",
    text_vi: "M√¥ t·∫£ m·ªôt c√¥ng c·ª• m√† nh√† khoa h·ªçc s·ª≠ d·ª•ng v√† gi·∫£i th√≠ch t·∫°i sao n√≥ quan tr·ªçng.",
    min_words: 20,                    // ‚úÖ REQUIRED: minimum word count
    hint_en: "Choose one tool from the text and explain its purpose",
    hint_vi: "Ch·ªçn m·ªôt c√¥ng c·ª• t·ª´ b√†i ƒë·ªçc v√† gi·∫£i th√≠ch m·ª•c ƒë√≠ch c·ªßa n√≥"
  }
}
```

**UI Behavior:**
- Read station: 3 comprehension questions below passage ‚Üí click lightbulb icon ‚Üí hint appears
- Explore station: Scroll to bottom ‚Üí 3 SmartCheck questions + writing prompt with word counter

**Component Files:**
- `src/modules/ReadingExplore/Read.js` expects `comprehension_questions` with hints
- `src/modules/Explore/Explore.js` expects `check_questions` + `question` object

---

### 7.15 AUDIO REGENERATION WORKFLOW (CRITICAL)

**Problem Found in Week 1:**
After fixing Grammar/Logic/SmartCheck data structures, old audio files still existed ‚Üí script skipped ALL regeneration ‚Üí audio didn't match new data.

**Root Cause:**
`generate_audio.js` checks file existence BEFORE reading data:
```javascript
if (fs.existsSync(outputPath)) {
  console.log(`   ‚è≠Ô∏è  Skipping ${filename} (exists)`);
  continue;  // ‚ùå Skips even if data structure changed
}
```

**MANDATORY Workflow When Data Structure Changes:**

**Step 1: Backup Old Audio**
```bash
cd /path/to/Engquest3k
mv public/audio/weekXX public/audio/weekXX_OLD_BACKUP
mv public/audio/weekXX_easy public/audio/weekXX_easy_OLD_BACKUP
```

**Step 2: Verify Folders Cleared**
```bash
ls public/audio/ | grep weekXX
# Should show ONLY weekXX_OLD_BACKUP, NOT weekXX
```

**Step 3: Regenerate Audio**
```bash
node tools/generate_audio.js XX XX [GOOGLE_TTS_API_KEY]
# Script will generate ALL files (no skipping)
```

**Step 4: Verify New Audio Count**
```bash
ls -1 public/audio/weekXX/*.mp3 | wc -l     # Should be ~120-130
ls -1 public/audio/weekXX_easy/*.mp3 | wc -l  # Should be ~120-130
```

**Step 5: Test in App**
```bash
npm run dev
# Open http://localhost:5174
# Test Grammar, Logic Lab, Read, Explore audio buttons
```

**When to Clear Audio:**
- Changed grammar.js structure (question_en ‚Üí question, added grammar_explanation)
- Changed Logic Lab (added context reading)
- Changed Read/Explore SmartCheck (added hints)
- Changed any audio-related data field (definitions, examples, collocations)

**When NOT to Clear Audio:**
- Only changed non-audio fields (images, video IDs, colors)
- Only fixed typos in existing audio text
- Only added new stations (old audio still valid)

**Blueprint Alignment:**
Audio files MUST match data structure exactly - mismatch breaks station functionality.

---

## END OF MASTER PROMPT V23-FINAL (UPDATED WITH WEEK 1 LEARNINGS)

### 7.16 PYTHON AUDIO GENERATION SCRIPT (CRITICAL BUG FIX)

**Problem Found:**
Python script `tools/generate_audio.py` had critical bug that caused immediate skip of ALL files when folder exists but is empty.

**Root Cause:**
Script used `os.path.exists()` to check if audio file exists - but this function returns `True` for BOTH folders AND files:
```python
# ‚ùå WRONG CODE (BEFORE):
if os.path.exists(output_path) and os.path.getsize(output_path) > 0:
    count_skipped += 1
    continue
```

**Behavior:**
1. Folder `public/audio/week1/` exists (empty)
2. Script checks: `os.path.exists("/path/to/week1/vocab_student.mp3")` ‚Üí False (file doesn't exist)
3. BUT `os.path.exists("/path/to/week1/")` ‚Üí True (folder exists)
4. Bug in path checking logic caused script to think files already exist
5. Script skips ALL 246 files ‚Üí Reports "complete" immediately ‚Üí 0 files generated

**‚úÖ CORRECT CODE (FIXED):**
```python
# ‚úÖ Use os.path.isfile() - only returns True for actual FILES
if os.path.isfile(output_path) and os.path.getsize(output_path) > 0:
    count_skipped += 1
    continue
```

**Why This Fix Works:**
- `os.path.isfile()` returns `True` ONLY if path points to an actual file (not folder)
- Empty folder no longer triggers skip logic
- Script correctly generates all files

---

### 7.17 AUDIO GENERATION WORKFLOW (ADMIN PANEL + PYTHON)

**Recommended Workflow (2-Step Process):**

**Step 1: Create JSON Task List (Admin Panel or Node.js)**

Option A - Admin Panel (Recommended for single weeks):
1. Open app: `npm run dev` ‚Üí http://localhost:5174
2. Login as admin
3. Click "Studio" tab ‚Üí Select "Audio" mode
4. Select week number ‚Üí Click "Generate Tasks JSON"
5. File saved to: `tools/audio_tasks.json`

Option B - Command Line (Recommended for batch):
```bash
node tools/create_audio_tasks_only.js <START_WEEK> <END_WEEK>
# Example: node tools/create_audio_tasks_only.js 1 1
# Creates: tools/audio_tasks.json (246 tasks for week 1)
```

**Step 2: Generate Audio Files (Python Script)**

```bash
# Set OpenAI API key
export OPENAI_API_KEY="sk-proj-..."

# Run generation (creates 246 MP3 files)
python3 tools/generate_audio.py --provider openai --voice nova

# Output:
# üöÄ B·∫ÆT ƒê·∫¶U X·ª¨ L√ù 246 FILE AUDIO...
#    üéôÔ∏è  [1/246] Generating: read_explore_main.mp3...
#    üéôÔ∏è  [2/246] Generating: explore_main.mp3...
#    ...
#    ‚úÖ ƒê√£ t·∫°o m·ªõi: 246
```

**Voice Options:**
- `--voice nova` (Female - recommended for vocab/definitions)
- `--voice alloy` (Male - recommended for reading/logic)
- `--voice echo` (Deep male - recommended for dictation)
- `--voice fable` (British male)
- `--voice onyx` (Deep voice)
- `--voice shimmer` (Female energetic)

**Script Features:**
- **Auto-skip:** If file exists with size > 0, skips regeneration
- **Voice mapping:** Reads voice config from JSON (e.g., Neural2-F ‚Üí nova, Neural2-D ‚Üí alloy)
- **Error handling:** Reports failed files at end
- **Progress tracking:** Shows current file number (e.g., [123/246])

**Verification:**
```bash
# Check file count
ls -1 public/audio/week1/*.mp3 | wc -l        # Should be ~123
ls -1 public/audio/week1_easy/*.mp3 | wc -l   # Should be ~123

# Test in app
npm run dev
# Click audio buttons in Grammar, Logic Lab, Read, Explore
```

---

### 7.18 COMMON AUDIO GENERATION ERRORS & FIXES

**Error 1: "B·ªé QUA T·∫§T C·∫¢ - 0 FILES GENERATED"**
- **Cause:** Script uses old `os.path.exists()` logic
- **Fix:** Update `tools/generate_audio.py` line 52 to use `os.path.isfile()`
- **Verification:** Check `wc -l tools/generate_audio.py` should be 100+ lines with fixed code

**Error 2: "L·ªñI: Thi·∫øu bi·∫øn m√¥i tr∆∞·ªùng OPENAI_API_KEY"**
- **Cause:** Environment variable not set
- **Fix:** `export OPENAI_API_KEY="sk-proj-..."`
- **Note:** Get key from `API keys.txt` file

**Error 3: "Folder week1/ not found"**
- **Cause:** Running from wrong directory
- **Fix:** `cd /path/to/Engquest3k` before running script
- **Verification:** `pwd` should end with `/Engquest3k`

**Error 4: "JSON file not found: tools/audio_tasks.json"**
- **Cause:** Skipped Step 1 (create JSON)
- **Fix:** Run `node tools/create_audio_tasks_only.js 1 1` first

**Error 5: "API rate limit exceeded"**
- **Cause:** Too many requests to OpenAI API
- **Fix:** Wait 60 seconds, then resume (script auto-skips completed files)

**Error 6: "Audio doesn't match new data structure"**
- **Cause:** Data changed but audio not regenerated
- **Fix:** Delete old audio first:
  ```bash
  rm -rf public/audio/week1 public/audio/week1_easy
  # Then regenerate
  ```

---

### 7.19 AUDIO GENERATION CHECKLIST (BEFORE MASS PRODUCTION)

Before generating audio for remaining 143 weeks, verify:

**Prerequisites:**
- [ ] `tools/generate_audio.py` has `os.path.isfile()` fix (not `os.path.exists()`)
- [ ] OpenAI API key in `API keys.txt` is valid
- [ ] Tested Week 1 audio generation successfully (246 files)
- [ ] All Week 1 audio files play correctly in app

**For Each New Week:**
- [ ] Week data files complete (14 files in both modes)
- [ ] Grammar has `grammar_explanation` object
- [ ] Logic Lab has `context_en` field (30-50 words)
- [ ] Read has `comprehension_questions` with hints
- [ ] Explore has `check_questions` + `question` object
- [ ] Run structural validation: `node tools/validate_week_structure.js XX`
- [ ] Generate JSON: `node tools/create_audio_tasks_only.js XX XX`
- [ ] Verify JSON: Check file count (~240-250 tasks)
- [ ] Generate audio: `python3 tools/generate_audio.py --provider openai --voice nova`
- [ ] Verify audio count: `ls -1 public/audio/weekXX/*.mp3 | wc -l` (~120-130)
- [ ] Test in app: Click audio buttons in 3-5 stations

**Batch Generation (Recommended for Speed):**
```bash
# Generate JSON for weeks 1-10
for i in {1..10}; do
  node tools/create_audio_tasks_only.js $i $i
  python3 tools/generate_audio.py --provider openai --voice nova
  echo "‚úÖ Week $i complete"
done
```

**Note:** For cost analysis and image generation strategy options, see separate document: `IMAGE_GENERATION_STRATEGY_UPDATED.md`

---

## 8. STORY MISSION - AI TUTOR COMPLETE DOCUMENTATION

**CRITICAL: Vietnamese ESL A0++ Context (6-12 year olds)**
All Story Mission content MUST follow these constraints:
- **Target audience:** Vietnamese children (6-12 years old) learning English as absolute beginners
- **Grammar:** Present Simple ONLY - no past tense, present continuous, or future tense
  - ‚úÖ CORRECT: "I like playground", "My name Khan", "Teacher is Ms. Nova"
  - ‚ùå WRONG: "I liked it", "I am playing", "I will go" (violates A0++ scope)
- **Sentence length:** Maximum 10 words per sentence
- **Vocabulary:** Core 2,000 high-frequency words only, no idioms or phrasal verbs
- **Pronunciation errors:** Common Vietnamese ESL patterns (see fuzzy matching map below)
- **Cultural context:** Vietnamese names (Khan, Noon, Binh, Linh), subjects (Math, Science, English), school environment

### 8.1. Story Mission Data Structure & Mass Production

**CURRENT Architecture (Implemented Dec 31, 2025):**
```
src/data/missions/
‚îú‚îÄ‚îÄ missionSchema.js                    # Schema definition + createMission() factory
‚îú‚îÄ‚îÄ week1_first_day.js                  # Week 1 Mission 1: First Day
‚îú‚îÄ‚îÄ week1_my_classroom.js               # Week 1 Mission 2: My Classroom
‚îú‚îÄ‚îÄ week1_school_friends.js             # Week 1 Mission 3: School Friends
‚îú‚îÄ‚îÄ week2_family_introduction.js        # Week 2 Mission 1: Meet My Family
‚îú‚îÄ‚îÄ week2_family_roles.js               # Week 2 Mission 2: Family Team
‚îú‚îÄ‚îÄ week2_family_activities.js          # Week 2 Mission 3: Family Time
‚îî‚îÄ‚îÄ ...

src/data/storyMissions.js               # Central registry + getMissionsForWeek()
```

**Mission File Structure (Standard Format):**
```javascript
import { createMission } from './missionSchema';

export const week2FamilyIntroduction = createMission({
  id: "W2_FAMILY_INTRO",
  weekId: 2,
  title: "Meet My Family",
  description: "Learn to introduce your family members using 'This is my...'",
  level: "easy",
  
  targetVocabulary: [
    { word: "family", mustUse: true, phonetic: "/Ààf√¶m…ôli/", definition: "..." },
    { word: "mother", mustUse: true, phonetic: "/Ààm å√∞…ôr/", definition: "..." },
    // ... 5-7 vocab items total
  ],
  
  successCriteria: {
    minTurns: 6,
    mustUseWords: ["family", "mother", "father"],  // 3-4 core words
    optionalBonus: ["brother", "sister"],          // 2-3 bonus words
    vocabularyThreshold: 0.5
  },
  
  steps: [
    {
      stepId: 1,
      aiPrompt: "Hi! I'm Ms. Nova! üëã Do you have a family?",
      task: "Answer yes or no",
      expected: { type: "yes_no" },
      hints: ["Yes", "I", "have", "a", "family"],
      repair: "Say: Yes, I have a family",
      modelSentence: "Yes, I have a family.",
      modelModify: "Now you say it!"
    },
    // ... 9 more steps (10 total for Phase 1)
  ],
  
  scaffolding: {
    phase: 1,           // Phase 1 = Weeks 1-14
    coreTurns: 7,       // Core mission turns
    expansionTurns: 3,  // Additional exploration
    maxTurns: 10
  },
  
  novaPersonality: {
    traits: ["warm", "family-loving", "uses_emojis"],
    dadJokes: [
      "Why do families love photos? Because they're picture-perfect! üì∏",
      // ... 2-3 jokes per mission
    ],
    emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶"
  }
});

export default week2FamilyIntroduction;
```

**Central Registry Pattern:**
```javascript
// src/data/storyMissions.js
import week1FirstDay from './missions/week1_first_day';
import week2FamilyIntroduction from './missions/week2_family_introduction';
// ... import all missions

export const Week1Missions = [week1FirstDay, week1MyClassroom, week1SchoolFriends];
export const Week2Missions = [week2FamilyIntroduction, week2FamilyRoles, week2FamilyActivities];

export function getMissionsForWeek(weekId) {
  if (weekId === 1) return Week1Missions;
  if (weekId === 2) return Week2Missions;
  // ... add more weeks
  return [];
}

export function getMissionById(missionId) {
  const allMissions = [...Week1Missions, ...Week2Missions];
  return allMissions.find(m => m.id === missionId);
}
```

**Dynamic Loading in UI:**
```javascript
// src/modules/ai_tutor/tabs/StoryMissionTab.jsx
import { getMissionsForWeek } from '../../../data/storyMissions';

export default function StoryMissionTab({ weekData, recognitionRef }) {
  // ‚úÖ Dynamic loading based on weekId (not hardcoded)
  const missions = getMissionsForWeek(weekData?.weekId || 1);
  
  // ... rest of component
}
```

**Benefits:**
- ‚úÖ One file per mission (clear separation of concerns)
- ‚úÖ Scalable to 144 weeks (432 mission files = 3 per week)
- ‚úÖ Version control friendly (git tracks changes per mission)
- ‚úÖ Modular imports (import only what you need)
- ‚úÖ Dynamic loading via central registry (no hardcoded week IDs in UI)
- ‚úÖ Schema validation via createMission() factory

**Mass Production Workflow:**
1. Extract week data from `syllabus_database.js` (grammar, topic, vocab)
2. Create 3 mission files: `week{N}_mission1.js`, `week{N}_mission2.js`, `week{N}_mission3.js`
3. Each mission focuses on different aspect of week topic
4. Update `storyMissions.js` to add `Week{N}Missions` array and update `getMissionsForWeek()`
5. Test missions in UI (Week selector automatically loads new missions)

**Naming Convention:**
- Format: `week{N}_{theme}.js` (lowercase with underscores)
- Examples: 
  - Week 1: `week1_first_day.js`, `week1_my_classroom.js`, `week1_school_friends.js`
  - Week 2: `week2_family_introduction.js`, `week2_family_roles.js`, `week2_family_activities.js`
  - Week 19: `week19_childhood_memories.js`, `week19_baby_photos.js`, `week19_growing_up.js`

**Legacy Format (Deprecated):**
```
src/data/storyMissions.js  # All missions in one file
‚îî‚îÄ‚îÄ export const Week1Missions = [{...}, {...}, {...}];
```
- ‚ùå Not scalable (file would be >50,000 lines for 144 weeks)
- ‚ùå Merge conflicts when multiple people edit
- ‚ö†Ô∏è Use ONLY for prototyping/testing

### 8.2. AI Beat Length Rules (MODE-SPECIFIC + SCAFFOLDING)

**UPDATED - Word Count Scaffolding by Phase:**

| Phase | Weeks | Word Limit | Rationale |
|-------|-------|-----------|-----------|
| **Phase 1** | 1-14 | 7-16 words | A0++ Vietnamese ESL beginners - need simple, direct questions |
| **Phase 1.2** | 15-28 | 20-35 words | A1 learners - can handle more context |
| **Phase 2+** | 29+ | 30-50 words | A1+ advanced - personality-rich narration |

**Phase 1 (Weeks 1-14) Characteristics:**
- **Simple questions:** Direct, no elaborate context
- **Example:** "{{name}}! I like your name! How old are you?" (9 words) ‚úÖ
- **Why shorter:** Vietnamese A0++ students have 30-45 second attention span
- **Focus:** Clear question, minimal distraction
- **TTS speed:** 0.8x (20% slower) for clarity

**Phase 1.2 (Weeks 15-28) Characteristics:**
- **Add context:** 1-2 sentences before question
- **Example:** "{{name}}, that's a great name! I remember a student named {{name}} who loved science. What about you? What's your favorite subject?" (25 words) ‚úÖ
- **Why longer:** A1 students can process compound sentences
- **TTS speed:** 0.9x (10% slower)

**Phase 2+ (Weeks 29+) Characteristics:**
- **Personality-rich:** Witty tone, dad jokes, emojis
- **Example:** "{{name}}! What a cool name! You know, I once had a student named {{name}} who became amazing at English. I bet you'll be just as awesome! üåü Now, here's a fun question - how many candles were on your last birthday cake?" (42 words) ‚úÖ
- **Why longest:** A1+ students ready for natural conversation flow
- **TTS speed:** 1.0x (normal)

**Comparison Table:**

| Mode | Word Limit | Sentence Count | Use Case |
|------|-----------|----------------|----------|
| **Story Mission Phase 1** | 7-16 words | 1-2 sentences | Vietnamese ESL A0++ (Weeks 1-14) |
| **Story Mission Phase 1.2** | 20-35 words | 2-3 sentences | A1 learners (Weeks 15-28) |
| **Story Mission Phase 2+** | 30-50 words | 2-4 sentences | A1+ advanced (Weeks 29+) |
| Ask AI / Quiz | 10-15 words | 1-2 sentences | Factual Q&A interaction |
| Grammar Feedback | 15-20 words | 1-2 sentences | Correction + encouragement |

**Story Mission Special Requirements:**
- **Phase 1:** Direct questions, minimal personality (focus on clarity)
- **Phase 1.2:** Add mild encouragement, simple context
- **Phase 2+:** Full personality (witty tone, dad jokes, emojis üéíüìöüåü)
- **Character consistency:** Ms. Nova = encouraging academic mentor
- **Contractions:** Use in Phase 2+ only (gonna, wanna) - Phase 1 needs formal clarity

‚úÖ **CORRECT Phase 1 Beat (9 words):**
```javascript
aiPrompt: "{{name}}! I like your name! How old are you?"
// Simple, direct, clear question for A0++ students ‚úÖ
```

‚úÖ **CORRECT Phase 2+ Beat (42 words):**
```javascript
aiPrompt: "{{name}}! What a cool name! You know, I once had a student named {{name}} who became amazing at English. I bet you'll be just as awesome! üåü Now, here's a fun question - how many candles were on your last birthday cake?"
// Personality-rich, encouragement, rhetorical questions ‚úÖ
```

‚ùå **WRONG - Phase 1 with too many words (42 words):**
```javascript
aiPrompt: "{{name}}! What a cool name! You know, I once had a student named {{name}} who became amazing at English. I bet you'll be just as awesome! üåü Now, here's a fun question - how old are you?"
// ‚ùå Too long for A0++ beginners, will lose attention
```

‚ùå **WRONG - Phase 2+ too short (8 words):**
```javascript
aiPrompt: "Hi! What is your name?" // ‚ùå No personality, too terse for A1+ students
```

### 8.3. Audio Generation for Story Missions - RUNTIME TTS

**CRITICAL:** Story Mission audio CANNOT be pre-generated due to dynamic placeholders.

**Why Pre-Generation Doesn't Work:**
```javascript
// Mission text contains placeholders:
aiPrompt: "{{name}}! What a cool name! I once had a student named {{name}}..."

// Each student has different values:
Student A: "Alex! What a cool name! I once had a student named Alex..."
Student B: "Maria! What a cool name! I once had a student named Maria..."
```

**Solution: Runtime Text-to-Speech (TTS)**

**Updated Architecture (Dec 30, 2025):**
```javascript
// StoryMissionEngine.js
async generateTurn(userInput) {
  const step = this.mission.steps[this.state.currentStep];
  
  // 1. Apply fuzzy matching to user input (pronunciation error correction)
  const correctedInput = this._applyFuzzyMatching(userInput);
  
  // 2. Extract student context from response
  this._extractContext(correctedInput);
  
  // 3. Replace placeholders with actual student context (8 fields)
  let personalizedText = replacePlaceholders(step.aiPrompt, this.state.studentContext);
  
  // 4. Generate gentle error correction (recast technique)
  const correction = this._generateRecast(correctedInput, step);
  if (correction) {
    // Prepend correction before main response (natural flow)
    personalizedText = `${correction} ${personalizedText}`;
  }
  
  // 5. Get scaffolded TTS speed (Phase 1: 0.8x, Phase 1.2: 0.9x, Phase 2+: 1.0x)
  const speed = this._getTTSSpeed();
  
  // 6. Generate TTS audio on-the-fly
  const audioBlob = await generateTTS(personalizedText, {
    voice: 'shimmer',  // OpenAI TTS - clear, bright female voice (changed from 'nova')
    speed: speed       // Scaffolded speed for Vietnamese ESL A0++ beginners
  });
  
  // 7. Play audio
  await playAudio(audioBlob);
  
  return {
    story_beat: personalizedText,
    task: step.task,
    scaffold: { hints: step.hints }
  };
}
```

**TTS Provider: OpenAI TTS**
- **Voice:** `shimmer` (female, clear, bright tone - better for Vietnamese ESL A0++ students)
  - **Alternatives:** `nova` (warm), `alloy` (neutral), `echo` (male), `fable` (British), `onyx` (deep male)
  - **Why shimmer:** Clear consonants, bright pitch, easy to hear for 6-12 year olds
- **Model:** `tts-1` (standard) or `tts-1-hd` (high quality)
- **Cost:** ~$15/1M characters (~$0.01 per mission completion)
- **Latency:** ~1-2 seconds for 200 characters
- **Speed Scaffolding:**
  - **Phase 1 (Weeks 1-14):** 0.8x speed (20% slower) - Vietnamese ESL A0++ beginners need time to process
  - **Phase 1.2 (Weeks 15-28):** 0.9x speed (10% slower) - A1 learners building fluency
  - **Phase 2+ (Weeks 29+):** 1.0x speed (normal) - A1+ advanced students

**Placeholder System (8 Fields):**
```javascript
// studentContext state (tracked across conversation)
{
  name: null,           // "Khan"
  age: null,            // "10"
  teacherName: null,    // "Mr Chin"
  subject: null,        // "Math"
  hasFriends: null,     // true/false
  favoritePlace: null,  // "the playground" (NEW)
  friendName: null,     // "Noon" (NEW)
  activity: null,       // "play" (NEW)
  object: null          // "desk" (NEW)
}

// Usage in mission steps:
aiPrompt: "{{name}}! I like your name! How old are you?"
aiPrompt: "{{age}} years old! Good! Who is your teacher?"
aiPrompt: "{{teacherName}} is your teacher! What is your favorite subject?"
aiPrompt: "{{subject}}! Cool! Do you have friends at school?"
aiPrompt: "Nice! {{favoritePlace}}! Do you play there with friends?"
aiPrompt: "{{friendName}}! Nice! What do you and {{friendName}} do at school?"
aiPrompt: "Fun! Do you like to {{activity}}?"
aiPrompt: "Good! A {{object}}! Where is your {{object}} in the classroom?"
```

**Fuzzy Matching for Pronunciation Errors (Vietnamese ESL A0++):**
```javascript
// Common Vietnamese ESL pronunciation errors (automatic correction before processing)
const fuzzyMap = {
  'play crown': 'playground',       // /kr/ cluster ‚Üí /gr/
  'play ground': 'playground',      // Space insertion
  'class room': 'classroom',        // Space insertion
  'black board': 'blackboard',      // Space insertion
  'reading corn': 'reading corner', // /…îÀêr/ ‚Üí /…îÀêrn/
  'my near': 'my name',             // /ne…™m/ ‚Üí /n…™…ôr/
  'my nay': 'my name',              // /ne…™m/ ‚Üí /na…™/
  'tea chair': 'teacher',           // /t É/ ‚Üí /t Ée…ôr/
  'mis chin': 'mr chin',            // Vietnamese name pronunciation
  'no on': 'noon',                  // Vietnamese name (double vowel)
  'can': 'khan'                     // Vietnamese name (tone confusion)
};

// Applied BEFORE context extraction and error detection
// Example: User says "play crown" ‚Üí System hears "playground"
// Result: No error correction needed, natural flow maintained
```

**Recast Technique (Gentle Error Correction):**
```javascript
// Detects common Vietnamese ESL A0++ errors WITHOUT saying "wrong" or "incorrect"
// Models correct form naturally in conversation flow

// 1. Missing articles (a/an/the)
Input:  "i like playground"
Recast: "I like THE playground too! Do you play there with friends?"
        ‚îî‚îÄ correction ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ natural continuation ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

// 2. Missing "is" in sentences
Input:  "my name Khan"
Recast: "Your name IS Khan! How old are you?"
        ‚îî‚îÄ correction ‚îÄ‚îò ‚îî‚îÄ next question ‚îÄ‚îò

// 3. Verb agreement errors
Input:  "my teacher school at Mr Chin"
Recast: "Your teacher IS Mr Chin! Good!"
        ‚îî‚îÄ‚îÄ‚îÄ correction ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî praise ‚îò

// 4. Wrong word order
Input:  "turn on my desk"
Recast: "You have a DESK in your classroom! Where is it?"
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ correction ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ follow-up ‚îÄ‚îò

// Pedagogical basis:
// - Recast technique proven effective in ESL research
// - Models correct form without negative feedback
// - Student implicitly learns grammar rules
// - Maintains confidence and motivation
```

**Implementation:**
```javascript
// services/tts.js
import OpenAI from 'openai';

const openai = new OpenAI({ apiKey: import.meta.env.VITE_OPENAI_API_KEY });

const DEFAULT_VOICE = 'shimmer'; // Changed from 'nova' (Dec 30, 2025)

export async function generateTTS(text, options = {}) {
  try {
    const response = await openai.audio.speech.create({
      model: options.model || 'tts-1',
      voice: options.voice || DEFAULT_VOICE,
      input: text,
      speed: options.speed || 1.0
    });
    
    const audioBuffer = await response.arrayBuffer();
    return new Blob([audioBuffer], { type: 'audio/mpeg' });
  } catch (error) {
    console.error('TTS generation failed:', error);
    return null; // Fallback: text-only mode
  }
}

// Placeholder replacement function (expanded to 8 fields)
export function replacePlaceholders(text, context) {
  return text
    .replace(/\{\{name\}\}/g, context.name || 'Student')
    .replace(/\{\{age\}\}/g, context.age || '10')
    .replace(/\{\{teacherName\}\}/g, context.teacherName || 'your teacher')
    .replace(/\{\{subject\}\}/g, context.subject || 'English')
    .replace(/\{\{favoritePlace\}\}/g, context.favoritePlace || 'that place')
    .replace(/\{\{friendName\}\}/g, context.friendName || 'your friend')
    .replace(/\{\{activity\}\}/g, context.activity || 'play')
    .replace(/\{\{object\}\}/g, context.object || 'that');
}
```

**Optional: Caching Strategy**
```javascript
// Cache common phrases to reduce TTS calls
const CACHED_PHRASES = {
  "What's your name?": "/audio/common/whats_your_name.mp3",
  "How old are you?": "/audio/common/how_old.mp3"
};

// Only generate TTS for unique personalized parts
if (CACHED_PHRASES[cleanText]) {
  return CACHED_PHRASES[cleanText];
} else {
  return await generateTTS(text);
}
```

### 8.4. Complete 3-Level Scaffold System

**Full Implementation:**

```javascript
// missionSchema.js
export const MissionStep = {
  stepId: 0,
  aiPrompt: "",
  expected: { type: "short_answer" },
  
  // Level 1: Word Chips (clickable tokens)
  hints: [],              // ["My", "name", "is"]
  
  // Level 2: Sentence Starter (fill-in-blank)
  repair: "",             // "Try saying: My name is _____"
  
  // Level 3: Model Sentence + Modification
  modelSentence: "",      // "My name is Alex."
  modelModify: ""         // "Now say YOUR name instead of 'Alex'."
};
```

**When to Escalate:**

| Condition | Action | UI Display |
|-----------|--------|------------|
| Student tries freely | No scaffold | Input box only |
| Student writes <3 words | Show Level 1 | Green chips: [My] [name] [is] |
| Student stuck 30+ seconds | Show Level 2 | "Try saying: My name is ___" |
| Student clicks "Help" | Show Level 3 | "Say: 'My name is Alex.' Now try with YOUR name." |

### 8.5. State Persistence (Two Types)

**1. Local State (In-Memory, Non-Persistent):**
- **Managed by:** StoryMissionEngine class
- **Purpose:** Manage conversation flow, track current context
- **Resets when:** Mission restarted, page refreshed

**2. Global State (Persistent via tutorStore):**
- **Managed by:** tutorStore (Zustand state)
- **Purpose:** Track long-term progress, vocabulary mastery
- **Persists:** localStorage across sessions

### 8.6. Mass Production Workflow (144 Weeks)

**Complete End-to-End Workflow:**

**Step 1: Generate Mission Content**
```bash
node tools/generate_story_missions.js <WEEK_ID>
# Generates 3 files: week{WEEK_ID}_easy.js, _normal.js, _challenge.js
```

**Content Generation Rules by Level:**

| Level | Steps | Words/Beat | Vocab Scope | Grammar Complexity |
|-------|-------|-----------|-------------|-------------------|
| Easy | 6 | 30-40 | Core 50% of week vocab | Simple S-V-O |
| Normal | 6 | 35-45 | Full week vocab list | Compound sentences |
| Challenge | 8 | 40-50 | Week vocab + 2-3 bonus | Complex clauses |

**Step 2: Validate Mission Structure**
```bash
node tools/validate_missions.js <WEEK_ID>

# Validation checks (must ALL pass):
# 1. File existence: 3 mission files present
# 2. Step count: Easy/Normal=6, Challenge=8
# 3. Word count: Phase-appropriate (Phase 1: 7-16, Phase 1.2: 20-35, Phase 2+: 30-50)
# 4. Vocabulary: All words from syllabus week only
# 5. Grammar: NO structures beyond week scope (Present Simple ONLY for A0++ weeks)
# 6. Scaffold: All 3 levels present
# 7. Success criteria: mustUseWords defined (min 4 words)
# 8. Placeholders: All 8 fields used correctly ({{name}}, {{age}}, {{teacherName}}, {{subject}}, {{favoritePlace}}, {{friendName}}, {{activity}}, {{object}})
# 9. Personality: Phase-appropriate (Phase 1: minimal, Phase 2+: full)
# 10. Schema: Matches missionSchema.js structure
# 11. Error patterns: Recast rules cover common Vietnamese ESL A0++ errors (missing articles, missing "is", verb agreement, word order)
# 12. Fuzzy matching: Pronunciation error map includes Vietnamese-specific patterns
# 13. ALL stations: Grammar violations check (no past tense in Week 1-14)
# 14. ALL stations: Audio generation readiness (audio_url fields present)
# 15. Explore station: No conditional tenses in Phase 1 questions
```

**Step 3: Integration Test (Audio generated at runtime)**
```bash
npm run dev
# Manual testing:
# 1. Navigate to Week {WEEK_ID} ‚Üí AI Tutor ‚Üí Story Mission
# 2. Verify all 3 missions appear
# 3. Complete one mission end-to-end
# 4. Check progress persists on refresh
```

**Step 5: Batch Generation (Weeks 1-144)**
```bash
for week in {1..144}; do
  echo "üöÄ Generating Week $week..."
  
  node tools/generate_story_missions.js $week
  node tools/validate_missions.js $week
  if [ $? -ne 0 ]; then
    echo "‚ùå Week $week validation failed. Fix and retry."
    exit 1
  fi
  
  node tools/create_story_mission_audio_tasks.js $week
  python3 tools/generate_audio.py --provider openai --voice nova
  
  echo "‚úÖ Week $week complete"
  sleep 2
done
```

**Validation Checklist (Per Week):**
- [ ] 3 mission files created
- [ ] All missions use ONLY week syllabus vocab
- [ ] aiPrompt word count: 30-50 per beat
- [ ] All hints from grammarAllowed list
- [ ] Audio files generated (18-24 MP3s)
- [ ] Missions completable in app
- [ ] Progress persists on refresh
- [ ] Vocabulary mastery updates in tutorStore

---

## END OF MASTER PROMPT V23-FINAL (UPDATED WITH WEEK 1 LEARNINGS + AUDIO FIX + STORY MISSION COMPLETE)

### 7.20 SMARTCHECK FEATURE - COMPLETE COVERAGE (CRITICAL)

**Problem Found:**
Week 1 had SmartCheck PARTIALLY implemented - worked in Read/Explore but MISSING in Logic Lab and Ask AI.

**SmartCheck Purpose:**
Progressive disclosure learning system - students attempt answer first, then request hint if needed. Builds problem-solving confidence and reduces guessing.

**Stations Requiring SmartCheck:**

**1. Read Station** (`comprehension_questions`) - ‚úÖ Week 1 Fixed
```javascript
comprehension_questions: [
  {
    id: 1,
    question_en: "Where does Anna go?",
    answer: ["to school", "school", "to the school"],  // ‚úÖ Array of acceptable answers
    hint_en: "Look at the first sentence",             // ‚úÖ REQUIRED
    hint_vi: "Xem c√¢u ƒë·∫ßu ti√™n"                        // ‚úÖ REQUIRED
  }
]
```

**2. Explore Station** (`check_questions`) - ‚úÖ Week 1 Fixed
```javascript
check_questions: [
  {
    id: 1,
    question_en: "What do scientists use?",
    answer: ["microscope", "microscopes", "a microscope"],
    hint_en: "It makes small things bigger",           // ‚úÖ REQUIRED
    hint_vi: "N√≥ l√†m v·∫≠t nh·ªè to h∆°n"                   // ‚úÖ REQUIRED
  }
]
```

**3. Logic Lab Station** (`puzzles`) - ‚ùå Week 1 Missing ‚Üí ‚úÖ Fixed

**Problem:** All 5 puzzles had NO hints - students got stuck with no help.

**‚ùå WRONG Structure (Week 1 before fix):**
```javascript
puzzles: [
  {
    id: 1,
    context_en: "Alex's classroom has 20 desks arranged in rows...",
    question_en: "How many rows of desks are there?",
    answer: ["5", "5 rows", "five", "five rows"]
    // ‚ùå NO hint_en
    // ‚ùå NO hint_vi
  }
]
```

**‚úÖ CORRECT Structure (Week 19 + Week 1 fixed):**
```javascript
puzzles: [
  {
    id: 1,
    context_en: "Alex's classroom has 20 desks arranged in rows. Each row has 4 desks...",
    question_en: "How many rows of desks are there?",
    answer: ["5", "5 rows", "five", "five rows"],
    hint_en: "20 desks √∑ 4 desks per row",             // ‚úÖ REQUIRED - Math hint
    hint_vi: "20 b√†n √∑ 4 b√†n m·ªói h√†ng"                 // ‚úÖ REQUIRED
  }
]
```

**Hint Guidelines for Logic Lab:**
- Show math operation (e.g., "20 √∑ 4", "3 + 3")
- OR show formula breakdown (e.g., "Backpack (2kg) + Books (3kg)")
- Keep hints SHORT (under 10 words)
- Don't give direct answer, give method

**4. Ask AI Station** (`prompts`) - ‚ùå Week 1 Wrong Field Names ‚Üí ‚úÖ Fixed

**Problem:** Used `acceptable_answers` instead of `answer`, and completely missing `hint` field.

**‚ùå WRONG Structure (Week 1 before fix):**
```javascript
prompts: [
  {
    id: 1,
    context_en: "Alex is a young student who loves learning...",
    question_en: "How do you think children go to school?",
    acceptable_answers: ["By bus", "By boat", "By walking"]  // ‚ùå WRONG field name
    // ‚ùå NO hint field
    // ‚ùå NO audio_url field
  }
]
```

**‚úÖ CORRECT Structure (Week 19 + Week 1 fixed):**
```javascript
prompts: [
  {
    id: 1,
    context_en: "You are looking at your parents' wedding photo...",
    audio_url: "/audio/week1/ask_ai_1.mp3",           // ‚úÖ REQUIRED
    answer: ["How old were you?", "What was the weather like?"],  // ‚úÖ Correct field name
    hint: "How old... / What was..."                   // ‚úÖ REQUIRED - Question patterns
  }
]
```

**Hint Guidelines for Ask AI:**
- Show question PATTERNS (e.g., "How... / What... / Why...")
- NOT specific answers - guide question formation
- Help students phrase critical thinking questions
- Examples: "How do they... / By bus / By boat" OR "What tool... / Which tool..."

---

### 7.21 SMARTCHECK VALIDATION CHECKLIST

**Before generating any new week, verify ALL 4 stations have hints:**

**Structural Validation:**
```bash
# Check Read station
grep -A5 'comprehension_questions' src/data/weeks/week_XX/read.js | grep 'hint_en'
# Should return 3 matches (one per question)

# Check Explore station
grep -A5 'check_questions' src/data/weeks/week_XX/explore.js | grep 'hint_en'
# Should return 3 matches

# Check Logic Lab
grep -A5 'puzzles' src/data/weeks/week_XX/logic.js | grep 'hint_en'
# Should return 5 matches (one per puzzle)

# Check Ask AI
grep 'hint:' src/data/weeks/week_XX/ask_ai.js
# Should return 5 matches
grep 'answer:' src/data/weeks/week_XX/ask_ai.js
# Should return 5 matches (NOT 'acceptable_answers')
```

**Functional Validation (In-App Test):**
1. **Read**: Click comprehension question ‚Üí Enter wrong answer ‚Üí Click lightbulb icon ‚Üí Hint appears
2. **Explore**: Scroll to bottom ‚Üí Click SmartCheck question ‚Üí Wrong answer ‚Üí Click lightbulb ‚Üí Hint appears
3. **Logic Lab**: Click puzzle ‚Üí Wrong answer ‚Üí Click "Show Hint" button ‚Üí Hint displays below input
4. **Ask AI**: Click situation ‚Üí Type response ‚Üí (Hint shows question patterns to guide student)

**Component Files That Use SmartCheck:**
- `/src/modules/read/ReadingExplore.jsx` - Lines 198 (hint display)
- `/src/modules/explore/Explore.jsx` - Lines 142 (hint display)
- `/src/modules/logic/LogicLab.jsx` - Lines 139 (hint display)
- `/src/modules/ai_tutor/AITutor.jsx` - Lines 5 (uses analyzeAnswer)
- `/src/utils/smartCheck.js` - Core validation logic

**Why SmartCheck Matters:**
- Pedagogical: Promotes self-correction and critical thinking
- UX: Reduces frustration - students never "stuck" permanently
- Engagement: Interactive feedback loop (try ‚Üí fail ‚Üí hint ‚Üí try again ‚Üí success)
- Scaffolding: Hints bridge gap between "I don't know" and "I got it"

---

### 7.22 COMMON SMARTCHECK ERRORS & PREVENTION

**Error 1: Missing Hints in Logic Lab**
- **Symptom:** "Show Hint" button appears but shows nothing
- **Root Cause:** Puzzles have no `hint_en`/`hint_vi` fields
- **Prevention:** Copy Week 19 Logic structure EXACTLY, ensure all 5 puzzles have hints
- **Fix:** Add hint showing math operation or formula breakdown

**Error 2: Wrong Field Names in Ask AI**
- **Symptom:** Answer validation not working
- **Root Cause:** Using `acceptable_answers` instead of `answer`
- **Prevention:** Use Week 19 Ask AI as template (has `answer` + `hint` + `audio_url`)
- **Fix:** Rename field + add `hint` with question patterns

**Error 3: Hints Too Specific**
- **Symptom:** Hint gives away the answer directly
- **Root Cause:** Hint says "The answer is..." instead of guiding thinking
- **Prevention:** 
  - Logic Lab: Show operation ("20 √∑ 4") not answer ("5")
  - Read/Explore: Show location ("Look at paragraph 2") not answer
  - Ask AI: Show pattern ("How do...") not full question
- **Fix:** Rewrite hints as guidance not solutions

**Error 4: Missing SmartCheck in Easy Mode**
- **Symptom:** Easy mode has questions but no hints
- **Root Cause:** Forgot to add hints when creating Easy mode files
- **Prevention:** When copying Advanced ‚Üí Easy, keep SAME hint structure (just simplify content)
- **Fix:** Copy hint structure from Advanced mode

**Error 5: Hint Icon Not Clickable**
- **Symptom:** Lightbulb icon shows but clicking does nothing
- **Root Cause:** Component expects `hint_en`/`hint_vi` but field is `hint` or missing
- **Prevention:** 
  - Read/Explore: Use `hint_en` + `hint_vi`
  - Logic Lab: Use `hint_en` + `hint_vi`
  - Ask AI: Use `hint` (single field, not _en/_vi)
- **Fix:** Check component code to see which field name expected

---

### 7.23 SMARTCHECK SUMMARY (WEEK 1 LEARNINGS)

**Stations Audited:** 4 out of 15 (Read, Explore, Logic Lab, Ask AI)

**Errors Found:**
- Error 11: Logic Lab missing hints (0/5 puzzles had hints)
- Error 12: Ask AI wrong field names + missing hints

**Fixes Applied:**
- Logic Lab: Added `hint_en` + `hint_vi` to all 5 puzzles
- Ask AI: Renamed `acceptable_answers` ‚Üí `answer`, added `hint` field to all 5 prompts
- Easy mode: Applied same fixes

**Impact Prevention:**
- 143 remaining weeks now have SmartCheck validation in checklist
- Section 7.21 provides grep commands to verify before asset generation
- Section 7.22 prevents 5 common SmartCheck mistakes

**Blueprint Alignment:**
SmartCheck is core pedagogical feature - ALL stations with student-answered questions MUST have hints. Without hints, feature is broken and students lose learning support.

---

## 7.27 WEEK 2 CRITICAL FIXES & REQUIREMENTS (DECEMBER 30, 2025)

**Background:** Week 2 initial deployment revealed multiple systematic issues that violated blueprint requirements and caused poor user experience. All fixes documented here are MANDATORY for remaining 142 weeks.

### 7.27.1 TTS PRONUNCIATION FIXES (CRITICAL)

**Problem:** TTS was reading underscores `___` as "blank" instead of natural pauses.

**User Feedback:** "Sao l·∫°i ƒë·ªçc c·∫£ black v·∫≠y?" (Why reading "black"?)

**Root Cause:** Audio generation didn't prepare text for natural speech.

**‚úÖ FIX IMPLEMENTED:**
```javascript
// src/services/tts.js - Added prepareTTSText function
function prepareTTSText(text) {
  return text
    .replace(/___+/g, '...')           // Replace underscores with ellipsis
    .replace(/\s*\.\.\.\s*/g, ' ... ')  // Ensure proper spacing around ellipsis
    .replace(/\s+/g, ' ')              // Clean multiple spaces
    .trim();
}

// Usage in all TTS calls:
const cleanText = prepareTTSText(originalText);
await generateTTS(cleanText, options);
```

**MANDATORY RULE:** All text passed to TTS MUST use prepareTTSText() to ensure natural pronunciation.

**Areas Applied:**
- Mindmap stems/branches
- Word Power definitions
- All story content
- Grammar explanations

### 7.27.2 MINDMAP FORMAT STANDARDIZATION (CRITICAL)

**Problem:** Mindmap stems used inconsistent formats with underscores instead of ellipsis.

**User Feedback:** "Mindmap l√†m ch∆∞a ƒë√∫ng" (Mindmap not correct)

**Root Cause:** Generated stems used `___.` instead of blueprint-required `...` format.

**‚úÖ FIX IMPLEMENTED:**
```javascript
// BEFORE (Week 2 had this - WRONG):
centerStems: [
  "This is my _____.",           // ‚ùå Underscores
  "My family has _____."         // ‚ùå Underscores
]

// AFTER (CORRECT - Blueprint compliance):
centerStems: [
  "This is my ...",             // ‚úÖ Natural ellipsis
  "My family has ..."           // ‚úÖ Natural ellipsis
]
```

**MANDATORY RULE:** All mindmap stems MUST use `...` (ellipsis) never `___` (underscores).

**Validation Command:**
```bash
grep -r "___" src/data/weeks/week_*/mindmap.js
# Should return NO results for any week
```

### 7.27.3 ASK AI CONTEXT LENGTH REQUIREMENTS (CRITICAL)

**Problem:** Ask AI contexts were too verbose for A0++ ESL learners.

**User Feedback:** "Ask-AI th√¨ context d√†i qu√°" (Ask-AI context too long)

**Root Cause:** Contexts exceeded Phase 1 word limits (7-16 words for Weeks 1-14).

**‚úÖ FIX IMPLEMENTED:**
```javascript
// BEFORE (Week 2 had 35+ words - TOO LONG):
context_en: "You are looking at a photo of a beautiful family sitting together in their living room. The family members are smiling and look very happy. There is a father, mother, and children all wearing nice clothes."

// AFTER (CORRECT - 14 words for Phase 1):
context_en: "You see a family photo. Everyone is happy. You want to know about families."
```

**MANDATORY RULE:** Ask AI contexts MUST follow phase-based word limits:
- **Phase 1 (Weeks 1-14):** 7-16 words maximum
- **Phase 1.2 (Weeks 15-28):** 20-35 words maximum  
- **Phase 2+ (Weeks 29+):** 30-50 words maximum

### 7.27.4 DICTATION/SHADOWING FORMAT STANDARDIZATION (CRITICAL)

**Problem:** Week 2 Easy mode had different data structure than Advanced mode, causing UI rendering inconsistencies and broken functionality.

**User Feedback:** "Dictation v√† Shadowing chua wa hi·ªÉn th·ªã ƒë√∫ng" (Dictation and Shadowing not displaying correctly)

**Root Cause:** Easy mode created with simplified structure that didn't match component expectations.

**‚úÖ FIX IMPLEMENTED:**

**WRONG Structure (Week 2 had this - broke UI):**
```javascript
// ‚ùå WRONG - Simple content format (components can't parse this)
export default {
  title: "Listen and Write: My Family Squad",
  instruction_en: "Listen carefully...",
  content: "**This** is my **family**. We are a **team**...",  // ‚ùå Single text block
  audio_url: "/audio/week2/dictation_full_w2.mp3"
};
```

**‚úÖ CORRECT Structure (Week 19 format - components expect this):**
```javascript
// ‚úÖ CORRECT - Sentences array format (components can parse this)
export default {
  sentences: [                          // ‚úÖ REQUIRED array name
    { id: 1, text: "This is my family.", meaning: "ƒê√¢y l√† gia ƒë√¨nh t√¥i." },
    { id: 2, text: "We are a team.", meaning: "Ch√∫ng t√¥i l√† m·ªôt ƒë·ªôi." },
    { id: 3, text: "This is my father.", meaning: "ƒê√¢y l√† b·ªë t√¥i." },
    { id: 4, text: "He is the leader.", meaning: "B·ªë l√† ng∆∞·ªùi l√£nh ƒë·∫°o." },
    { id: 5, text: "This is my mother.", meaning: "ƒê√¢y l√† m·∫π t√¥i." },
    { id: 6, text: "She is kind.", meaning: "M·∫π r·∫•t t·ªët b·ª•ng." },
    { id: 7, text: "This is my brother.", meaning: "ƒê√¢y l√† anh trai t√¥i." },
    { id: 8, text: "He is a good helper.", meaning: "Anh ·∫•y l√† ng∆∞·ªùi gi√∫p ƒë·ª° t·ªët." }
  ]
};
```

**Shadowing Structure Fix:**
```javascript
// ‚ùå WRONG - Simple content format
export default {
  title: "Shadow Reading: My Family Squad",
  instruction_en: "Listen and repeat...",
  content: "**This** is my **family**...",  // ‚ùå Single text block
  audio_url: "/audio/week2/shadowing_full_w2.mp3"
};

// ‚úÖ CORRECT - Script array format
export default {
  title: "My Family Squad",
  audio_full: "/audio/week2/shadowing_full_w2.mp3",  // ‚úÖ Full audio file
  script: [                                           // ‚úÖ REQUIRED array name  
    { id: 1, text: "This is my family.", vi: "ƒê√¢y l√† gia ƒë√¨nh t√¥i.", audio_url: "/audio/week2/shadowing_1.mp3" },
    { id: 2, text: "We are a team.", vi: "Ch√∫ng t√¥i l√† m·ªôt ƒë·ªôi.", audio_url: "/audio/week2/shadowing_2.mp3" },
    { id: 3, text: "This is my father.", vi: "ƒê√¢y l√† b·ªë t√¥i.", audio_url: "/audio/week2/shadowing_3.mp3" },
    { id: 4, text: "He is the leader.", vi: "B·ªë l√† ng∆∞·ªùi l√£nh ƒë·∫°o.", audio_url: "/audio/week2/shadowing_4.mp3" },
    { id: 5, text: "This is my mother.", vi: "ƒê√¢y l√† m·∫π t√¥i.", audio_url: "/audio/week2/shadowing_5.mp3" },
    { id: 6, text: "She is kind.", vi: "M·∫π r·∫•t t·ªët b·ª•ng.", audio_url: "/audio/week2/shadowing_6.mp3" },
    { id: 7, text: "This is my brother.", vi: "ƒê√¢y l√† anh trai t√¥i.", audio_url: "/audio/week2/shadowing_7.mp3" },
    { id: 8, text: "He is a good helper.", vi: "Anh ·∫•y l√† ng∆∞·ªùi gi√∫p ƒë·ª° t·ªët.", audio_url: "/audio/week2/shadowing_8.mp3" }
  ]
};
```

**Critical Requirements:**
- **Sentence Count:** Dictation and Shadowing MUST have identical sentence count (8 in this case)
- **Text Content:** Shadowing `script[].text` MUST match Dictation `sentences[].text` exactly
- **Translations:** Shadowing `script[].vi` MUST match Dictation `sentences[].meaning` exactly
- **Source:** All sentences MUST come from read.js story (split naturally at sentence boundaries)
- **Audio:** Individual sentence audio files generated automatically by script

**UI Impact:**
- **Before Fix:** Dictation showed "Level 1: Unscramble words", Shadowing showed "Loading Script..."
- **After Fix:** Dictation shows proper sentence-by-sentence interface, Shadowing shows script with individual playback
- **Components:** DictationEngine.jsx and ShadowingEngine.jsx now receive expected data structure

### 7.27.5 OFFICIAL ASSET GENERATION SCRIPTS (MANDATORY)

**Problem:** Week 2 initially used manual asset creation instead of official scripts.

**User Feedback:** "sao l·∫°i b·∫°n t·ª± t·∫°o images. ƒê√£ c√≥ l·ªánh t·∫°o b·∫±ng Nano banana r·ªìi m√†????" (Why create images manually? There's already Nano Banana command)

**Root Cause:** Didn't discover/use the official asset generation tools in `tools/` directory.

**‚úÖ OFFICIAL SCRIPTS IDENTIFIED:**

**1. Image Generation:**
```bash
# FREE Gemini approach (Nano Banana):
node tools/generate_images_nano_banana.js <WEEK_ID>

# Paid Imagen 3 approach:
node tools/batch_manager.js <WEEK_ID> <WEEK_ID>
```

**2. Audio Generation:**
```bash
# Google Neural2 TTS (best quality):
node tools/generate_audio.js <WEEK_ID> <WEEK_ID>
```

**3. Video Generation:**
```bash
# YouTube API automated search:
node tools/update_videos.js <WEEK_ID> --reset
```

**MANDATORY RULE:** ALL asset generation MUST use official scripts. Never create assets manually unless scripts fail.

**API Key Loading:** All scripts auto-read from `API keys.txt` file (never hardcode).

### 7.27.6 AUDIO FILE FORMAT STANDARDIZATION (CRITICAL)

**Problem:** Scripts generate `.mp3` files but some data referenced `.aiff` format.

**User Feedback:** "dictation v√† shadowing v·∫´n ch∆∞a ƒë√∫ng path" (dictation and shadowing still wrong paths)

**Root Cause:** Inconsistent audio format expectations between scripts and data files.

**‚úÖ FIX IMPLEMENTED:**
```javascript
// CORRECT audio path format (all modes):
audio_url: "/audio/week2/shadowing_1.mp3"     // ‚úÖ .mp3 extension
audio_url: "/audio/week2_easy/dictation_1.mp3" // ‚úÖ .mp3 extension

// NEVER use:
audio_url: "/audio/week2/shadowing_1.aiff"    // ‚ùå .aiff not generated by scripts
```

**MANDATORY RULE:** All audio paths MUST use `.mp3` extension to match script output.

### 7.27.7 DAILY WATCH VIDEO CONTENT (CRITICAL)

**Problem:** Daily Watch showed placeholder data instead of real educational videos.

**User Feedback:** "Daily watch v·∫´n tr·ªëng kh√¥ng" (Daily watch still empty)

**Root Cause:** Video generation script wasn't run, left placeholder content.

**‚úÖ FIX IMPLEMENTED:**
- Created `video_queries.json` with 5 targeted search queries
- Ran `update_videos.js` to populate with real YouTube videos
- Updated both Advanced and Easy modes with same video content

**MANDATORY RULE:** Daily Watch MUST have exactly 5 real YouTube videos (never placeholders).

### 7.27.8 ERROR PREVENTION CHECKLIST (MANDATORY)

**Pre-Asset Generation Validation:**

```bash
# 1. TTS Text Validation
grep -r "___" src/data/weeks/week_XX/ 
# Should be EMPTY (no underscores in any content)

# 2. Mindmap Format Validation  
grep "centerStems" src/data/weeks/week_XX/mindmap.js | grep -c "\.\.\."
# Should equal number of stems (all use ellipsis)

# 3. Ask AI Length Validation
# Manually count words in each context_en - must be within phase limits

# 4. Schema Consistency Validation
diff <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks/week_XX/dictation.js) \
     <(grep -E "^[[:space:]]*[a-zA-Z_]+:" src/data/weeks_easy/week_XX/dictation.js)
# Should show NO differences (same field names)

# 5. Audio Format Validation
grep -r "\.aiff" src/data/weeks/week_XX/
# Should be EMPTY (only .mp3 allowed)

# 6. Video Content Validation
grep -c '"videoId"' src/data/weeks/week_XX/daily_watch.js
# Should return exactly 5
```

**Post-Asset Generation Validation:**
```bash
# 1. Audio File Count
ls public/audio/week2/*.mp3 | wc -l     # Should be ~120-130
ls public/audio/week2_easy/*.mp3 | wc -l # Should be ~120-130

# 2. Image File Count  
ls public/images/week2/*.jpg | wc -l     # Should be exactly 15
ls public/images/week2_easy/*.jpg | wc -l # Should be exactly 15

# 3. Video Validation
# Test each videoId loads in YouTube player
```

### 7.27.9 MASS PRODUCTION IMPLICATIONS

**For Remaining 142 Weeks:**

**Content Generation Rules:**
1. ALL mindmap stems MUST use `...` format (never `___`)
2. ALL Ask AI contexts MUST respect phase word limits
3. ALL audio paths MUST use `.mp3` extension
4. Advanced/Easy modes MUST use identical schemas

**Asset Generation Rules:**
1. ALWAYS use official scripts (never manual creation)
2. ALWAYS validate before generation (use checklist above)
3. ALWAYS test audio/video in app after generation

**Quality Assurance Rules:**
1. Each week MUST complete validation checklist before approval
2. User feedback patterns from Week 2 MUST be prevented
3. Blueprint compliance MUST be verified at each step

### 7.27.10 UPDATED ASSET GENERATION WORKFLOW

**Complete Week Generation Command Sequence:**
```bash
# Step 1: Clean old assets
rm -rf public/audio/week${WEEK} public/images/week${WEEK}
rm -rf public/audio/week${WEEK}_easy public/images/week${WEEK}_easy

# Step 2: Validate data structure
bash tools/validate_week_structure.sh ${WEEK}
if [ $? -ne 0 ]; then echo "‚ùå Validation failed"; exit 1; fi

# Step 3: Generate all assets using official scripts
node tools/generate_audio.js ${WEEK} ${WEEK}
node tools/generate_images_nano_banana.js ${WEEK}  # or batch_manager.js
node tools/update_videos.js ${WEEK} --reset

# Step 4: Verify asset counts
bash tools/verify_asset_counts.sh ${WEEK}
if [ $? -ne 0 ]; then echo "‚ùå Asset verification failed"; exit 1; fi

echo "‚úÖ Week ${WEEK} complete - all fixes applied"
```

**Blueprint Compliance Verification:**
- TTS pronunciation: Natural speech (no "blank" reading) ‚úÖ
- Mindmap format: Ellipsis stems for natural completion ‚úÖ  
- Ask AI length: Phase-appropriate word limits ‚úÖ
- Schema consistency: Unified Advanced/Easy structure ‚úÖ
- Asset quality: Real educational content (no placeholders) ‚úÖ

### 7.27.11 CRITICAL SUCCESS METRICS

**User Experience Indicators:**
- TTS sounds natural (no pronunciation errors)
- Mindmap stems feel natural to complete
- Ask AI contexts are digestible for A0++ learners
- Dictation/Shadowing UI works consistently across modes
- Daily Watch has engaging educational videos

**Technical Indicators:** 
- All validation commands return expected results
- Asset generation scripts complete without errors
- File counts match requirements (audio ~120-130, images 15, videos 5)
- No user complaints about "blank" reading or empty content

**Prevention Success:**
- Week 3+ users don't report Week 2 issue patterns
- Mass production generates consistently high-quality weeks
- Blueprint compliance maintained across all 144 weeks

---

## END OF MASTER PROMPT V23-FINAL (UPDATED: WEEK 1 + WEEK 2 COMPREHENSIVE FIXES)

### 7.24 CONTENT SIMPLIFICATION FOR BEGINNER ESL (A0+/A1)

**Issue Discovered:**
Week 1 Ask AI and Logic Lab content was structurally correct (proper keys, hints, SmartCheck) BUT pedagogically wrong for absolute beginners. Contexts used complex sentences, advanced vocabulary, and assumed prior language knowledge students don't have yet.

**Root Cause:**
- Misunderstood target audience reading level
- Forgot to check SYLLABUS for Week 1 scope: "I am", "This is", numbers 1-10, basic nouns
- Applied Week 19 STRUCTURE but not Week 19 PEDAGOGY (scaffolded, age-appropriate)
- Content creators must consult syllabus BEFORE writing to match student level

**Syllabus Context - Week 1: "Hello, World!" (Identity)**
```
- Topic: Introduction & Superheroes (Creating a "Hero Identity")
- Key Learning Outcome: Say and write sentences introducing name/age naturally
- Grammar Focus (Implicit): Pattern "I am..." (Identity)
- Vocabulary Focus: name, age, student, hero, power, boy, girl, numbers 1-10
- Target Level: A0+ (absolute beginners, 6-8 years old)
```

**Ask AI Simplification Rules for Early Weeks:**

1. **Sentence Length:** 
   - Advanced mode: MAX 10 words per sentence
   - Easy mode: MAX 5 words per sentence
   - Example:
     - ‚ùå "You are looking at a picture of a school in another country where children travel in many different ways"
     - ‚úÖ "You see a photo. Children go to school. Some walk. Some ride bikes."

2. **Explicit Scaffolding:**
   - MUST end with "You want to know [QUESTION WORD]. How do you ask?"
   - Examples:
     - "You see children. You want to know HOW they go. How do you ask?"
     - "You see a tool. You want to know WHAT it is. How do you ask?"
   - This teaches question formation explicitly (Shadow Asking per Blueprint Phase 1)

3. **Vocabulary Constraints:**
   - Use ONLY words from syllabus weeks 1-current
   - Avoid academic vocabulary (e.g., "microscope" ‚Üí "tool that makes things BIG")
   - Check: Can a 6-year-old with 50 English words understand this?

4. **Context Setup:**
   - Show ‚Üí Tell ‚Üí Ask pattern
   - "You see X" (visual anchor)
   - "You want to know Y" (explicit goal)
   - "How do you ask?" (explicit instruction)

**Logic Lab Simplification Rules for Early Weeks:**

1. **Number Constraints:**
   - Week 1-4: Numbers 1-10 ONLY
   - Operations: Simple addition (2+1), simple multiplication (2√ó3)
   - NO operations requiring carrying/borrowing
   - Example:
     - ‚ùå "10 students √ó 2 pencils = 20" (answer beyond 10)
     - ‚úÖ "3 students √ó 2 pencils = 6" (stays within 1-10 range)

2. **Context Brevity:**
   - Advanced mode: 15-20 words total
   - Easy mode: 10-12 words total
   - Remove all unnecessary adjectives/clauses
   - Example:
     - ‚ùå "Ms. Johnson gives each student 2 pencils and 1 eraser. There are 10 students in the class today."
     - ‚úÖ "Teacher gives 2 pencils. You are 3 students. How many pencils?"

3. **Single-Step Problems:**
   - Early weeks should require ONE operation only
   - NO multi-step reasoning until Week 10+
   - Week 1-5 examples:
     - Count pattern (star, moon, star, moon ‚Üí next?)
     - Simple addition (2 books + 1 book = ?)
     - Simple multiplication (3 students √ó 2 pencils = ?)

4. **Visual Clarity:**
   - Use emojis when possible (‚≠êüåô instead of "star and moon")
   - Concrete objects only (pencils, books, backpack)
   - NO abstract concepts until Week 20+

**Comparison Table - Before/After:**

| Aspect | ‚ùå BEFORE (Too Complex) | ‚úÖ AFTER (A0+ Appropriate) |
|--------|------------------------|---------------------------|
| **Ask AI Context** | "You are looking at a picture of a school in another country. The school building looks very different from your school. Some children are walking, some are on bicycles, and some are in boats on a river." (34 words) | "You see a photo. Children go to school. Some walk. Some ride bikes. You want to know HOW they go to school. How do you ask?" (25 words, shorter sentences) |
| **Ask AI Answer** | ["How do children go to school there?", "What time does school start?", "Is the school big or small?"] | ["How do they go to school?", "How do you go to school?"] (Simpler structure) |
| **Logic Lab Problem** | "Ms. Johnson gives each student 2 pencils and 1 eraser. There are 10 students in the class today. How many pencils does Ms. Johnson need in total?" (25 words, answer=20) | "Teacher gives 2 pencils to each student. There are 5 students. How many pencils?" (14 words, answer=10) |
| **Logic Lab Answer** | Answer requires calculation beyond syllabus number range (20) | Answer stays within Week 1 range (10) |

**Blueprint Compliance Check:**

**Ask AI Phase 1 (Weeks 1-18): "Shadow Asking"**
```
Goal: Luy·ªán ng·ªØ ƒëi·ªáu c√¢u h·ªèi (Mimicry)
Method: "You want to know... How do you ask?"
Example: H·ªèi ng∆∞·ªùi tr√¥ng th√∫ s∆∞ t·ª≠ ƒÉn g√¨: "What do lions eat?"
‚Üí Week 1 MUST use this exact pattern
```

**Logic Lab Phase 1 (Weeks 1-54): "Vocab & Patterns (Math Bridge)"**
```
Content: N·ªëi h√¨nh v·ªõi t·ª´, Quy lu·∫≠t m√†u s·∫Øc, ƒê·ªçc ph√©p t√≠nh
VƒÉn phong: Theo ƒë√∫ng vƒÉn phong b·∫£n x·ª© trong SGK (textbook word problems)
C·∫§M: T√≠nh to√°n ƒë·ªë m·∫πo ph·ª©c t·∫°p ho·∫∑c to√°n l·ªùi vƒÉn d√†i d√≤ng ·ªü Easy Mode
‚Üí Week 1 must use 1-10 numbers, single operations, <15 words
```

**Implementation Checklist for Future Weeks:**

Before writing ANY content for Weeks 1-20:
- [ ] Read syllabus entry for that week (vocabulary scope, grammar focus, target structures)
- [ ] Check previous week content to ensure progression (don't jump vocabulary tiers)
- [ ] Sentence length test: Read aloud - can a 6-year-old follow?
- [ ] Vocabulary test: Are all words within syllabus weeks 1-current?
- [ ] Number test (Logic Lab): Do answers stay within syllabus number range?
- [ ] Scaffolding test (Ask AI): Does context end with "How do you ask?" pattern?

**Error Prevention Strategy:**

When creating Week N content:
1. Open `1. NEW-FINAL_Khung CT_SYLLABUS_3yrs copy.txt`
2. Find Week N entry
3. Extract: Vocabulary Focus, Grammar Focus (Implicit), Key Learning Outcome
4. Write content using ONLY those constraints
5. Compare to Week N-1 (is this a natural progression?)
6. Compare to Week 19 (same scaffolding level for similar pedagogical goals?)

**Audio Regeneration Impact:**

After content simplification:
- Ask AI: 10 files need regeneration (5 Advanced + 5 Easy)
  - `ask_ai_1.mp3` through `ask_ai_5.mp3` (both modes)
- Logic Lab: 10 files need regeneration (5 Advanced + 5 Easy)
  - `logic_1.mp3` through `logic_5.mp3` (both modes)
- **Total: 20 audio files**

**Command to regenerate:**
```bash
node tools/create_audio_tasks_only.js 1 1
python3 tools/generate_audio.py --provider openai --voice nova
```


### 7.25 ADVANCED VS EASY MODE DIFFERENTIATION

**Issue Discovered:**
Content in Advanced and Easy modes was too similar - just shortened text, not true pedagogical differentiation. Additionally, symbols (‚≠êüåô) were used in Logic Lab instead of text/audio, violating speaking/listening practice requirements.

**Root Cause:**
- Easy mode created by copy-paste + shortening, not rethinking content
- Forgot that Easy mode serves DIFFERENT learning needs (slower pace, more scaffolding)
- Used visual symbols instead of audio/text (prevents speaking/listening practice)

**Critical Requirements:**

1. **NO SYMBOLS/EMOJIS in Logic Lab Content**
   - ‚ùå WRONG: "Look: ‚≠êüåô‚≠êüåô‚≠ê___. What next?"
   - ‚úÖ RIGHT: "Teacher says: star, moon, star, moon, star. What comes next?"
   - **Reason**: Students must HEAR pattern via audio, SPEAK answer aloud
   - Symbols bypass listening/speaking practice (students just look and click)

2. **Easy Mode ‚â† Shortened Advanced Mode**
   - Easy mode serves students who need:
     - Different content (not just shorter)
     - More scaffolding (not less)
     - Simpler vocabulary (not truncated sentences)
   - Example:
     - Advanced Logic Puzzle 2: "star, moon" pattern
     - Easy Logic Puzzle 2: "apple, banana" pattern (DIFFERENT items, simpler)

3. **Answer Variations Must Be Complete**
   - ‚ùå WRONG (Easy mode): answer: ["How do they go?", "How?"]
   - ‚úÖ RIGHT (Easy mode): answer: ["How do they go to school?", "How?"]
   - **Reason**: First answer MUST be complete sentence (teaching correct structure)
   - Additional shortened versions OK as alternates

**Differentiation Strategy:**

**Ask AI Advanced vs Easy:**
| Aspect | Advanced Mode | Easy Mode |
|--------|--------------|-----------|
| **Context length** | 15-25 words | 10-15 words |
| **Sentence structure** | 10 words/sentence | 5 words/sentence |
| **Answer variations** | 3-4 variations | 1-2 variations (first MUST be complete) |
| **Vocabulary** | Full syllabus week | Core 50% of syllabus week |
| **Scaffold detail** | "You want to know HOW they go" | "You want to know HOW" |

**Example - Ask AI Prompt 1:**
```javascript
// Advanced:
context_en: "You see a photo. Children go to school. Some walk. Some ride bikes. You want to know HOW they go to school. How do you ask?"
answer: ["How do they go to school?", "How do children go to school?", "How do you go to school?"]

// Easy:
context_en: "You see a photo. Children go to school. You want to know HOW. How do you ask?"
answer: ["How do they go to school?", "How?"]
// Note: First answer complete, second simplified
```

**Logic Lab Advanced vs Easy:**
| Aspect | Advanced Mode | Easy Mode |
|--------|--------------|-----------|
| **Numbers** | 1-10 (Week 1-4) | 1-5 preferred (Week 1) |
| **Operations** | 5√ó2=10 | 3√ó2=6 |
| **Pattern items** | Star/moon (celestial) | Apple/banana (familiar food) |
| **Context length** | 14-20 words | 10-12 words |
| **Answer precision** | Multiple units (10 pencils, ten) | Simpler (6, six) |

**Example - Logic Lab Puzzle 2:**
```javascript
// Advanced:
question_en: "Teacher says: star, moon, star, moon, star. What comes next?"
answer: ["moon", "the moon", "a moon"]
// Pattern: Celestial objects (more abstract)

// Easy:
question_en: "Teacher says: apple, banana, apple, banana. What is next?"
answer: ["apple", "an apple"]
// Pattern: Familiar foods (concrete, daily life)
```

**Symbol/Emoji Prohibition:**

**Logic Lab Rules:**
- NEVER use ‚≠êüåôüî∫‚¨ú or any visual symbols in question text
- ALWAYS write out words: "star, moon, triangle, square"
- ALWAYS provide audio of teacher reading pattern aloud
- **Reason**: Forces listening practice, enables speaking practice

**Exception - Images Only:**
- Vocab images CAN use symbols/illustrations (learning aid)
- Word Power images CAN show visual concepts
- BUT question/answer TEXT must be words, not symbols

**Validation Checklist:**

Before finalizing ANY content:
- [ ] **Symbol check**: Grep question_en for emoji/symbols (‚≠êüåôüî∫‚¨ú‚ù§Ô∏èüé®)
- [ ] **Pattern check (Easy)**: Does Easy mode use DIFFERENT items than Advanced?
- [ ] **Answer check (Easy)**: Is first answer a complete sentence?
- [ ] **Answer variety (Advanced)**: Are there 3+ variations showing different structures?
- [ ] **Audio check**: Does text make sense when read aloud (no symbols)?

**Implementation Example - Week 1 Fixed:**

**Logic Lab Puzzle 2:**
| Mode | Question | Answer | Reasoning |
|------|----------|--------|-----------|
| Advanced | "Teacher says: star, moon, star, moon, star. What comes next?" | ["moon", "the moon", "a moon"] | Abstract celestial pattern, 3 answer variations |
| Easy | "Teacher says: apple, banana, apple, banana. What is next?" | ["apple", "an apple"] | Concrete food pattern, 2 answer variations |

**Ask AI Prompt 1:**
| Mode | Context | Answer | Reasoning |
|------|---------|--------|-----------|
| Advanced | "You see a photo. Children go to school. Some walk. Some ride bikes. You want to know HOW they go to school. How do you ask?" | ["How do they go to school?", "How do children go to school?", "How do you go to school?"] | Full scaffold, 3 structural variations (they/children/you) |
| Easy | "You see a photo. Children go to school. You want to know HOW. How do you ask?" | ["How do they go to school?", "How?"] | Simplified scaffold, complete sentence first + ultra-short alternate |

**Error Prevention Strategy:**

When creating Easy mode:
1. Start with Advanced mode content
2. **Change content** (not just shorten):
   - Logic Lab: Use DIFFERENT pattern items (apple/banana vs star/moon)
   - Ask AI: Simplify context BUT keep answer complete
3. **Reduce variations** (not remove scaffolding):
   - Advanced: 3-4 answer variations
   - Easy: 1-2 answer variations (first complete)
4. **Verify audio-readability**:
   - Read question_en aloud
   - If you say emoji/symbol name instead of word ‚Üí WRONG
   - If text reads naturally ‚Üí CORRECT

**Audio Regeneration Impact:**

After differentiation fixes:
- Logic Lab Puzzle 2: 2 files (Advanced + Easy) - different text now
- Ask AI Prompts 1-5: 10 files (5 Advanced + 5 Easy) - varied answers
- **Total: 12 audio files need regeneration**

**Command:**
```bash
node tools/create_audio_tasks_only.js 1 1
python3 tools/generate_audio.py --provider openai --voice nova
```

**Blueprint Compliance:**

**Audio-First Learning (Blueprint Core Principle):**
> "Zero L1 Input (The Visual Anchor): All new concepts are introduced through a 'Visual Anchor'‚Äîa short video or engaging picture. The teacher uses Zero L1 (no native language), relying on gestures, miming, and expressions (Total Physical Response) to create a shared, non-verbal understanding before introducing English vocabulary."

Logic Lab patterns with symbols VIOLATE this:
- Student sees ‚≠êüåô ‚Üí recognizes visually ‚Üí no listening
- Correct: Student HEARS "star, moon, star, moon" ‚Üí must listen ‚Üí speaks answer

**Key Learning:**
- Easy mode serves DIFFERENT students (not just shorter content for SAME students)
- Visual shortcuts (symbols) bypass audio practice
- First answer in Easy mode must be complete (teaching correct structure)
- Differentiation = different content/patterns, not just length reduction


---

### 7.26 SMARTCHECK ANSWER VALIDATION & ASK AI STATION INTEGRITY

**Date Added:** 2025-12-28 Evening  
**Issues Fixed:** Errors 19-23  
**Impact:** Critical quality control failures in Logic Lab + Ask AI

---

#### Error 19-20: Logic Lab SmartCheck - Units Not Enforced

**Problem:** SmartCheck accepted bare numbers without units in math problems.

**Example:**
```javascript
// ‚ùå BEFORE (Week 1 Logic Puzzle 1):
question_en: "Teacher gives 2 pencils to each student. There are 5 students. How many pencils?"
answer: ["10", "10 pencils", "ten", "ten pencils"]
hint_en: "5 students √ó 2 pencils"

// Issue: Student types "10" ‚Üí ‚úÖ Accepted
// But "10" is incomplete (missing unit)
```

**Root Cause:**
- SmartCheck validates against `answer` array
- Array included both "10" (no unit) and "10 pencils" (with unit)
- Students could bypass unit requirement by typing bare number

**Fix Applied:**
```javascript
// ‚úÖ AFTER:
answer: ["10 pencils", "ten pencils"]  // Removed "10", "ten"
hint_en: "Remember to write the UNIT: ___ pencils"

// Now: Student types "10" ‚Üí ‚ùå Rejected
// Must type "10 pencils" or "ten pencils" ‚Üí ‚úÖ Accepted
```

**Impact:** 3 math puzzles √ó 2 modes = 6 puzzles fixed

**Pedagogical Rationale:**
- Math answers MUST include units (Blueprint: "hands-on, real-world context")
- "10" means nothing without context (10 what? Apples? Cars? Dollars?)
- Teaching proper mathematical communication

**Hint Strategy:**
- Advanced: "Remember to write the UNIT: ___ [unit]" (explicit instruction)
- Easy: "Write: ___ [unit]" (simpler phrasing, same requirement)

---

#### Error 21-22: Ask AI Station Purpose Violation

**Problem:** Easy mode Ask AI had students ANSWERING questions instead of ASKING questions.

**Example:**
```javascript
// ‚ùå BEFORE (Week 1 Easy Prompt 1):
context_en: "Your friend asks: 'Do you go to school?' You want to explain HOW you go. What do you say?"
answer: ["I go by bus", "I walk", "I go by bike"]

// Issue: Students are ANSWERING, not ASKING
// Station purpose violated: Ask AI = Students learn to ASK questions
```

**Root Cause:**
- Misunderstood station purpose
- Thought Easy mode meant "simpler answers" ‚Üí changed from questions to statements
- Forgot Blueprint requirement: "Shadow Asking Phase 1... h·ªçc sinh c√≥ th·ªÉ suy di·ªÖn ra ƒë∆∞·ª£c c√¢u h·ªèi"

**Fix Applied:**
```javascript
// ‚úÖ AFTER:
context_en: "You see a picture. A child is going to school. You want to know HOW. What do you ask?"
answer: ["How do you go?", "How do you go to school?", "How?"]
hint: "How..."

// Now: Students learn to ASK "How do you go to school?" (correct station purpose)
```

**Reference: Week 19 Easy Ask AI Pattern:**
```javascript
context_en: "You see an old photo of yourself as a baby... You want to know more"
answer: ["Was I cute?", "How old was I?", "Was I a good baby?"]
hint: "Was I..."
```

**Station Purpose Rules:**
1. **Ask AI = Students MUST ASK questions** (never answer questions)
2. Easy mode = Simpler questions (fewer words), not different activity
3. First answer in Easy mode should be complete question
4. Additional shortened versions allowed ("How?" after "How do you go?")

**Hint Patterns:**
- Advanced: Multiple patterns ("How do they... / How do you...")
- Easy: Single simple pattern ("How...", "Was I...", "Where are...")

---

#### Error 23: Ask AI Answer Missing Key Nouns

**Problem:** Answer variations omitted important keywords from context.

**Example:**
```javascript
// ‚ùå BEFORE (Week 1 Easy Prompt 3):
context_en: "You are at the library. You want ANIMAL books. You want to know WHERE"
answer: ["Where are the books?", "Where is it?"]
//         ‚ùå Missing "animal" keyword

// Issue: Context says "animal books" but answer just says "books"
```

**Root Cause:**
- Over-simplified for Easy mode
- Thought removing adjectives made questions "easier"
- Forgot: Keywords teach students to ask about SPECIFIC things

**Fix Applied:**
```javascript
// ‚úÖ AFTER:
answer: ["Where are the animal books?", "Where are animal books?"]
//         ‚úÖ Includes "animal" keyword

// Now teaches: Ask about SPECIFIC type of books (animal books vs story books vs science books)
```

**Comparison:**
- Advanced: ["Where are the animal books?", "Where can I find animal books?", "Where are animal books?"]  
  ‚Üí 3 variations, ALL include "animal" ‚úÖ
- Easy: ["Where are the animal books?", "Where are animal books?"]  
  ‚Üí 2 variations, ALL include "animal" ‚úÖ

**Key Learning:**
- **Answer MUST include all key nouns from context**
- If context says "animal books", answer must say "animal books"
- If context says "magnifying glass", answer must say "magnifying glass"
- Easy mode can have fewer variations, but must keep keywords
- Simplification = shorter phrasing, NOT omitting information

---

#### Validation Checklist (Pre-Publication)

**Logic Lab Math Problems:**
- [ ] Answer array contains ONLY answers with units (no bare numbers)
- [ ] Hint reminds about units: "Remember to write: ___ [unit]"
- [ ] Question clearly states what unit is expected (pencils, books, kg, etc.)
- [ ] SmartCheck will reject incomplete answers (test with bare number)

**Ask AI Prompts:**
- [ ] Station purpose: Students ASK questions (not answer questions)
- [ ] Context ends with: "How do you ask?" or "What do you ask?"
- [ ] ALL answer variations are QUESTIONS (end with ? or use question structure)
- [ ] Answer includes ALL key nouns from context (check for missing keywords)
- [ ] Easy mode: First answer is complete question (additional shortened versions OK)
- [ ] Hint pattern matches answer structure ("How...", "Where are...", "Was I...")

**Error Prevention Strategy:**
1. **Before writing Ask AI prompts:**
   - Re-read station purpose: Students must ASK questions
   - Check Week 19 examples for pattern reference
   - Verify ALL answers are questions (not statements)

2. **Before removing content for Easy mode:**
   - List ALL key nouns in context (adjectives + nouns)
   - Verify ALL answers contain ALL key nouns
   - Simplify structure, not information

3. **Before accepting SmartCheck answers:**
   - For math: Require units in ALL answer variations
   - Remove any answers without units
   - Update hint to remind about units

---

#### Audio Regeneration Impact

**Files Regenerated:**
- `week1_easy/ask_ai_1.mp3` (Fixed station purpose - from answer to ask)
- `week1_easy/ask_ai_3.mp3` (Added missing "animal" keyword)

**Total:** 2 audio files regenerated

**Note:** Logic Lab audio unchanged (questions stayed same, only `answer` arrays modified - no audio impact)

---

#### Statistics

**Errors Fixed:**
| Error | Type | Station | Impact |
|-------|------|---------|--------|
| 19 | SmartCheck | Logic Lab | 6 puzzles (removed bare numbers from answers) |
| 20 | Hints | Logic Lab | 6 puzzles (changed hints to remind about units) |
| 21 | Context | Ask AI Easy | 1 prompt (context didn't match answer type) |
| 22 | Station Purpose | Ask AI Easy | 1 prompt (students answered instead of asked) |
| 23 | Keywords | Ask AI Easy | 1 prompt (missing "animal" keyword) |

**Total Errors Fixed:** 23  
**Total Files Modified:** 3 (logic.js √ó 2, ask_ai.js √ó 1)  
**Total Audio Regenerated:** 2 files

---

#### Master Prompt V23 Line Count Update

- **Before Section 7.26:** 2822 lines
- **After Section 7.26:** ~2980 lines (+158 lines)
- **Total Growth:** +1160 lines from original (64% increase)
- **Sections Added:** 26 total (0.1-7.26)

---

