D∆∞·ªõi ƒë√¢y l√† CH·∫®N ƒêO√ÅN CH√çNH X√ÅC + ACTION POINT (kh√¥ng gi·∫£ng ƒë·∫°o).
M·ªói action ƒë·ªôc l·∫≠p, b·∫°n ch·ªçn l√†m theo th·ª© t·ª±.

üî¥ V·∫§N ƒê·ªÄ C·ªêT L√ïI (Root Causes)
1) ‚ùå B·∫°n ƒëang c√≥ 2 Engine song song cho Story Mission

Rule-based engine: TutorResponseGenerator

AI-driven engine: StoryMissionEngine + NovaPromptBuilder

‚õî C·∫£ hai ƒë·ªÅu:

quy·∫øt ƒë·ªãnh c√¢u h·ªèi ti·∫øp theo

quy·∫øt ƒë·ªãnh hint ng·ªØ c·∫£nh

quy·∫øt ƒë·ªãnh khi n√†o ‚Äúcomplete‚Äù

‚û°Ô∏è Xung ƒë·ªôt logic ‚Üí AI h·ªèi l·∫∑p, hint sai, flow kh√¥ng t·ª± nhi√™n

2) ‚ùå Hint Engine ƒëang d√πng sai ngu·ªìn c√¢u h·ªèi

Trong StoryMissionTab.jsx:

const actualQuestion = response.task || fullResponseText;


Nh∆∞ng:

V·ªõi AI-driven flow, task th∆∞·ªùng = null

‚Üí hint ƒë∆∞·ª£c sinh t·ª´ fullResponseText (ack + filler)

‚Üí Intent detection sai ‚Üí hint sai

3) ‚ùå Mission Spec kh√¥ng ph·∫£i ‚Äúsource of truth‚Äù

storyMissions.js ƒë·ªãnh nghƒ©a:

missionGoals

targetVocabulary

successCriteria

Nh∆∞ng:

Engine kh√¥ng √©p AI theo th·ª© t·ª± goal

Completion logic b·ªã chia ƒë√¥i:

minTurns check

vocabUsed check

mission_goals_achieved (AI t·ª± khai)

‚û°Ô∏è AI kh√¥ng bi·∫øt ‚Äúƒëang l√†m goal n√†o‚Äù

4) ‚ùå AI b·ªã giao qu√° nhi·ªÅu quy·ªÅn

Trong NovaPromptBuilder:

AI v·ª´a:

n√≥i chuy·ªán

extract data

t·ª± ƒë√°nh d·∫•u goal complete

t·ª± ch·ªçn c√¢u h·ªèi ti·∫øp theo

‚û°Ô∏è V·ªõi tr·∫ª A0++, ƒë√¢y l√† over-delegation ‚Üí h·ªôi tho·∫°i kh√¥ng ·ªïn ƒë·ªãnh.

5) ‚ùå Kh√¥ng c√≥ ‚ÄúDeterministic Turn Controller‚Äù

Hi·ªán t·∫°i:

Kh√¥ng c√≥ bi·∫øn ki·ªÉu: currentGoalIndex

Kh√¥ng c√≥ state machine r√µ r√†ng

Turn ti·∫øn tri·ªÉn d·ª±a v√†o:

AI output

text parsing

heuristics

‚û°Ô∏è AI kh√¥ng th·ªÉ nh·∫•t qu√°n qua c√°c l∆∞·ª£t s·ª≠a

üü¢ ACTION PLAN (CH·ªåN L√ÄM THEO TH·ª® T·ª∞)
‚úÖ Action 1 ‚Äî CH·ªåN 1 ENGINE DUY NH·∫§T (QUAN TR·ªåNG NH·∫§T)

Quy·∫øt ƒë·ªãnh b·∫Øt bu·ªôc:

‚ùå Lo·∫°i b·ªè TutorResponseGenerator kh·ªèi Story Mission

‚úÖ Gi·ªØ AI-driven flow (StoryMissionEngine + NovaPromptBuilder)

üìå TutorResponseGenerator ch·ªâ d√πng cho Free Talk

üëâ N·∫øu kh√¥ng l√†m Action 1 ‚Üí m·ªçi fix kh√°c v√¥ nghƒ©a

‚úÖ Action 2 ‚Äî Kh√≥a ‚ÄúTurn Ownership‚Äù v·ªÅ ENGINE (kh√¥ng ph·∫£i AI)

S·ª≠a ki·∫øn tr√∫c nh∆∞ sau:

Engine gi·ªØ:

currentGoalIndex

requiredVocabRemaining

turnCount

AI ch·ªâ ƒë∆∞·ª£c:

ph·∫£n h·ªìi 1‚Äì2 c√¢u

h·ªèi DUY NH·∫§T c√¢u h·ªèi do engine ch·ªâ ƒë·ªãnh

üìå Prompt AI KH√îNG ƒë∆∞·ª£c t·ª± nghƒ© goal ti·∫øp theo

‚úÖ Action 3 ‚Äî Fix Hint Engine (bug hi·ªán t·∫°i)

Thay logic trong StoryMissionTab.jsx:

HI·ªÜN T·∫†I (sai):

const actualQuestion = response.task || fullResponseText;


ƒê√öNG:

Hint ph·∫£i d·ª±a tr√™n:

engine.state.currentGoal

ho·∫∑c mission.missionGoals[currentGoalIndex]

üëâ Hint sinh t·ª´ goal, kh√¥ng t·ª´ text AI.

‚úÖ Action 4 ‚Äî Chu·∫©n ho√° Completion Logic (1 ch·ªó duy nh·∫•t)

Ch·ªçn DUY NH·∫§T:

Completion =
all missionGoals achieved AND required vocab used

‚ùå Kh√¥ng d√πng:

AI t·ª± khai mission_goals_achieved

minTurns nh∆∞ ƒëi·ªÅu ki·ªán ch√≠nh

‚úÖ Action 5 ‚Äî √âp Prompt ‚ÄúLOW AGENCY MODE‚Äù

Trong NovaPromptBuilder, th√™m rule c·ª©ng:

You are NOT allowed to:
- choose the next goal
- decide mission completion
- ask multiple questions

You MUST:
- respond to the given goal only
- ask exactly ONE short question related to that goal


‚û°Ô∏è AI s·∫Ω t·ª± nhi√™n h∆°n v√¨ kh√¥ng b·ªã qu√° t·∫£i vai tr√≤.

‚úÖ Action 6 ‚Äî Vi·∫øt 1 file SPEC ƒë·ªÉ AI & Dev c√πng hi·ªÉu

T·∫°o docs/story_mission_spec.md (‚â§ 120 d√≤ng):

Mission lifecycle

Goal order

Hint source

Completion rules

Forbidden behaviors

üìå File n√†y l√† Single Source of Truth cho m·ªçi agent.

üß† T·∫†I SAO B·∫†N ‚ÄúS·ª¨A C√ÅI N√ÄY H·ªéNG C√ÅI KH√ÅC‚Äù?

V√¨:

B·∫°n ƒëang s·ª≠a tri·ªáu ch·ª©ng UI

Nh∆∞ng b·ªánh n·∫±m ·ªü ownership & flow control

üëâ Khi kh√¥ng c√≥ 1 n∆°i quy·∫øt ƒë·ªãnh duy nh·∫•t, AI s·∫Ω:

ƒëo√°n

l·∫∑p

b·∫ª flow

üß© NEXT STEP (b·∫°n ch·ªçn 1)

üîß M√¨nh ƒë·ªÅ xu·∫•t patch ki·∫øn tr√∫c c·ª• th·ªÉ (file + diff)

üß† Vi·∫øt l·∫°i StoryMissionEngine V5 (deterministic + AI)

üß™ T·∫°o 5 Golden Test Scenarios ƒë·ªÉ kh√¥ng regress n·ªØa

‚úÇÔ∏è R√∫t g·ªçn prompt + engine ƒë·ªÉ AI t·ª± nhi√™n h∆°n cho tr·∫ª em

üëâ Tr·∫£ l·ªùi ch·ªâ c·∫ßn s·ªë (1‚Äì4).

1, 2, 3, 4 t√¥i c·∫ßn 1 artifact th·∫≠t ƒë·∫ßy ƒë·ªß ƒë·ªÉ 1 trong c√°c AI n√†y s·ª≠a (h√£y g·ª£i √Ω AI n√†o ph√π h·ª£p nh·∫•t).
ƒê√£ suy nghƒ© trong 6s

D∆∞·ªõi ƒë√¢y l√† 1 MASTER ARTIFACT ƒë·ªß ‚Äúƒë√≥ng g√≥i‚Äù ƒë·ªÉ m·ªôt AI agent trong VS Code (Claude Code / Cline / Roo / Copilot) v√†o l√†m 1 l·∫ßn ra ƒë√∫ng, g·ªìm: ki·∫øn tr√∫c m·ª•c ti√™u, patch plan theo file, prompt copy-paste, test scenarios, v√† guardrails ch·ªëng l·∫∑p.

AI n√†o ph√π h·ª£p nh·∫•t?

Ch·ªçn: Claude Code (VS Code) / Claude Sonnet
L√Ω do th·ª±c d·ª•ng: b√†i n√†y c·∫ßn refactor c√≥ k·ª∑ lu·∫≠t + gi·ªØ nh·∫•t qu√°n state machine + s·ª≠a prompt + test. Claude l√†m t·ªët nh·∫•t khi b·∫°n ‚Äúpin file + spec + action-only‚Äù.
(Cline/Roo m·∫°nh ·ªü ch·∫°y tool nh∆∞ng hay scan/grep v√† d·ªÖ l·∫°c n·∫øu spec ch∆∞a kh√≥a.)

MASTER ARTIFACT ‚Äî Story Mission V5 (Deterministic + AI Low-Agency)
0) One-liner Goal

Rebuild Story Mission so it is deterministic (engine controls goal/turn/completion) + AI is low-agency (only generates short response + one question for the current goal). Fix hint correctness, stop repeated questions, stop regressions.

1) Rules of Engagement (token-safe, anti-loop)

Agent MUST follow:

Read only these files (pinned list below). No repo scan. No grep.

Output only action points + diffs. No long explanations.

Max 2‚Äì3 files changed per iteration. Commit in small steps.

If anything is unclear: ask one question, then stop.

(Story Tab currently imports StoryMissionEngine and hint engine; do not ‚Äúexplore repo‚Äù beyond pinned list.) 

StoryMissionTab

2) Pinned Files (must read first)

StoryMissionTab.jsx (UI wiring + hint usage) 

StoryMissionTab

storyMissionEngine.js (engine state + AI call + completion) 

storyMissionEngine

novaPromptBuilder.js (prompt design, current high-agency) 

novaPromptBuilder

storyMissions.js (mission data spec + goals + vocab) 

storyMissions

missionSchema.js (mission contract + validateMission) 

missionSchema

tutorSchemas.js (JSON parser) 

tutorSchemas

Optional (only if referenced by pinned files):

AI_TUTOR_MASTER_ARTIFACT.md (product intent) 

AI_TUTOR_MASTER_ARTIFACT

AITutor.jsx (tab routing) 

AITutor

3) Definition of Done (strict)
Functional

Story Mission never repeats the same question for the same goal unless user gives empty/invalid input.

Hints always match the current goal‚Äôs expected student output, not ‚Äúwhatever AI just said‚Äù.

Completion occurs ONLY when:

turnsCompleted >= minTurns AND

all mustUseWords have been used (deterministically detected)
(No reliance on AI self-report of mission_goals_achieved.)

Behavioral (Ms. Nova)

Each AI turn: ‚â§ 2 sentences + 1 short question only.

No multi-question responses.

No grammar lectures.

Engineering

Engine owns: currentGoalIndex, currentGoalId, turnsCompleted, requiredVocabRemaining, studentContext.

AI does NOT choose next goal, does NOT decide completion, does NOT generate multiple questions.

Tests

Add 5 golden scenarios (manual test checklist or lightweight unit tests) that must pass.

4) Core Design (V5 Architecture)
4.1 Deterministic Turn Controller (Engine-owned)

Add to engine state:

currentGoalIndex (starts at 0)

goals = mission.missionGoals (array)

currentGoal = goals[currentGoalIndex]

requiredVocab = mustUseWords from mission successCriteria

requiredVocabRemaining = Set(requiredVocab) minus used words

lastQuestion (string) (for anti-repeat protection)

4.2 AI Low-Agency Contract

AI output JSON schema becomes:

{
  "response_text": "1-2 short sentences, warm",
  "next_question": "ONE short question aligned to the CURRENT goal only",
  "student_context_update": { "name": "...", "age": "...", "class": "..." },
  "vocabulary_used": ["teacher", "school"]
}


Remove / ignore mission_goals_achieved (do not use it for state progression).
(Current parser already supports story JSON; update it minimally to accept next_question too.) 

tutorSchemas

4.3 Goal Progression (deterministic)

Engine determines goal completion based on:

student_context_update contains required field for the current goal OR

a simple deterministic check (e.g., ‚Äúage‚Äù present for ‚ÄúGet the student's age‚Äù)

Then engine increments currentGoalIndex if goal is satisfied and not at end.

4.4 Hint Source of Truth

Hints should be generated from:

mission.openingBeat.hints for first turn

otherwise: a goal-to-hints mapping derived from mission.missionGoals[currentGoalIndex]
NOT from AI response text.

(Your current UI tries to extract ‚Äúactual question‚Äù from response text; that‚Äôs unreliable because AI-driven engine returns task null and story_beat as response.)

5) Patch Plan by File (exact actions)
A) storyMissionEngine.js ‚Äî implement V5 state machine

Current engine increments turns and ends by minTurns, and checks vocab used; AI decides a lot. 

storyMissionEngine

Do:

Add currentGoalIndex, lastQuestion, goals, requiredVocabRemaining.

start() should:

set currentGoalIndex = 0

set lastQuestion = openingBeat.aiPrompt

return { story_beat: sceneContext, task: openingBeat.aiPrompt, ... } (keep existing behavior)

generateTurn(userInput) should:

update turns and conversationHistory

call AI with prompt that includes: currentGoal, requiredVocabRemaining, hard rules

parse JSON: response_text, next_question, student_context_update, vocabulary_used

deterministic update:

update studentContext and memory

mark vocab used (normalize + lowercase)

update requiredVocabRemaining

evaluate current goal completion:

if current goal is about name/age/class: check those fields in studentContext

else: keep it simple (goal complete when at least one new context field OR after N turns on same goal)

anti-repeat:

if next_question equals lastQuestion ‚Üí replace with fallback question for same goal

set lastQuestion = next_question

return combined response:

story_beat = response_text

task = next_question ‚Üê IMPORTANT so UI can do hints correctly if needed.

Completion:

isComplete() uses ONLY:

turnsCompleted >= minTurns AND required vocab all used.

do NOT use AI self-reported goals.

Fallbacks:

If AI JSON parse fails, return deterministic safe response + deterministic question for current goal.

B) novaPromptBuilder.js ‚Äî rewrite to Low-Agency + goal-pinned

Current prompt asks AI to analyze/extract/converse and decide achieved goals, and ‚Äúdo not be repetitive‚Äù but still high agency. 

novaPromptBuilder

Replace prompt contract:

Input includes:

Current Goal: <string>

Required vocab remaining: <list>

Hard rules: 2 sentences max + one question

Output JSON must include next_question (one question only).

Remove ‚Äúmission_goals_achieved‚Äù entirely from instructions.

Add strict formatting:

‚ÄúJSON only‚Äù

‚ÄúNo markdown‚Äù

‚Äúnext_question must end with ?‚Äù

‚Äúresponse_text must NOT contain multiple questions‚Äù

C) tutorSchemas.js ‚Äî extend parser to accept next_question

Current parser returns {response_text, student_context_update, vocabulary_used, mission_goals_achieved}. 

tutorSchemas

Do minimal change:

Add next_question: parsed.next_question || ""

Keep backward compat (if missing, set to empty; engine will fallback deterministically)

D) StoryMissionTab.jsx ‚Äî hints and rendering fix

Current UI:

On start: uses opening.task and passes to getHints with beatWithTask.aiPrompt; ok. 

StoryMissionTab

On submit: tries to derive actualQuestion from response.task || fullResponseText; but engine returns task:null and story_beat contains response ‚Üí hint uses wrong string.

Do:

Expect engine V5 returns { story_beat, task } where task is the question.

Change hint call to use response.task only:

const actualQuestion = response.task;

if empty, fallback: use deterministic goal-based question (engine should avoid empty).

Optional: add ‚Äúgoal label‚Äù display for debugging (dev-only) behind a flag.

E) storyMissions.js / missionSchema.js ‚Äî normalize mission goals

Your missions already contain missionGoals and openingBeat.hints and required vocab.

Do (optional but recommended):

Add a goalHints map per mission (or globally per week):

key: goal string

value: hint chips array
This makes hints deterministic and cheap.

6) Golden Scenarios (manual test checklist)

Create docs/tests/story_mission_golden.md (or run manually). Must pass all.

W1_FIRST_DAY start

Start mission ‚Üí AI greeting shown + hints are ["My","name","is","Minh"] from openingBeat.

Name captured

Student: ‚ÄúMy name is Bao‚Äù

Next AI response uses name in encouragement; next_question is about age (not name again)

Hint chips align to age question.

No repeats

Provide valid age ‚ÄúI am 8‚Äù

Next question moves to next goal (class or teacher, depending on goals order), not ‚ÄúHow old are you?‚Äù again.

Vocab tracking

Student uses ‚Äúteacher‚Äù and ‚Äúschool‚Äù across turns

Completion only occurs after:

turns >= minTurns AND

all mustUseWords were used.

Bad JSON fallback

Simulate parse failure (force AI returns non-json)

Engine returns deterministic safe response + deterministic next_question for current goal, without crashing.

7) Agent Prompt (copy-paste into Claude Code / Cline / Roo)

Use this EXACT prompt in VS Code agent:

MODE: ACTION-ONLY. No explanations.

Goal: Implement Story Mission V5 (deterministic engine + low-agency AI) per MASTER ARTIFACT below.
Constraints:
- Do NOT scan repo. Do NOT grep. Only use pinned files.
- Minimal diffs. 2-3 files per iteration.
- Keep UI behavior stable.

Pinned files:
- StoryMissionTab.jsx
- storyMissionEngine.js
- novaPromptBuilder.js
- tutorSchemas.js
- storyMissions.js
- missionSchema.js

Deliverables (in order):
1) Patch storyMissionEngine.js to own currentGoalIndex + return task=next_question.
2) Patch novaPromptBuilder.js to output JSON with next_question and remove goal self-report.
3) Patch tutorSchemas.js parser to include next_question.
4) Patch StoryMissionTab.jsx to use response.task for hints (no fullResponseText fallback).
5) Add docs/tests/story_mission_golden.md with 5 scenarios.

Output format:
- List changed files
- Provide unified diffs only
- STOP

8) ‚ÄúStop being verbose‚Äù hard clamp

Add this line at the top of each agent message if needed:

If you output more than 12 bullets or any paragraph > 2 lines, you failed.

9) First Iteration Scope (recommended)

Iteration 1: Engine + Prompt + Parser (3 files)

storyMissionEngine.js

novaPromptBuilder.js

tutorSchemas.js

Iteration 2: UI hints fix + Golden tests (2 files)

StoryMissionTab.jsx

docs/tests/story_mission_golden.md

10) Notes about your current code (why this works)

Your current engine returns task: null for AI turns, so UI hint extraction is forced to guess from fullResponseText which includes non-question text. Fixing engine to return task = next_question makes the UI deterministic.

Your mission data already contains missionGoals and vocab requirements; engine just needs to own the progression. 

storyMissions

Parser already strips markdown fences and falls back safely; we only extend it minimally.